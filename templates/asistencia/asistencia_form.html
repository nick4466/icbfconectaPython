{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ICBF Conecta - Llamado de Asistencia</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>


  <style>
/* ============================================================
   ESTILOS PRINCIPALES DASHBOARD — ICBF CONECTA
   Unificación total de estilos — Azul corporativo
   ============================================================ */

/* ------------ BASE ------------ */
* { box-sizing: border-box; }
body {
  margin:0;
  font-family:'Poppins',sans-serif;
  background:#f3f6fa;
  color:#222;
}

/* ------------ HEADER ------------ */
.mc-header {
  width: 100%;
  background: white;
  padding: 14px 28px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 3px 14px rgba(0, 0, 0, 0.29);
  
  position: sticky;
  top: 0;
  z-index: 999;
}


/* IZQUIERDA: logo + título */
.mc-header-left {
  display: flex;
  align-items: center;
  gap: 14px;
}


.mc-header-left { display:flex; align-items:center; gap:12px; }
.mc-logo {
  height: 48px;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
}

.mc-title {
  font-size: 22px;
  font-weight: 700;
  color: #004080;
  letter-spacing: 0.5px;
  margin: 0;
}


/* NAV CENTRAL */
.mc-header-nav ul {
  display: flex;
  gap: 18px;
  list-style: none;
}

.mc-header-nav a {
  text-decoration: none;
  font-weight: 600;
  font-size: 15px;
  color: #004080;
  background: #e8f1ff;
  padding: 9px 16px;
  border-radius: 10px;
  transition: all 0.25s ease;
  border: 1px solid rgba(0,0,0,0.05);
}

.mc-header-nav a i {
  margin-right: 6px;
}

.mc-header-nav a:hover { color:#2b28ca; }

.mc-header-right { display:flex; align-items:center; gap:18px; }

/* ------------ NOTIFICACIONES ------------ */
.notif-container { position:relative; }

.notif-btn {
  background:none;
  border:none;
  cursor:pointer;
  font-size:24px;
  color:#006bff;
  padding:6px;
  transition:.2s;
}
.notif-btn:hover { color:#0047b3; }

.notif-count {
  position:absolute;
  top:-6px; right:-6px;
  background:#ff3b3b;
  color:#fff;
  font-size:11px;
  padding:2px 6px;
  border-radius:50px;
  font-weight:700;
}

.notif-panel {
  position:absolute;
  right:0;
  top:44px;
  width:340px;
  background:white;
  border-radius:16px;
  box-shadow:0 10px 28px rgba(0,0,0,0.12);
  display:none;
  animation:fadeIn .18s ease-out forwards;
}
.notif-panel.visible { display:block; }

@keyframes fadeIn {
  from { opacity:0; transform:translateY(-8px); }
  to   { opacity:1; transform:none; }
}

.notif-header {
  padding:12px 18px;
  display:flex;
  justify-content:space-between;
  font-weight:600;
  border-bottom:1px solid #e6efff;
}

.notif-item {
  padding:12px 16px;
  margin:8px;
  background:#eaf1ff;
  border-radius:12px;
}
.notif-item.unread {
  background:#d6e6ff;
  border-left:4px solid #006bff;
}

/* ------------ LOGOUT ------------ */
.logout-btn {
  background:linear-gradient(90deg,#003d80,#006bff);
  color:white;
  border:none;
  padding:10px 16px;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
  transition:.25s;
}
.logout-btn:hover { opacity:.85; transform:translateY(-2px); }

/* ------------ TÍTULOS Y CARDS ------------ */
.main-title {
  margin:25px auto;
  width:85%;
  padding:20px;
  text-align:center;
  background:white;
  border-radius:20px;
  color:#0050c8;
  font-size:28px;
  font-weight:700;
  box-shadow:0 6px 14px rgba(0,0,0,0.06);
}

.card {
  background:white;
  padding:28px;
  width:85%;
  margin:0 auto 40px;
  border-radius:20px;
  box-shadow:0 8px 20px rgba(0,0,0,0.07);
}

/* ------------ TABLA ------------ */
table {
  width:100%;
  margin-top:25px;
  border-collapse:separate;
  border-spacing:0 12px;
}

th {
  background:linear-gradient(90deg,#0056b3,#007bff);
  color:white;
  padding:14px;
  border-radius:12px;
  font-weight:600;
}

td {
  background:#e8f1ff;
  padding:14px;
  text-align:center;
  border-radius:12px;
  font-weight:500;
}

/* ------------ RADIO BUTTONS ------------ */
.radio-group label {
  padding:8px 14px;
  border-radius:10px;
  background:#dfeaff;
  border:2px solid #8bb6ff;
  cursor:pointer;
  font-weight:600;
  color:#003366;
  transition:.25s;
}

input[type="radio"]:checked + label {
  background:linear-gradient(90deg,#004a99,#007bff);
  color:white;
  border-color:#0056b3;
}

/* ------------ MODAL ------------ */
.modal {
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.45);
  z-index:9998;
}

.modal.active { display:flex; }

.modal-content {
  background:white;
  width:92%;
  max-width:600px;
  border-radius:18px;
  padding:30px;
  box-shadow:0 12px 32px rgba(0,0,0,0.2);
  position:relative;
}

.modal-close {
  position:absolute;
  right:22px;
  top:18px;
  font-size:24px;
  background:none;
  border:none;
  color:#006eff;
  cursor:pointer;
}

/* ------------ FORM ------------ */
.modal-grid { display:grid; gap:16px; }

.form-group label {
  font-weight:600;
  color:#003366;
}

.form-group select,
.form-group textarea,
.form-group input[type="file"] {
  width:100%;
  padding:11px 13px;
  border-radius:10px;
  border:2px solid #8bb6ff;
  background:#eef4ff;
  font-weight:500;
}

/* ============================================================
   BOTONES PRINCIPALES — ESTILO UNIFICADO CORPORATIVO
   ============================================================ */

.btn {
  padding:10px 18px;
  border-radius:10px;
  font-size:15px;
  font-weight:600;
  border:none;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:8px;
  color:white;
  background:linear-gradient(90deg,#003d80,#007bff);
  box-shadow:0 4px 12px rgba(0,0,0,0.12);
  transition:.25s;
}

.btn:hover {
  transform:translateY(-2px);
  opacity:.92;
}

.btn:disabled { opacity:.55; cursor:not-allowed; transform:none; }

/* Variantes mínimas */
.btn-small {
  padding:6px 12px;
  font-size:13px;
  border-radius:8px;

}
/* Botón pequeño para ver historial desde la tabla */
.btn-mini-historial {
  padding: 8px 12px;
  border-radius: 8px;
  background: linear-gradient(135deg, #764ba2, #5a3583);
  color: white;
  font-weight: 700;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  border: none;
  transition: transform 0.15s ease, box-shadow 0.15s ease;
  box-shadow: 0 4px 10px rgba(0,0,0,0.12);
}

.btn-mini-historial i { font-size: 14px; }

.btn-mini-historial:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(0,0,0,0.16);
  text-decoration: none;
}
/* -------- Botones "Todos presentes / Todos ausentes" -------- */

.btn-presente, .btn-ausente {
  padding: 10px 18px;
  font-size: 15px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  transition: 0.25s ease-in-out;
  color: white;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}

/* Botón verde */
.btn-presente {
  background: linear-gradient(135deg, #1f8c4b, #27ae60);
}

.btn-presente:hover {
  background: linear-gradient(135deg, #18723d, #1e964f);
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.18);
}

/* Botón rojo */
.btn-ausente {
  background: linear-gradient(135deg, #b13228, #e74c3c);
}

.btn-ausente:hover {
  background: linear-gradient(135deg, #92271f, #c44135);
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.18);
}

/* Pequeño efecto al presionar */
.btn-presente:active, .btn-ausente:active {
  transform: scale(0.97);
}

/* -------- Botón Guardar Registro -------- */

.btn-guardar {
  padding: 12px 22px;
  background: linear-gradient(135deg, #4c1caf, #7a3eb1); /* Morado profesional */
  border: none;
  color: white;
  font-size: 16px;
  font-weight: bold;
  border-radius: 10px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 10px;
  transition: 0.25s ease-in-out;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}

.btn-guardar i {
  font-size: 18px; 
}

.btn-guardar:hover {
  background: linear-gradient(135deg, #3a1485, #6a33a1);
  transform: translateY(-2px);
  box-shadow: 0 6px 14px rgba(0,0,0,0.22);
}

.btn-guardar:active {
  transform: scale(0.97);
}



/* Fin del CSS */
</style>
  <style>
  /* Estilos para selector de rango de fechas más elegante */
  .date-range-container {
    width:85%;
    margin: 0 auto 18px;
    display:flex;
    gap:12px;
    align-items:center;
    background: linear-gradient(180deg, #ffffff, #fbfdff);
    padding:12px;
    border-radius:12px;
    box-shadow: 0 6px 18px rgba(12,36,80,0.06);
    border: 1px solid rgba(0,70,160,0.06);
  }

  .date-box {
    display:flex;
    flex-direction:column;
    gap:6px;
    min-width:180px;
  }

  .date-box label { font-weight:700; color:#06366a; font-size:13px; }

  .date-box .date-input {
    display:flex;
    align-items:center;
    gap:8px;
    background:#eef6ff;
    padding:8px 10px;
    border-radius:10px;
    border:1px solid rgba(3,78,162,0.08);
  }

  .date-box input[type="date"] {
    border: none;
    background: transparent;
    padding:6px 4px;
    font-weight:600;
    color:#003366;
  }

  .date-sep {
    display:flex;
    align-items:center;
    gap:8px;
    color:#6b7c93;
    font-weight:700;
    padding:6px 8px;
    border-radius:8px;
    background:transparent;
    font-size:14px;
  }

  .date-note { color:#425065; font-size:13px; margin-left:auto; }

  @media (max-width:880px) {
    .date-range-container { width:100%; flex-direction:column; align-items:stretch; }
    .date-note { margin-left:0; }
  }
  </style>
  <style>
  /* Compacto cuando no se usa rango */
  .date-compact {
    width:85%;
    margin: 0 auto 18px;
    display:flex;
    gap:12px;
    align-items:center;
    justify-content:flex-start;
  }

  .range-toggle {
    margin-left: auto;
    background: transparent;
    border: 1px solid rgba(6,84,166,0.12);
    color: #0654a6;
    padding:8px 12px;
    border-radius:8px;
    cursor:pointer;
    font-weight:700;
  }

  .range-toggle:focus { outline: none; box-shadow: 0 6px 18px rgba(6,84,166,0.08); }
  </style>
  <style>
  /* Modal mejorado */
  .modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(10,22,45,0.45); z-index: 9998; }
  .modal.active { display:flex; }
  .modal-content { width:92%; max-width:680px; border-radius:14px; overflow:hidden; box-shadow: 0 20px 50px rgba(2,6,23,0.5); background: linear-gradient(180deg,#ffffff,#fbfdff); }
  .modal-header { display:flex; align-items:center; justify-content:space-between; padding:18px 20px; background: linear-gradient(90deg,#0654a6,#0877cc); color:white; }
  .modal-header h2 { margin:0; font-size:18px; font-weight:800; letter-spacing:0.2px; }
  .modal-close { background:rgba(255,255,255,0.12); border:none; color:white; font-size:20px; width:40px; height:40px; border-radius:10px; cursor:pointer; }
  .modal-body { padding:20px; display:grid; gap:12px; grid-template-columns:1fr; }
  .modal-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:12px; }
  .form-group label { font-weight:700; color:#06366a; margin-bottom:6px; display:block; }
  .form-group select, .form-group textarea, .form-group input[type="file"], .form-group input[type="text"] { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #d7e7fb; background:#f7fbff; }
  .modal-footer { display:flex; gap:10px; justify-content:flex-end; padding:16px 20px; background:#fbfdff; }
  .btn-just { background: linear-gradient(90deg,#17a2b8,#20c997); color:white; padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:700; }
  .btn-sin-justificar { background: transparent; color:#6b7c93; border:1px solid #e6efff; padding:10px 14px; border-radius:10px; cursor:pointer; }
  .file-input-custom { display:flex; gap:10px; align-items:center; padding:10px; border-radius:8px; background:#eef6ff; border:1px dashed #cfe6ff; }
  .file-input-custom input[type=file] { border:none; background:transparent; }
  @media (max-width:520px) { .modal-content { max-width: 94%; } .modal-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  {% include 'madre/navbar_madre.html' %}

  

  <!-- ========== PAGE TITLE + CARD ========== -->
  <div class="main-title">ICBF - CONECTA | Llamado a Asistencia</div>

  <div class="card">
    {% if mensaje %}
      <div style="background:linear-gradient(135deg,#d4edda,#c3e6cb);border:1px solid #b1dfbb;padding:14px 16px;border-radius:10px;margin-bottom:16px;color:#155724;font-weight:600;display:flex;align-items:center;gap:10px;box-shadow:0 2px 8px rgba(25,135,84,0.1);">
        <i class="fas fa-check-circle" style="font-size:18px;color:#28a745;"></i>
        <span>{{ mensaje }}</span>
      </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" id="asistencia-form">
      {% csrf_token %}
      <!-- VISTA COMPACTA (por defecto) -->
      <div class="date-compact" id="date-compact">
        <div class="date-box">
          <label for="fecha">Fecha</label>
          <div class="date-input">
            <i class="fas fa-calendar-alt" style="color:#0654a6"></i>
            <input type="date" id="fecha" name="fecha" value="{{ fecha_hoy }}" required aria-label="Fecha inicio">
          </div>
        </div>
        <button type="button" class="range-toggle" id="show-range">Usar rango</button>
      </div>

      <!-- VISTA RANGO (oculta por defecto) -->
      <div class="date-range-container" id="date-range" style="display:none;">
        <div class="date-box">
          <label for="fecha">Fecha inicio</label>
          <div class="date-input">
            <i class="fas fa-calendar-alt" style="color:#0654a6"></i>
            <!-- ✅ SIN name="fecha" - se copia a #fecha en JS antes de enviar -->
            <input type="date" id="fecha-range-start" value="{{ fecha_hoy }}" required aria-label="Fecha inicio rango">
          </div>
        </div>

        <div class="date-box">
          <label for="end_date">Fecha fin <span style="font-weight:600;color:#6b7c93;font-size:12px;">(opcional)</span></label>
          <div class="date-input">
            <i class="fas fa-calendar-day" style="color:#0654a6"></i>
            <input type="date" id="end_date" name="end_date" value="{{ end_date|default:'' }}" aria-label="Fecha fin">
          </div>
        </div>

        <div class="date-sep">—</div>

        <div class="date-note">
          <strong>Nota:</strong> Si seleccionas una <em>Fecha fin</em>, la misma asistencia se aplicará a todo el rango.
        </div>

        <button type="button" class="range-toggle" id="hide-range">Cerrar rango</button>
      </div>
<div style="margin-bottom:10px; text-align:center;">
  <button type="button" id="select-all" class="btn-presente">
    <i class="fas fa-check-circle"></i> Todos presentes
  </button>

  <button type="button" id="select-all-ausentes" class="btn-ausente">
    <i class="fas fa-times-circle"></i> Todos ausentes
  </button>
</div>


      <table>
        <thead>
          <tr><th>#</th><th>Nombre Completo</th><th>Asistencia</th><th>Historial</th></tr>
        </thead>
        <tbody>
          {% for nino in ninos %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ nino.nombres }} {{ nino.apellidos }}</td>
              <td>
                <div class="radio-group">
                  <input type="radio" id="presente-{{ nino.id }}" name="nino_{{ nino.id }}" value="Presente">
                  <label for="presente-{{ nino.id }}" class="presente">Presente</label>

                  <input type="radio" id="ausente-{{ nino.id }}" name="nino_{{ nino.id }}" value="Ausente" data-id="{{ nino.id }}">
                  <label for="ausente-{{ nino.id }}" class="ausente">Ausente</label>

                  <input type="radio" id="justificado-{{ nino.id }}" name="nino_{{ nino.id }}" value="Justificado" disabled>
                  <label for="justificado-{{ nino.id }}" class="justificado">Justificado</label>
                </div>
              </td>
              <td><a href="{% url 'historial_asistencia' nino.id %}" class="btn-mini-historial"><i class="fas fa-history"></i> Ver</a></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <div style="margin-top:20px;">
        <button type="submit" class="btn-guardar">
          <i class="fas fa-save"></i> Guardar Registro
        </button>
        <a href="{% url 'asistencia_estadisticas' %}" style="margin-left:10px;" class="btn" style="padding:12px 22px;background:linear-gradient(135deg,#17a2b8,#20c997);color:white;text-decoration:none;border-radius:10px;font-weight:bold;display:inline-flex;align-items:center;gap:10px;transition:0.25s;">
          <i class="fas fa-chart-bar"></i> Ver Estadísticas
        </a>
      </div>
    </form>
  </div>

  <!-- ===== MODAL JUSTIFICAR ===== -->
  <div id="modal-justificar" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-file-medical-alt" style="margin-right:8px;color:rgba(255,255,255,0.9)"></i> Justificar Ausencia</h2>
        <button class="modal-close" id="modal-close">&times;</button>
      </div>

      <div class="modal-body">
        <form id="form-justificacion" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" name="nino_id" id="modal-nino-id">
          <input type="hidden" name="fecha" id="modal-fecha">

          <div class="modal-grid">
            <div class="form-group">
              <label for="tipo">Tipo de falta</label>
              <select id="tipo" name="tipo" required>
                <option value="">Selecciona</option>
                <option value="Médica">Médica</option>
                <option value="Familiar">Familiar</option>
                <option value="Transporte">Transporte</option>
                <option value="Otra">Otra</option>
              </select>
            </div>

            <div class="form-group">
              <label for="descripcion">Descripción</label>
              <textarea id="descripcion" name="descripcion" rows="3" required></textarea>
            </div>

            <div class="form-group">
              <label for="observaciones">Observaciones (opcional)</label>
              <textarea id="observaciones" name="observaciones" rows="2"></textarea>
            </div>

            <div class="form-group">
              <label for="archivo_pdf">Adjuntar soporte (PDF)</label>
              <div class="file-input-custom">
                <i class="fas fa-file-pdf" style="color:#dc3545;font-size:18px"></i>
                <input id="archivo_pdf" type="file" name="archivo_pdf" accept="application/pdf">
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" id="sinJustificarBtn" class="btn-sin-justificar">Sin justificar</button>
            <button type="button" id="guardarJustificacionBtn" class="btn-just">Guardar Justificación</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ========== SCRIPTS UNIFICADOS ========== -->
  <script>
    /* ---------- CSRF (desde cookie) ---------- */
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i=0;i<cookies.length;i++){
          const c = cookies[i].trim();
          if (c.substring(0, name.length+1) === (name + '=')) {
            cookieValue = decodeURIComponent(c.substring(name.length+1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    /* ---------- FUNCIONES UI ---------- */
    function confirmarLogout(){ return confirm('¿Seguro que quieres cerrar sesión?'); }

    document.addEventListener('DOMContentLoaded', () => {
      const notifToggle = document.getElementById('notifToggle');
      const notifPanel  = document.getElementById('notifPanel');
      const notifCount  = document.getElementById('notifCount');
      const markAllRead = document.getElementById('markAllRead');

      const modal = document.getElementById('modal-justificar');
      const modalNinoInput = document.getElementById('modal-nino-id');
      const modalFechaInput = document.getElementById('modal-fecha');
      const guardarBtn = document.getElementById('guardarJustificacionBtn');
      const sinJustBtn = document.getElementById('sinJustificarBtn');
      const modalClose = document.getElementById('modal-close');

      // ✅ DEFINIR VARIABLES DE FECHA AL INICIO
      const fecha = document.getElementById('fecha');
      const fechaRangeStart = document.getElementById('fecha-range-start');
      const endDate = document.getElementById('end_date');
      const showBtn = document.getElementById('show-range');
      const hideBtn = document.getElementById('hide-range');
      const compact = document.getElementById('date-compact');
      const range = document.getElementById('date-range');

      /* Toggle notificaciones */
      if (notifToggle && notifPanel) {
        notifToggle.addEventListener('click', (e) => {
          e.stopPropagation();
          notifPanel.classList.toggle('visible');
        });

        document.addEventListener('click', (e) => {
          if (!notifPanel.contains(e.target) && !notifToggle.contains(e.target)) {
            notifPanel.classList.remove('visible');
          }
        });
      }

      /* Marcar todo como leído (AJAX POST) - DESHABILITADO */
      {% comment %}
      if (markAllRead) {
        markAllRead.addEventListener('click', async () => {
          try {
            const resp = await fetch("{% url 'marcar_todo_leido' %}", {
              method: "POST",
              headers: { "X-CSRFToken": csrftoken },
              body: JSON.stringify({})
            });
            const data = await resp.json();
            if (data.success) {
              document.querySelectorAll('.notif-item.unread').forEach(el => el.classList.remove('unread'));
              if (notifCount) notifCount.textContent = '0';
            }
          } catch (err) {
            console.error('Error marcar todo leído:', err);
          }
        });
      }
      {% endcomment %}

      /* Select all presente/ausente */
      const selectAllPresente = document.getElementById('select-all');
      const selectAllAusentes = document.getElementById('select-all-ausentes');
      if (selectAllPresente) {
        selectAllPresente.addEventListener('click', () => {
          document.querySelectorAll("input[type='radio'][value='Presente']:not(:disabled)").forEach(r => r.checked = true);
        });
      }
      if (selectAllAusentes) {
        selectAllAusentes.addEventListener('click', () => {
          document.querySelectorAll("input[type='radio'][value='Ausente']:not(:disabled)").forEach(r => r.checked = true);
        });
      }

      // Validación cliente: si hay fecha fin, verificar que no sea anterior a la fecha inicio
      const asistenciaForm = document.getElementById('asistencia-form');
      if (asistenciaForm) {
        asistenciaForm.addEventListener('submit', (ev) => {
          // ✅ CRÍTICO: SIEMPRE sincronizar fecha antes de enviar
          // Si el rango está visible, copiar la fecha-range-start al input #fecha que se envía
          if (range && range.style.display !== 'none') {
            if (fecha && fechaRangeStart && fechaRangeStart.value) {
              fecha.value = fechaRangeStart.value;
            }
          }

          // DEBUG: Ver qué se está enviando
          console.log("=== DEBUG SUBMIT FORM ===");
          console.log("Range visible?", range && range.style.display !== 'none');
          console.log("Input #fecha value (name='fecha'):", fecha ? fecha.value : 'NO EXISTE');
          console.log("Input #fecha-range-start value:", fechaRangeStart ? fechaRangeStart.value : 'NO EXISTE');
          console.log("Input #end_date value (name='end_date'):", endDate ? endDate.value : 'NO EXISTE');
          console.log("========================");

          // Validación: si hay fecha fin, verificar que no sea anterior a la fecha inicio
          const inicio = fecha ? fecha.value : '';
          const fin = endDate ? endDate.value : '';
          if (inicio && fin && fin < inicio) {
            ev.preventDefault();
            alert('La fecha fin debe ser mayor o igual a la fecha inicio.');
            return false;
          }
          return true;
        });
      }

      // Toggle mostrar/ocultar rango
      function openRange() {
        compact.style.display = 'none';
        range.style.display = 'flex';
        // keep start-date synced
        if (fecha && fechaRangeStart) {
          fechaRangeStart.value = fecha.value || '{{ fecha_hoy }}';
        }
      }

      function closeRange() {
        range.style.display = 'none';
        compact.style.display = 'flex';
        // ✅ CRÍTICO: Copiar fecha de rango al input fecha (para que se envíe al servidor)
        if (fecha && fechaRangeStart) {
          fecha.value = fechaRangeStart.value || fecha.value;
        }
        // limpiar end_date
        if (endDate) endDate.value = '';
      }

      showBtn && showBtn.addEventListener('click', openRange);
      hideBtn && hideBtn.addEventListener('click', closeRange);

      // ✅ CRÍTICO: Sincronizar cuando se cambia la fecha de rango inicio
      if (fechaRangeStart) {
        fechaRangeStart.addEventListener('change', () => {
          // Actualizar el input #fecha con el valor del rango
          if (fecha) fecha.value = fechaRangeStart.value;
        });
      }

      // Inicializar estado según si existe end_date en contexto
      if (endDate && endDate.value) {
        openRange();
      } else {
        closeRange();
      }

      /* Cuando se marca "Ausente" abrimos modal y cargamos nino+fecha */
      document.querySelectorAll("input[type='radio'][value='Ausente']").forEach(radio => {
        radio.addEventListener('change', (e) => {
          if (e.target.checked) {
            // ✅ IMPORTANTE: Obtener la fecha correcta (del rango o de la normal)
            let fechaValue = '';
            if (range && range.style.display !== 'none') {
              // Si está en modo rango, usar fecha-range-start
              fechaValue = fechaRangeStart ? fechaRangeStart.value : '';
            } else {
              // Si está en modo normal, usar fecha
              fechaValue = fecha ? fecha.value : '';
            }

            if (!fechaValue) { 
              alert('Selecciona la fecha antes de justificar.'); 
              e.target.checked = false; 
              return; 
            }
            const ninoId = e.target.getAttribute('data-id');
            modalNinoInput.value = ninoId;
            modalFechaInput.value = fechaValue;
            modal.classList.add('active');
            modal.setAttribute('aria-hidden','false');
          }
        });
      });

      /* Cerrar modal */
      modalClose && modalClose.addEventListener('click', () => {
        modal.classList.remove('active'); modal.setAttribute('aria-hidden','true');
      });
      window.addEventListener('click', (ev) => {
        if (ev.target === modal) { modal.classList.remove('active'); modal.setAttribute('aria-hidden','true'); }
      });

      /* Guardar justificacion con FormData para aceptar PDF */
      if (guardarBtn) {
        guardarBtn.addEventListener('click', async () => {
          const form = document.getElementById('form-justificacion');
          const fd = new FormData(form);

          // Validaciones básicas
          if (!fd.get('tipo') || !fd.get('descripcion')) {
            alert('Completa tipo y descripción.');
            return;
          }

          try {
            const resp = await fetch("{% url 'crear_novedad_desde_asistencia' %}", {
              method: 'POST',
              headers: { 'X-CSRFToken': csrftoken },
              body: fd
            });
            const data = await resp.json();
            if (data.success) {
              // marcar radio Justificado en UI, deshabilitar radios del niño
              const nId = fd.get('nino_id');
              const justRadio = document.getElementById(`justificado-${nId}`);
              if (justRadio) { justRadio.checked = true; }
              document.getElementsByName(`nino_${nId}`).forEach(r => r.disabled = true);

              alert('Justificación guardada ✅');
              modal.classList.remove('active'); modal.setAttribute('aria-hidden','true');
            } else {
              alert('Error al guardar la justificación. Revisa la consola.');
            }
          } catch (err) {
            console.error('Error AJAX guardarJustificacion:', err);
            alert('Error de red al guardar la justificación.');
          }
        });
      }

      /* Sin justificar: cerrar modal y dejar Ausente marcado */
      if (sinJustBtn) {
        sinJustBtn.addEventListener('click', () => {
          modal.classList.remove('active'); modal.setAttribute('aria-hidden','true');
        });
      }
    }); // DOMContentLoaded
  </script>

</body>
</html>
