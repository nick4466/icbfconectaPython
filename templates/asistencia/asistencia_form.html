{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ICBF Conecta - Llamado de Asistencia</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>

  <style>
    /* ---------- BASE ---------- */
    * { box-sizing: border-box; }
    body { margin:0; font-family:'Roboto',sans-serif; background:#f3f3f3; color:#222; }

    /* ---------- HEADER ---------- */
    .mc-header { width:100%; padding:12px 25px; background:#fff; display:flex; align-items:center; justify-content:space-between; border-bottom:3px solid #7d2ae8; z-index:100; position:sticky; top:0; }
    .mc-header-left { display:flex; align-items:center; gap:10px; }
    .mc-logo { height:45px; }
    .mc-title { font-size:20px; font-weight:700; color:#333; margin:0; }
    .mc-header-nav ul { display:flex; gap:20px; list-style:none; margin:0; padding:0; }
    .mc-header-nav a { text-decoration:none; color:#444; font-weight:600; }
    .mc-header-nav a:hover { color:#7d2ae8; }
    .mc-header-right { display:flex; align-items:center; gap:16px; }

    /* ---------- NOTIFICACIONES ---------- */
    .notif-container { position:relative; }
    .notif-btn { background:none; border:none; cursor:pointer; font-size:22px; color:#7d2ae8; position:relative; padding:6px; }
    .notif-count { position:absolute; top:-6px; right:-6px; background:#e63946; color:white; font-size:11px; padding:2px 6px; border-radius:50px; font-weight:700; }
    .notif-panel { position:absolute; right:0; top:44px; width:340px; background:white; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.12); padding:10px 0; display:none; z-index:9999; }
    .notif-panel.visible { display:block; animation:fadeIn .18s ease-out; }
    @keyframes fadeIn { from {opacity:0; transform:translateY(-6px)} to {opacity:1; transform:none} }
    .notif-header { padding:10px 15px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #eee; }
    .notif-list { max-height:300px; overflow:auto; padding:8px 6px; }
    .notif-item { padding:10px 12px; margin:6px; border-radius:8px; background:#fafafa; border-left:4px solid transparent; }
    .notif-item.unread { background:#f3e8ff; border-left-color:#7d2ae8; }
    .notif-footer { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:6px; }
    .notif-dot { width:9px; height:9px; border-radius:50%; background:#e63946; display:inline-block; }

    /* ---------- LOGOUT ---------- */
    .logout-btn { background:#e63946; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
    .logout-btn:hover { background:#c72a38; }

    /* ---------- PAGE LAYOUT (cards/table/modal) ---------- */
    .main-title { margin:25px auto; width:85%; padding:18px; text-align:center; background:#fff; border-radius:18px; color:#7a3eb1; font-size:28px; font-weight:700;}
    .card { background:#fff; padding:25px; width:85%; margin:0 auto 40px; border-radius:18px; box-shadow:0 6px 14px rgba(0,0,0,.08); }
    table { width:100%; margin-top:25px; border-collapse:separate; border-spacing:0 10px; }
    th { background:#e7c9ff; color:#5e3370; padding:14px; border-radius:10px; text-align:center; }
    td { background:#faf5ff; padding:14px; font-size:15px; text-align:center; }
    .radio-group { display:flex; justify-content:center; gap:10px; }
    .radio-group input[type="radio"] { display:none; }
    .radio-group label { padding:7px 14px; border-radius:8px; border:2px solid #c4a0ff; cursor:pointer; font-weight:700; }
    .radio-group label.presente { background:#d6ffe9; color:#2ecc71; }
    .radio-group label.ausente { background:#ffe3e3; color:#e74c3c; }
    .radio-group label.justificado { background:#eee1ff; color:#7a3eb1; }
    input[type="radio"]:checked + label.presente { background:#2ecc71; color:#fff; }
    input[type="radio"]:checked + label.ausente { background:#e74c3c; color:#fff; }
    input[type="radio"]:checked + label.justificado { background:#7a3eb1; color:#fff; }

    /* ---------- MODAL ---------- */
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45); z-index:9998; }
    .modal.active { display:flex; }
    .modal-content { background:#fff; width:92%; max-width:600px; border-radius:16px; padding:28px; box-shadow:0 12px 30px rgba(0,0,0,.18); }
    .modal-close { position:absolute; right:22px; top:18px; background:none; border:none; font-size:22px; color:#7a3eb1; cursor:pointer; }
    .modal-grid { display:grid; gap:14px; }
    .form-group label { font-weight:700; color:#5e3370; display:block; margin-bottom:6px; }
    .form-group select, .form-group textarea, .form-group input[type="file"] { width:100%; padding:10px 12px; border-radius:8px; border:2px solid #c9a4f8; background:#faf5ff; }
    .modal-buttons { display:flex; gap:12px; margin-top:16px; }
    .btn-guardar-just { flex:1; background:#2ecc71; color:#fff; padding:12px; border-radius:10px; border:none; font-weight:700; cursor:pointer; }
    .btn-sin-justificar { flex:1; background:#7a3eb1; color:#fff; padding:12px; border-radius:10px; border:none; font-weight:700; cursor:pointer; }
    /* --- ESTILO BASE DE BOTONES --- */
.btn {
    padding: 10px 18px;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: 0.25s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
}

/* --- GUARDAR --- */
.btn-save {
    background: #2a9d8f;
    color: #fff;
}
.btn-save:hover {
    background: #23867b;
    transform: translateY(-2px);
}
.btn-save:active {
    transform: scale(0.96);
}

/* --- VER --- */
.btn-view {
    background: #457b9d;
    color: #fff;
}
.btn-view:hover {
    background: #386986;
    transform: translateY(-2px);
}

/* --- ELIMINAR --- */
.btn-delete {
    background: #e63946;
    color: white;
}
.btn-delete:hover {
    background: #c5303c;
    transform: translateY(-2px);
}

/* --- PRESENTES --- */
.btn-present {
    background: #52b788;
    color: white;
}
.btn-present:hover {
    background: #439c73;
    transform: translateY(-2px);
}

/* --- AUSENTES --- */
.btn-absent {
    background: #e76f51;
    color: white;
}
.btn-absent:hover {
    background: #cf5e42;
    transform: translateY(-2px);
}

/* --- SELECCIONAR TODOS --- */
.btn-select-all {
    background: #264653;
    color: white;
}
.btn-select-all:hover {
    background: #1f3a46;
}

/* --- QUITAR SELECCIÓN --- */
.btn-unselect {
    background: #8d99ae;
    color: white;
}
.btn-unselect:hover {
    background: #79869b;
}

/* --- BOTONES PEQUEÑOS — ICONOS --- */
.btn-icon {
    padding: 8px;
    border-radius: 10px;
    background: #e9ecef;
    color: #2b2d42;
}
.btn-icon:hover {
    background: #dfe3e6;
    transform: translateY(-2px);
}

/* --- PARA BOTONES DENTRO DE TABLAS --- */
.table-btn {
    padding: 6px 12px;
    font-size: 13px;
    border-radius: 8px;
}

/* --- VERSIONES DESHABILITADAS --- */
.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

  </style>
</head>
<body>

  <!-- ========== HEADER ========== -->
  <header class="mc-header">
    <div class="mc-header-left">
      <img src="{% static 'img/logoSinFondo.png' %}" alt="Logo ICBF Conecta" class="mc-logo">
      <h1 class="mc-title">ICBF Conecta</h1>
    </div>

    <nav class="mc-header-nav">
      <ul>
        <li><a href="{% url 'madre_dashboard' %}"><i class="fas fa-arrow-left"></i> Volver</a></li>
        <li><a href="{% url 'novedades:novedades_list' %}"><i class="fas fa-exclamation-circle"></i> Reportar Novedad</a></li>
      </ul>
    </nav>

    <div class="mc-header-right">
      <!-- Notificaciones -->
      <div class="notif-container">
        <button id="notifToggle" class="notif-btn" aria-controls="notifPanel" aria-expanded="false" title="Notificaciones">
          <i class="fas fa-bell"></i>
          <span id="notifCount" class="notif-count">{{ notif_count }}</span>
        </button>

        <div id="notifPanel" class="notif-panel" role="region" aria-hidden="true">
          <div class="notif-header">
            <h4 style="margin:0;">Notificaciones</h4>
            <button id="markAllRead" class="notif-mark-all" type="button">Marcar todo</button>
          </div>

          <div class="notif-list">
            {% if notifications %}
              {% for n in notifications %}
                <div class="notif-item {% if not n.read %}unread{% endif %}">
                  <p style="margin:0; font-weight:700;">{{ n.title }}</p>
                  {% if n.message %}<p style="margin:6px 0 0 0; color:#444;">{{ n.message|truncatechars:80 }}</p>{% endif %}
                  <div class="notif-footer">
                    <small class="notif-date">{{ n.created_at|timesince }} atrás</small>
                    {% if not n.read %}<span class="notif-dot" aria-hidden="true"></span>{% endif %}
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <p style="text-align:center; padding:12px; color:#666;">Sin notificaciones</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Logout -->
      <form method="post" action="{% url 'logout' %}" id="logout-form" style="margin:0;">
        {% csrf_token %}
        <button type="submit" class="logout-btn" onclick="return confirmarLogout();"><i class="fas fa-sign-out-alt"></i></button>
      </form>
    </div>
  </header>

  <!-- ========== PAGE TITLE + CARD ========== -->
  <div class="main-title">ICBF - CONECTA | Llamado de Asistencia</div>

  <div class="card">
    {% if mensaje %}
      <div style="background:#e6ffed;padding:12px;border-radius:8px;margin-bottom:12px;color:#155724;">{{ mensaje }}</div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" id="asistencia-form">
      {% csrf_token %}
      <div style="margin-bottom:12px;">
        <label for="fecha" style="font-weight:700;color:#7a3eb1;">Fecha:</label>
        <input type="date" id="fecha" name="fecha" value="{{ fecha_hoy }}" required>
      </div>

      <div style="margin-bottom:6px;">
        <button type="button" id="select-all" class="btn-presente"><i class="fas fa-check-circle"></i> Todos presentes</button>
        <button type="button" id="select-all-ausentes" class="btn-ausente"><i class="fas fa-times-circle"></i> Todos ausentes</button>
      </div>

      <table>
        <thead>
          <tr><th>#</th><th>Nombre Completo</th><th>Asistencia</th><th>Historial</th></tr>
        </thead>
        <tbody>
          {% for nino in ninos %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ nino.nombres }} {{ nino.apellidos }}</td>
              <td>
                <div class="radio-group">
                  <input type="radio" id="presente-{{ nino.id }}" name="nino_{{ nino.id }}" value="Presente">
                  <label for="presente-{{ nino.id }}" class="presente">Presente</label>

                  <input type="radio" id="ausente-{{ nino.id }}" name="nino_{{ nino.id }}" value="Ausente" data-id="{{ nino.id }}">
                  <label for="ausente-{{ nino.id }}" class="ausente">Ausente</label>

                  <input type="radio" id="justificado-{{ nino.id }}" name="nino_{{ nino.id }}" value="Justificado" disabled>
                  <label for="justificado-{{ nino.id }}" class="justificado">Justificado</label>
                </div>
              </td>
              <td><a href="{% url 'historial_asistencia' nino.id %}" class="btn-mini-historial"><i class="fas fa-history"></i> Ver</a></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <div style="margin-top:20px;">
        <button type="submit" class="btn-guardar">Guardar Registro</button>
      </div>
    </form>
  </div>

  <!-- ===== MODAL JUSTIFICAR ===== -->
  <div id="modal-justificar" class="modal" aria-hidden="true">
    <div class="modal-content">
      <button class="modal-close" id="modal-close">&times;</button>
      <h2 style="color:#7a3eb1;text-align:center;margin-top:0;">Justificar Ausencia</h2>

      <form id="form-justificacion" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="nino_id" id="modal-nino-id">
        <input type="hidden" name="fecha" id="modal-fecha">

        <div class="modal-grid">
          <div class="form-group">
            <label for="tipo">Tipo de falta:</label>
            <select id="tipo" name="tipo" required>
              <option value="">Selecciona</option>
              <option value="Médica">Médica</option>
              <option value="Familiar">Familiar</option>
              <option value="Transporte">Transporte</option>
              <option value="Otra">Otra</option>
            </select>
          </div>

          <div class="form-group">
            <label for="descripcion">Descripción:</label>
            <textarea id="descripcion" name="descripcion" rows="3" required></textarea>
          </div>

          <div class="form-group">
            <label for="observaciones">Observaciones:</label>
            <textarea id="observaciones" name="observaciones" rows="2"></textarea>
          </div>

          <div class="form-group">
            <label for="archivo_pdf">Adjuntar soporte (PDF):</label>
            <input id="archivo_pdf" type="file" name="archivo_pdf" accept="application/pdf">
          </div>
        </div>

        <div class="modal-buttons">
          <button type="button" id="guardarJustificacionBtn" class="btn-guardar-just">Guardar Justificación</button>
          <button type="button" id="sinJustificarBtn" class="btn-sin-justificar">Sin justificar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ========== SCRIPTS UNIFICADOS ========== -->
  <script>
    /* ---------- CSRF (desde cookie) ---------- */
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i=0;i<cookies.length;i++){
          const c = cookies[i].trim();
          if (c.substring(0, name.length+1) === (name + '=')) {
            cookieValue = decodeURIComponent(c.substring(name.length+1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    /* ---------- FUNCIONES UI ---------- */
    function confirmarLogout(){ return confirm('¿Seguro que quieres cerrar sesión?'); }

    document.addEventListener('DOMContentLoaded', () => {
      const notifToggle = document.getElementById('notifToggle');
      const notifPanel  = document.getElementById('notifPanel');
      const notifCount  = document.getElementById('notifCount');
      const markAllRead = document.getElementById('markAllRead');

      const modal = document.getElementById('modal-justificar');
      const modalNinoInput = document.getElementById('modal-nino-id');
      const modalFechaInput = document.getElementById('modal-fecha');
      const guardarBtn = document.getElementById('guardarJustificacionBtn');
      const sinJustBtn = document.getElementById('sinJustificarBtn');
      const modalClose = document.getElementById('modal-close');

      /* Toggle notificaciones */
      if (notifToggle && notifPanel) {
        notifToggle.addEventListener('click', (e) => {
          e.stopPropagation();
          notifPanel.classList.toggle('visible');
        });

        document.addEventListener('click', (e) => {
          if (!notifPanel.contains(e.target) && !notifToggle.contains(e.target)) {
            notifPanel.classList.remove('visible');
          }
        });
      }

      /* Marcar todo como leído (AJAX POST) */
      if (markAllRead) {
        markAllRead.addEventListener('click', async () => {
          try {
            const resp = await fetch("{% url 'marcar_todo_leido' %}", {
              method: "POST",
              headers: { "X-CSRFToken": csrftoken },
              body: JSON.stringify({})
            });
            const data = await resp.json();
            if (data.success) {
              document.querySelectorAll('.notif-item.unread').forEach(el => el.classList.remove('unread'));
              if (notifCount) notifCount.textContent = '0';
            }
          } catch (err) {
            console.error('Error marcar todo leído:', err);
          }
        });
      }

      /* Select all presente/ausente */
      const selectAllPresente = document.getElementById('select-all');
      const selectAllAusentes = document.getElementById('select-all-ausentes');
      if (selectAllPresente) {
        selectAllPresente.addEventListener('click', () => {
          document.querySelectorAll("input[type='radio'][value='Presente']:not(:disabled)").forEach(r => r.checked = true);
        });
      }
      if (selectAllAusentes) {
        selectAllAusentes.addEventListener('click', () => {
          document.querySelectorAll("input[type='radio'][value='Ausente']:not(:disabled)").forEach(r => r.checked = true);
        });
      }

      /* Cuando se marca "Ausente" abrimos modal y cargamos nino+fecha */
      document.querySelectorAll("input[type='radio'][value='Ausente']").forEach(radio => {
        radio.addEventListener('change', (e) => {
          if (e.target.checked) {
            // abrir modal y asignar nino y fecha
            const ninoId = e.target.getAttribute('data-id');
            const fecha = document.getElementById('fecha') ? document.getElementById('fecha').value : '';
            if (!fecha) { alert('Selecciona la fecha antes de justificar.'); e.target.checked = false; return; }
            modalNinoInput.value = ninoId;
            modalFechaInput.value = fecha;
            modal.classList.add('active');
            modal.setAttribute('aria-hidden','false');
          }
        });
      });

      /* Cerrar modal */
      modalClose && modalClose.addEventListener('click', () => {
        modal.classList.remove('active'); modal.setAttribute('aria-hidden','true');
      });
      window.addEventListener('click', (ev) => {
        if (ev.target === modal) { modal.classList.remove('active'); modal.setAttribute('aria-hidden','true'); }
      });

      /* Guardar justificacion con FormData para aceptar PDF */
      if (guardarBtn) {
        guardarBtn.addEventListener('click', async () => {
          const form = document.getElementById('form-justificacion');
          const fd = new FormData(form);

          // Validaciones básicas
          if (!fd.get('tipo') || !fd.get('descripcion')) {
            alert('Completa tipo y descripción.');
            return;
          }

          try {
            const resp = await fetch("{% url 'crear_novedad_desde_asistencia' %}", {
              method: 'POST',
              headers: { 'X-CSRFToken': csrftoken },
              body: fd
            });
            const data = await resp.json();
            if (data.success) {
              // marcar radio Justificado en UI, deshabilitar radios del niño
              const nId = fd.get('nino_id');
              const justRadio = document.getElementById(`justificado-${nId}`);
              if (justRadio) { justRadio.checked = true; }
              document.getElementsByName(`nino_${nId}`).forEach(r => r.disabled = true);

              alert('Justificación guardada ✅');
              modal.classList.remove('active'); modal.setAttribute('aria-hidden','true');
            } else {
              alert('Error al guardar la justificación. Revisa la consola.');
            }
          } catch (err) {
            console.error('Error AJAX guardarJustificacion:', err);
            alert('Error de red al guardar la justificación.');
          }
        });
      }

      /* Sin justificar: cerrar modal y dejar Ausente marcado */
      if (sinJustBtn) {
        sinJustBtn.addEventListener('click', () => {
          modal.classList.remove('active'); modal.setAttribute('aria-hidden','true');
        });
      }
    }); // DOMContentLoaded
  </script>

</body>
</html>
