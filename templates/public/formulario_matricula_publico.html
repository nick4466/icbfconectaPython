{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulario de Matriculaci칩n - {{ solicitud.hogar.nombre_hogar }}</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Poppins', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; min-height: 100vh; padding: 20px; }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 40px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    }
    
    .header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 20px;
      border-bottom: 3px solid #667eea;
    }
    
    .header h1 {
      color: #667eea;
      font-size: 32px;
      margin-bottom: 10px;
    }
    
    .header .hogar-info {
      color: #666;
      font-size: 16px;
      font-weight: 500;
    }
    
    .error-container {
      text-align: center;
      padding: 60px 20px;
    }
    
    .error-icon {
      font-size: 80px;
      color: #e74c3c;
      margin-bottom: 20px;
    }
    
    .error-message {
      font-size: 20px;
      color: #333;
      margin-bottom: 10px;
    }
    
    .error-detail {
      color: #666;
      font-size: 14px;
    }
    
    .section {
      margin-bottom: 40px;
      padding-bottom: 30px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .section:last-of-type { border-bottom: none; }
    
    .section-title {
      font-size: 20px;
      color: #667eea;
      font-weight: 700;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 15px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    
    .section-title i { font-size: 24px; }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group.full-width {
      grid-column: 1 / -1;
    }
    
    label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #555;
      font-size: 14px;
    }
    
    .required { color: #dc3545; margin-left: 3px; font-weight: bold; }
    
    input[type="text"],
    input[type="email"],
    input[type="number"],
    input[type="date"],
    input[type="tel"],
    input[type="password"],
    select,
    textarea {
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    input:focus,
    select:focus,
    textarea:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
      outline: none;
    }
    
    input:disabled,
    select:disabled,
    textarea:disabled {
      background-color: #f8f9fa;
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    /* Campos editables en modo correcci칩n */
    input.editable,
    select.editable,
    textarea.editable {
      border-color: #ffc107;
      background-color: #fff3cd;
    }
    
    /* Error de validaci칩n de edad */
    input.error-edad {
      border-color: #dc3545 !important;
      background-color: #f8d7da !important;
    }
    
    .mensaje-error-edad {
      color: #dc3545;
      font-size: 13px;
      margin-top: 5px;
      font-weight: 500;
      display: none;
    }
    
    input.editable:focus,
    select.editable:focus,
    textarea.editable:focus {
      border-color: #ff9800;
      box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.2);
    }
    
    .correction-badge {
      display: inline-block;
      background: #ff9800;
      color: white;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 4px;
      margin-left: 8px;
      font-weight: 600;
    }
    
    textarea { resize: vertical; min-height: 100px; }
    
    .file-group {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background-color: #fafafa;
    }
    
    .file-group:hover {
      background-color: #f0f4ff;
      border-color: #667eea;
    }
    
    .file-group.required-doc {
      border-color: #dc3545;
      background-color: #fff5f5;
    }
    
    .file-group.field-correction {
      border-color: #ff9800;
      background-color: #fff8e1;
      border-width: 3px;
      animation: pulse-orange 2s infinite;
    }
    
    @keyframes pulse-orange {
      0%, 100% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.4); }
      50% { box-shadow: 0 0 0 10px rgba(255, 152, 0, 0); }
    }
    
    .file-group input[type="file"] { display: none; }
    
    .file-label {
      cursor: pointer;
      color: #667eea;
      font-weight: 600;
      display: block;
    }
    
    .file-label i {
      font-size: 32px;
      display: block;
      margin-bottom: 10px;
    }
    
    .file-info {
      font-size: 12px;
      color: #999;
      margin-top: 8px;
    }
    
    .file-preview {
      margin-top: 10px;
      padding: 10px;
      background: #e8f5e9;
      border-radius: 6px;
      color: #2e7d32;
      font-size: 13px;
      display: none;
    }
    
    .file-preview i {
      margin-right: 5px;
    }
    
    .file-preview-image {
      margin-top: 10px;
      max-width: 100%;
      border-radius: 8px;
      border: 2px solid #667eea;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: none;
    }
    
    .file-preview-info {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      padding: 10px;
      background: #e8f5e9;
      border-radius: 6px;
      border-left: 4px solid #28a745;
      display: none;
    }
    
    .file-preview-info i {
      font-size: 24px;
      color: #28a745;
    }
    
    .file-preview-details {
      flex: 1;
    }
    
    .file-preview-name {
      font-weight: 600;
      color: #2e7d32;
      margin-bottom: 3px;
    }
    
    .file-preview-size {
      font-size: 11px;
      color: #666;
    }
    
    .file-preview-remove {
      background: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
    }
    
    .file-preview-remove:hover {
      background: #c82333;
    }
    
    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 25px;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .alert-info {
      background: #d1ecf1;
      border-left: 4px solid #17a2b8;
      color: #0c5460;
    }
    
    .alert-warning {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      color: #856404;
    }
    
    .alert-success {
      background: #d4edda;
      border-left: 4px solid #28a745;
      color: #155724;
    }
    
    .credentials-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 10px;
      margin: 20px 0;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .credentials-box h3 {
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    .credentials-box p {
      margin: 8px 0;
      font-size: 14px;
    }
    
    .credentials-box .highlight {
      background: rgba(255,255,255,0.2);
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
      font-weight: 600;
    }
    
    .form-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 40px;
      padding-top: 30px;
      border-top: 3px solid #f0f0f0;
    }
    
    .btn {
      padding: 15px 40px;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'Poppins', sans-serif;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    
    .btn-submit {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .password-strength {
      margin-top: 8px;
      font-size: 12px;
    }
    
    .strength-weak { color: #dc3545; }
    .strength-medium { color: #ffc107; }
    .strength-strong { color: #28a745; }
    
    @media (max-width: 768px) {
      .container { padding: 20px; }
      .form-grid { grid-template-columns: 1fr; }
      .header h1 { font-size: 24px; }
      .btn { padding: 12px 25px; font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="container">
    {% if not token_valido %}
      <!-- Mostrar diferentes mensajes seg칰n el estado -->
      <div class="error-container">
        {% if estado_solicitud == 'aprobado' %}
          <div class="error-icon" style="color: #28a745;"><i class="fas fa-check-circle"></i></div>
          <h2 class="error-message" style="color: #28a745;">춰Solicitud Aprobada!</h2>
          <p class="error-detail">{{ mensaje_error }}</p>
          <p style="margin-top: 20px; color: #666;">El ni침o <strong>{{ solicitud.nombres_nino }} {{ solicitud.apellidos_nino }}</strong> ya est치 matriculado en {{ solicitud.hogar.nombre_hogar }}.</p>
        
        {% elif estado_solicitud == 'rechazado' %}
          <div class="error-icon" style="color: #dc3545;"><i class="fas fa-times-circle"></i></div>
          <h2 class="error-message" style="color: #dc3545;">Solicitud Rechazada</h2>
          <p class="error-detail">{{ mensaje_error }}</p>
          {% if motivo_rechazo %}
          <div style="margin-top: 20px; padding: 20px; background: #f8d7da; border-radius: 8px; border-left: 4px solid #dc3545;">
            <strong>Motivo:</strong>
            <p style="margin-top: 10px; color: #721c24;">{{ motivo_rechazo }}</p>
          </div>
          {% endif %}
          <p style="margin-top: 20px; color: #666;">Si desea volver a aplicar, contacte al hogar comunitario.</p>
        
        {% elif estado_solicitud == 'expirado' %}
          <div class="error-icon" style="color: #ffc107;"><i class="fas fa-clock"></i></div>
          <h2 class="error-message" style="color: #ffc107;">Enlace Expirado</h2>
          <p class="error-detail">{{ mensaje_error }}</p>
          <p style="margin-top: 20px; color: #666;">Este enlace expir칩 el {{ solicitud.fecha_expiracion|date:"d/m/Y H:i" }}.</p>
          {% if puede_renovar %}
          <div style="margin-top: 30px;">
            <p style="margin-bottom: 15px; color: #666;">Por favor, contacte al hogar comunitario para solicitar un nuevo enlace de matriculaci칩n.</p>
            <a href="mailto:{{ solicitud.hogar.madre.usuario.correo }}" style="display: inline-block; padding: 12px 30px; background: #667eea; color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
              <i class="fas fa-envelope"></i> Contactar Hogar
            </a>
          </div>
          {% endif %}
        
        {% elif estado_solicitud == 'limite_excedido' %}
          <div class="error-icon" style="color: #dc3545;"><i class="fas fa-ban"></i></div>
          <h2 class="error-message" style="color: #dc3545;">L칤mite de Intentos Excedido</h2>
          <p class="error-detail">{{ mensaje_error }}</p>
          <p style="margin-top: 20px; color: #666;">Ha alcanzado el m치ximo de 3 intentos de correcci칩n. Por favor, contacte directamente al hogar comunitario.</p>
        
        {% elif estado_solicitud == 'cancelado_expiracion' %}
          <div class="error-icon" style="color: #ff9800;"><i class="fas fa-calendar-times"></i></div>
          <h2 class="error-message" style="color: #ff9800;">Solicitud Cancelada por Expiraci칩n</h2>
          <p class="error-detail">{{ mensaje_error }}</p>
          {% if motivo_cancelacion %}
          <p style="margin-top: 20px; color: #666;">{{ motivo_cancelacion }}</p>
          {% endif %}
          <p style="margin-top: 20px; color: #666;">Si desea aplicar nuevamente, contacte al hogar comunitario.</p>
        
        {% elif estado_solicitud == 'cancelado_usuario' %}
          <div class="error-icon" style="color: #6c757d;"><i class="fas fa-user-times"></i></div>
          <h2 class="error-message" style="color: #6c757d;">Solicitud Cancelada</h2>
          <p class="error-detail">{{ mensaje_error }}</p>
          {% if motivo_cancelacion %}
          <div style="margin-top: 20px; padding: 20px; background: #e9ecef; border-radius: 8px; border-left: 4px solid #6c757d;">
            <strong>Motivo:</strong>
            <p style="margin-top: 10px; color: #495057;">{{ motivo_cancelacion }}</p>
          </div>
          {% endif %}
          <p style="margin-top: 20px; color: #666;">Esta solicitud fue cancelada. Si fue un error, contacte al hogar comunitario.</p>
        
        {% else %}
          <div class="error-icon"><i class="fas fa-exclamation-triangle"></i></div>
          <h2 class="error-message">Enlace No V치lido</h2>
          <p class="error-detail">{{ mensaje_error }}</p>
        {% endif %}
      </div>
    {% else %}
      <!-- Mostrar formulario si el token es v치lido -->
      <div class="header">
        <h1><i class="fas fa-child"></i> Formulario de Matriculaci칩n</h1>
        <div class="hogar-info">{{ solicitud.hogar.nombre_hogar }}</div>
      </div>

      {% if en_correccion %}
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>Correcciones Requeridas:</strong> Los campos resaltados en amarillo requieren correcci칩n. Los dem치s campos est치n bloqueados porque ya fueron aprobados.
          <br>
          <strong style="color: #856404;">Intentos restantes: {{ intentos_restantes }}/3</strong>
        </div>
      {% else %}
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          Complete todos los campos marcados con <span class="required">*</span>. Los documentos son obligatorios para procesar su solicitud.
        </div>
      {% endif %}

      <form id="formularioMatricula" method="POST" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- SECCI칍N: DATOS DEL NI칌O -->
        <div class="section">
          <div class="section-title">
            <i class="fas fa-baby"></i>
            Datos del Ni침o/Ni침a
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label>
                Nombres <span class="required">*</span>
                {% if 'nombres_nino' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <input type="text" name="nombres_nino" value="{{ solicitud.nombres_nino }}" 
                     {% if en_correccion and 'nombres_nino' not in campos_corregir %}disabled{% endif %}
                     {% if 'nombres_nino' in campos_corregir %}class="editable"{% endif %} required>
            </div>

            <div class="form-group">
              <label>
                Apellidos <span class="required">*</span>
                {% if 'apellidos_nino' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <input type="text" name="apellidos_nino" value="{{ solicitud.apellidos_nino }}" 
                     {% if en_correccion and 'apellidos_nino' not in campos_corregir %}disabled{% endif %}
                     {% if 'apellidos_nino' in campos_corregir %}class="editable"{% endif %} required>
            </div>

            <div class="form-group">
              <label>
                Documento <span class="required">*</span>
                {% if 'documento_nino' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <input type="text" name="documento_nino" value="{{ solicitud.documento_nino }}" 
                     {% if en_correccion and 'documento_nino' not in campos_corregir %}disabled{% endif %}
                     {% if 'documento_nino' in campos_corregir %}class="editable"{% endif %} required>
            </div>

            <div class="form-group">
              <label>
                Fecha de Nacimiento <span class="required">*</span>
                {% if 'fecha_nacimiento_nino' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <input type="date" name="fecha_nacimiento_nino" id="fecha_nacimiento_nino"
                     value="{% if solicitud.fecha_nacimiento_nino %}{{ solicitud.fecha_nacimiento_nino|date:'Y-m-d' }}{% endif %}" 
                     {% if en_correccion and 'fecha_nacimiento_nino' not in campos_corregir %}disabled{% endif %}
                     {% if 'fecha_nacimiento_nino' in campos_corregir %}class="editable"{% endif %} required>
              <div class="mensaje-error-edad" id="error-edad"></div>
            </div>

            <div class="form-group">
              <label>
                G칠nero <span class="required">*</span>
                {% if 'genero_nino' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <select name="genero_nino" 
                      {% if en_correccion and 'genero_nino' not in campos_corregir %}disabled{% endif %}
                      {% if 'genero_nino' in campos_corregir %}class="editable"{% endif %} required>
                <option value="">Seleccione...</option>
                <option value="M" {% if solicitud.genero_nino == 'M' %}selected{% endif %}>Masculino</option>
                <option value="F" {% if solicitud.genero_nino == 'F' %}selected{% endif %}>Femenino</option>
              </select>
            </div>

            <div class="form-group">
              <label>
                Tipo de Sangre <span class="required">*</span>
                {% if 'tipo_sangre_nino' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <select name="tipo_sangre_nino" 
                      {% if en_correccion and 'tipo_sangre_nino' not in campos_corregir %}disabled{% endif %}
                      {% if 'tipo_sangre_nino' in campos_corregir %}class="editable"{% endif %} required>
                <option value="">Seleccione...</option>
                <option value="A+" {% if solicitud.tipo_sangre_nino == 'A+' %}selected{% endif %}>A+</option>
                <option value="A-" {% if solicitud.tipo_sangre_nino == 'A-' %}selected{% endif %}>A-</option>
                <option value="B+" {% if solicitud.tipo_sangre_nino == 'B+' %}selected{% endif %}>B+</option>
                <option value="B-" {% if solicitud.tipo_sangre_nino == 'B-' %}selected{% endif %}>B-</option>
                <option value="AB+" {% if solicitud.tipo_sangre_nino == 'AB+' %}selected{% endif %}>AB+</option>
                <option value="AB-" {% if solicitud.tipo_sangre_nino == 'AB-' %}selected{% endif %}>AB-</option>
                <option value="O+" {% if solicitud.tipo_sangre_nino == 'O+' %}selected{% endif %}>O+</option>
                <option value="O-" {% if solicitud.tipo_sangre_nino == 'O-' %}selected{% endif %}>O-</option>
              </select>
            </div>

            <div class="form-group">
              <label>
                Parentesco <span class="required">*</span>
                {% if 'parentesco' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <select name="parentesco" 
                      {% if en_correccion and 'parentesco' not in campos_corregir %}disabled{% endif %}
                      {% if 'parentesco' in campos_corregir %}class="editable"{% endif %} required>
                <option value="">Seleccione...</option>
                <option value="Padre" {% if solicitud.parentesco == 'Padre' %}selected{% endif %}>Padre</option>
                <option value="Madre" {% if solicitud.parentesco == 'Madre' %}selected{% endif %}>Madre</option>
                <option value="Abuelo/a" {% if solicitud.parentesco == 'Abuelo/a' %}selected{% endif %}>Abuelo/a</option>
                <option value="T칤o/a" {% if solicitud.parentesco == 'T칤o/a' %}selected{% endif %}>T칤o/a</option>
                <option value="Tutor legal" {% if solicitud.parentesco == 'Tutor legal' %}selected{% endif %}>Tutor Legal</option>
                <option value="Otro" {% if solicitud.parentesco == 'Otro' %}selected{% endif %}>Otro</option>
              </select>
            </div>

            <div class="form-group full-width">
              <label>
                Observaciones M칠dicas
                {% if 'observaciones_nino' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <textarea name="observaciones_nino" 
                        {% if en_correccion and 'observaciones_nino' not in campos_corregir %}disabled{% endif %}
                        {% if 'observaciones_nino' in campos_corregir %}class="editable"{% endif %} 
                        placeholder="Alergias, condiciones m칠dicas, medicamentos, etc.">{{ solicitud.observaciones_nino }}</textarea>
            </div>

            <!-- Discapacidad -->
            <div class="form-group full-width">
              <label>
                쮼l ni침o/a tiene alguna discapacidad?
                {% if 'tiene_discapacidad' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <div style="display: flex; gap: 20px; margin-top: 10px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                  <input type="radio" name="tiene_discapacidad" value="true" 
                         {% if solicitud.tiene_discapacidad %}checked{% endif %}
                         {% if en_correccion and 'tiene_discapacidad' not in campos_corregir %}disabled{% endif %}
                         onchange="toggleDiscapacidades(this.checked)"
                         style="margin-right: 8px;">
                  S칤
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                  <input type="radio" name="tiene_discapacidad" value="false" 
                         {% if not solicitud.tiene_discapacidad %}checked{% endif %}
                         {% if en_correccion and 'tiene_discapacidad' not in campos_corregir %}disabled{% endif %}
                         onchange="toggleDiscapacidades(!this.checked)"
                         style="margin-right: 8px;">
                  No
                </label>
              </div>
            </div>

            <div id="tipos-discapacidad-container" class="form-group full-width" style="display: {% if solicitud.tiene_discapacidad %}block{% else %}none{% endif %};">
              <label>
                Tipo(s) de Discapacidad
                {% if 'tipos_discapacidad' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">
                {% for disc in discapacidades %}
                <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: #f8f9fa; border-radius: 5px;">
                  <input type="checkbox" name="tipos_discapacidad" value="{{ disc.id }}" 
                         {% if solicitud.tipos_discapacidad and disc.id in solicitud.tipos_discapacidad %}checked{% endif %}
                         {% if en_correccion and 'tipos_discapacidad' not in campos_corregir %}disabled{% endif %}
                         style="margin-right: 8px;">
                  {{ disc.nombre }}
                </label>
                {% endfor %}
              </div>
              
              <div style="margin-top: 15px;">
                <label>Otra discapacidad (especificar)</label>
                <input type="text" name="otra_discapacidad" 
                       value="{{ solicitud.otra_discapacidad|default:'' }}"
                       {% if en_correccion and 'otra_discapacidad' not in campos_corregir %}disabled{% endif %}
                       placeholder="Si el ni침o/a tiene otra discapacidad no listada, descr칤bala aqu칤">
              </div>
            </div>
          </div>
        </div>

        <!-- SECCI칍N: DATOS DEL ACUDIENTE -->
        <div class="section">
          <div class="section-title">
            <i class="fas fa-user-tie"></i>
            Datos del Padre, Madre o Acudiente
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label>
                Tipo de Documento <span class="required">*</span>
                {% if 'tipo_documento_padre' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <select name="tipo_documento_padre" 
                      {% if en_correccion and 'tipo_documento_padre' not in campos_corregir %}disabled{% endif %}
                      {% if 'tipo_documento_padre' in campos_corregir %}class="editable"{% endif %} required>
                <option value="">Seleccione...</option>
                <option value="CC" {% if solicitud.tipo_documento_padre == 'CC' %}selected{% endif %}>C칠dula de Ciudadan칤a</option>
                <option value="CE" {% if solicitud.tipo_documento_padre == 'CE' %}selected{% endif %}>C칠dula de Extranjer칤a</option>
                <option value="TI" {% if solicitud.tipo_documento_padre == 'TI' %}selected{% endif %}>Tarjeta de Identidad</option>
                <option value="PA" {% if solicitud.tipo_documento_padre == 'PA' %}selected{% endif %}>Pasaporte</option>
              </select>
            </div>

            <div class="form-group">
              <label>
                N칰mero de Documento <span class="required">*</span>
                {% if 'documento_padre' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <input type="text" name="documento_padre" value="{{ solicitud.documento_padre }}" 
                     {% if en_correccion and 'documento_padre' not in campos_corregir %}disabled{% endif %}
                     {% if 'documento_padre' in campos_corregir %}class="editable"{% endif %} required>
            </div>

            <div class="form-group">
              <label>
                Nombres <span class="required">*</span>
                {% if 'nombres_padre' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <input type="text" name="nombres_padre" value="{{ solicitud.nombres_padre }}" 
                     {% if en_correccion and 'nombres_padre' not in campos_corregir %}disabled{% endif %}
                     {% if 'nombres_padre' in campos_corregir %}class="editable"{% endif %} required>
            </div>

            <div class="form-group">
              <label>
                Apellidos <span class="required">*</span>
                {% if 'apellidos_padre' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <input type="text" name="apellidos_padre" value="{{ solicitud.apellidos_padre }}" 
                     {% if en_correccion and 'apellidos_padre' not in campos_corregir %}disabled{% endif %}
                     {% if 'apellidos_padre' in campos_corregir %}class="editable"{% endif %} required>
            </div>

            <div class="form-group">
              <label>
                Tel칠fono <span class="required">*</span>
                {% if 'telefono_padre' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <input type="tel" name="telefono_padre" value="{{ solicitud.telefono_padre }}" 
                     {% if en_correccion and 'telefono_padre' not in campos_corregir %}disabled{% endif %}
                     {% if 'telefono_padre' in campos_corregir %}class="editable"{% endif %} 
                     placeholder="Ej: 3001234567" required>
            </div>

            <div class="form-group">
              <label>
                Correo Electr칩nico <span class="required">*</span>
                {% if 'correo_padre' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <input type="email" name="correo_padre" value="{{ solicitud.correo_padre }}" 
                     {% if en_correccion and 'correo_padre' not in campos_corregir %}disabled{% endif %}
                     {% if 'correo_padre' in campos_corregir %}class="editable"{% endif %} required>
            </div>

            <!-- 游 CAMPOS GEOGR츼FICOS -->
            <div class="form-group">
              <label>
                Departamento <span class="required">*</span>
                {% if 'departamento_padre' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <select name="departamento_padre" id="id_departamento_padre" 
                      {% if en_correccion and 'departamento_padre' not in campos_corregir %}disabled{% endif %}
                      {% if 'departamento_padre' in campos_corregir %}class="editable"{% endif %} 
                      required>
                <option value="">-- Seleccione un Departamento --</option>
                {% for dept in departamentos %}
                <option value="{{ dept.id }}" {% if solicitud.departamento_padre_id == dept.id %}selected{% endif %}>
                  {{ dept.nombre }}
                </option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <label>
                Ciudad/Municipio <span class="required">*</span>
                {% if 'ciudad_padre' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <select name="ciudad_padre" id="id_ciudad_padre" 
                      {% if en_correccion and 'ciudad_padre' not in campos_corregir %}disabled{% endif %}
                      {% if 'ciudad_padre' in campos_corregir %}class="editable"{% endif %} 
                      required>
                <option value="">-- Seleccione una Ciudad --</option>
              </select>
            </div>

            <div class="form-group" id="localidad-padre-group" style="display: none;">
              <label>
                Localidad (solo Bogot치)
                {% if 'localidad_bogota_padre' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <select name="localidad_bogota_padre" id="id_localidad_bogota_padre" 
                      {% if en_correccion and 'localidad_bogota_padre' not in campos_corregir %}disabled{% endif %}
                      {% if 'localidad_bogota_padre' in campos_corregir %}class="editable"{% endif %}>
                <option value="">-- Seleccione una Localidad --</option>
              </select>
              <small style="color:#666;display:block;margin-top:5px;">Solo se muestra si vive en Bogot치 D.C.</small>
            </div>

            <div class="form-group full-width">
              <label>
                Direcci칩n Completa <span class="required">*</span>
                {% if 'direccion_padre' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <input type="text" name="direccion_padre" value="{{ solicitud.direccion_padre }}" 
                     {% if en_correccion and 'direccion_padre' not in campos_corregir %}disabled{% endif %}
                     {% if 'direccion_padre' in campos_corregir %}class="editable"{% endif %} 
                     placeholder="Ej: Calle 123 #45-67" required>
            </div>

            <div class="form-group">
              <label>
                Barrio <span class="required">*</span>
                {% if 'barrio_padre' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <input type="text" name="barrio_padre" value="{{ solicitud.barrio_padre }}" 
                     {% if en_correccion and 'barrio_padre' not in campos_corregir %}disabled{% endif %}
                     {% if 'barrio_padre' in campos_corregir %}class="editable"{% endif %} required>
            </div>

            <div class="form-group">
              <label>
                Ocupaci칩n <span class="required">*</span>
                {% if 'ocupacion_padre' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <input type="text" name="ocupacion_padre" value="{{ solicitud.ocupacion_padre }}" 
                     {% if en_correccion and 'ocupacion_padre' not in campos_corregir %}disabled{% endif %}
                     {% if 'ocupacion_padre' in campos_corregir %}class="editable"{% endif %} required>
            </div>

            <div class="form-group">
              <label>
                Nivel Educativo <span class="required">*</span>
                {% if 'nivel_educativo_padre' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <select name="nivel_educativo_padre" 
                      {% if en_correccion and 'nivel_educativo_padre' not in campos_corregir %}disabled{% endif %}
                      {% if 'nivel_educativo_padre' in campos_corregir %}class="editable"{% endif %} required>
                <option value="">Seleccione...</option>
                <option value="Primaria" {% if solicitud.nivel_educativo_padre == 'Primaria' %}selected{% endif %}>Primaria</option>
                <option value="Bachillerato" {% if solicitud.nivel_educativo_padre == 'Bachillerato' %}selected{% endif %}>Bachillerato</option>
                <option value="T칠cnico" {% if solicitud.nivel_educativo_padre == 'T칠cnico' %}selected{% endif %}>T칠cnico</option>
                <option value="Tecn칩logo" {% if solicitud.nivel_educativo_padre == 'Tecn칩logo' %}selected{% endif %}>Tecn칩logo</option>
                <option value="Profesional" {% if solicitud.nivel_educativo_padre == 'Profesional' %}selected{% endif %}>Profesional</option>
                <option value="Posgrado" {% if solicitud.nivel_educativo_padre == 'Posgrado' %}selected{% endif %}>Posgrado</option>
              </select>
            </div>
          </div>
        </div>

        <!-- SECCI칍N: CREDENCIALES DE ACCESO -->
        <div class="section">
          <div class="section-title">
            <i class="fas fa-key"></i>
            Credenciales de Acceso al Sistema
          </div>
          
          <div class="credentials-box">
            <h3><i class="fas fa-info-circle"></i> Informaci칩n Importante</h3>
            <p>Con estas credenciales podr치s ingresar al sistema ICBF Conecta para ver el desarrollo de tu hijo(a), consultar el calendario de actividades y recibir notificaciones del hogar.</p>
            <div class="highlight">
              <strong>Usuario:</strong> Tu n칰mero de documento<br>
              <strong>Contrase침a:</strong> La que configures a continuaci칩n
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label>
                Contrase침a <span class="required">*</span>
              </label>
              <input type="password" name="password_padre" id="password" minlength="8" required>
              <div id="password-strength" class="password-strength"></div>
            </div>

            <div class="form-group">
              <label>
                Confirmar Contrase침a <span class="required">*</span>
              </label>
              <input type="password" name="password_confirm" id="password_confirm" minlength="8" required>
              <div id="password-match" style="font-size: 12px; margin-top: 5px;"></div>
            </div>
          </div>
        </div>

        <!-- SECCI칍N: DOCUMENTOS -->
        <div class="section">
          <div class="section-title">
            <i class="fas fa-file-upload"></i>
            Documentos Requeridos
          </div>

          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>TODOS los documentos son obligatorios.</strong> Aseg칰rate de tener los archivos digitalizados en formato JPG, PNG o PDF antes de continuar.
          </div>

          <div class="form-grid">
            <!-- Foto del Ni침o -->
            <div class="form-group">
              <label>
                Foto del Ni침o/Ni침a <span class="required">*</span>
              </label>
              <div class="file-group {% if not solicitud.foto_nino %}required-doc{% endif %} {% if 'foto_nino' in campos_corregir %}field-correction{% endif %}" onclick="document.getElementById('foto_nino').click();">
                <label class="file-label">
                  <i class="fas fa-camera"></i>
                  {% if solicitud.foto_nino %}
                    Cambiar foto
                  {% else %}
                    Subir foto
                  {% endif %}
                  <span class="file-info">(JPG, PNG - M치x 5MB)</span>
                </label>
                <input type="file" id="foto_nino" name="foto_nino" accept="image/*" {% if not solicitud.foto_nino %}required{% endif %}>
              </div>
              {% if solicitud.foto_nino %}
              <div class="file-preview-info" style="display: flex;">
                <i class="fas fa-check-circle"></i>
                <div class="file-preview-details">
                  <div class="file-preview-name">Foto actual cargada</div>
                  <div class="file-preview-size">Puedes cambiarla seleccionando una nueva</div>
                </div>
              </div>
              {% endif %}
            </div>

            <!-- Carnet de Vacunaci칩n -->
            <div class="form-group">
              <label>
                Carnet de Vacunaci칩n <span class="required">*</span>
              </label>
              <div class="file-group {% if not solicitud.carnet_vacunacion_nino %}required-doc{% endif %} {% if 'carnet_vacunacion_nino' in campos_corregir %}field-correction{% endif %}" onclick="document.getElementById('carnet_vacunacion').click();">
                <label class="file-label">
                  <i class="fas fa-syringe"></i>
                  {% if solicitud.carnet_vacunacion_nino %}
                    Cambiar carnet
                  {% else %}
                    Subir carnet
                  {% endif %}
                  <span class="file-info">(JPG, PNG, PDF - M치x 5MB)</span>
                </label>
                <input type="file" id="carnet_vacunacion" name="carnet_vacunacion_nino" accept="image/*,application/pdf" {% if not solicitud.carnet_vacunacion_nino %}required{% endif %}>
              </div>
              {% if solicitud.carnet_vacunacion_nino %}
              <div class="file-preview-info" style="display: flex;">
                <i class="fas fa-check-circle"></i>
                <div class="file-preview-details">
                  <div class="file-preview-name">Carnet actual cargado</div>
                  <div class="file-preview-size">Puedes cambiarlo seleccionando uno nuevo</div>
                </div>
              </div>
              {% endif %}
            </div>

            <!-- Certificado EPS -->
            <div class="form-group">
              <label>
                Certificado EPS <span class="required">*</span>
                {% if 'certificado_eps_nino' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <div class="file-group {% if not solicitud.certificado_eps_nino %}required-doc{% endif %} {% if 'certificado_eps_nino' in campos_corregir %}field-correction{% endif %}" onclick="document.getElementById('certificado_eps').click();">
                <label class="file-label">
                  <i class="fas fa-hospital"></i>
                  {% if solicitud.certificado_eps_nino %}
                    Cambiar certificado
                  {% else %}
                    Subir certificado
                  {% endif %}
                  <span class="file-info">(JPG, PNG, PDF - M치x 5MB)</span>
                </label>
                <input type="file" id="certificado_eps" name="certificado_eps_nino" accept="image/*,application/pdf" {% if not solicitud.certificado_eps_nino %}required{% endif %}>
              </div>
              {% if solicitud.certificado_eps_nino %}
              <div class="file-preview-info" style="display: flex;">
                <i class="fas fa-check-circle"></i>
                <div class="file-preview-details">
                  <div class="file-preview-name">Certificado actual cargado</div>
                  <div class="file-preview-size">Puedes cambiarlo seleccionando uno nuevo</div>
                </div>
              </div>
              {% endif %}
            </div>

            <!-- Registro Civil -->
            <div class="form-group">
              <label>
                Registro Civil <span class="required">*</span>
                {% if 'registro_civil_nino' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <div class="file-group {% if not solicitud.registro_civil_nino %}required-doc{% endif %} {% if 'registro_civil_nino' in campos_corregir %}field-correction{% endif %}" onclick="document.getElementById('registro_civil').click();">
                <label class="file-label">
                  <i class="fas fa-id-card"></i>
                  {% if solicitud.registro_civil_nino %}
                    Cambiar registro
                  {% else %}
                    Subir registro
                  {% endif %}
                  <span class="file-info">(JPG, PNG, PDF - M치x 5MB)</span>
                </label>
                <input type="file" id="registro_civil" name="registro_civil_nino" accept="image/*,application/pdf" {% if not solicitud.registro_civil_nino %}required{% endif %}>
              </div>
              {% if solicitud.registro_civil_nino %}
              <div class="file-preview-info" style="display: flex;">
                <i class="fas fa-check-circle"></i>
                <div class="file-preview-details">
                  <div class="file-preview-name">Registro actual cargado</div>
                  <div class="file-preview-size">Puedes cambiarlo seleccionando uno nuevo</div>
                </div>
              </div>
              {% endif %}
            </div>

            <!-- Documento Identidad Padre -->
            <div class="form-group">
              <label>
                Documento Identidad Acudiente <span class="required">*</span>
                {% if 'documento_identidad_padre' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <div class="file-group {% if not solicitud.documento_identidad_padre %}required-doc{% endif %} {% if 'documento_identidad_padre' in campos_corregir %}field-correction{% endif %}" onclick="document.getElementById('doc_padre').click();">
                <label class="file-label">
                  <i class="fas fa-address-card"></i>
                  {% if solicitud.documento_identidad_padre %}
                    Cambiar documento
                  {% else %}
                    Subir documento
                  {% endif %}
                  <span class="file-info">(JPG, PNG, PDF - M치x 5MB)</span>
                </label>
                <input type="file" id="doc_padre" name="documento_identidad_padre" accept="image/*,application/pdf" {% if not solicitud.documento_identidad_padre %}required{% endif %}>
              </div>
              {% if solicitud.documento_identidad_padre %}
              <div class="file-preview-info" style="display: flex;">
                <i class="fas fa-check-circle"></i>
                <div class="file-preview-details">
                  <div class="file-preview-name">Documento actual cargado</div>
                  <div class="file-preview-size">Puedes cambiarlo seleccionando uno nuevo</div>
                </div>
              </div>
              {% endif %}
            </div>

            <!-- Clasificaci칩n SISBEN -->
            <div class="form-group">
              <label>
                Clasificaci칩n SISBEN <span class="required">*</span>
                {% if 'clasificacion_sisben_padre' in campos_corregir %}<span class="correction-badge">CORREGIR</span>{% endif %}
              </label>
              <div class="file-group {% if not solicitud.clasificacion_sisben_padre %}required-doc{% endif %} {% if 'clasificacion_sisben_padre' in campos_corregir %}field-correction{% endif %}" onclick="document.getElementById('sisben').click();">
                <label class="file-label">
                  <i class="fas fa-file-alt"></i>
                  {% if solicitud.clasificacion_sisben_padre %}
                    Cambiar SISBEN
                  {% else %}
                    Subir SISBEN
                  {% endif %}
                  <span class="file-info">(JPG, PNG, PDF - M치x 5MB)</span>
                </label>
                <input type="file" id="sisben" name="clasificacion_sisben_padre" accept="image/*,application/pdf" {% if not solicitud.clasificacion_sisben_padre %}required{% endif %}>
              </div>
              {% if solicitud.clasificacion_sisben_padre %}
              <div class="file-preview-info" style="display: flex;">
                <i class="fas fa-check-circle"></i>
                <div class="file-preview-details">
                  <div class="file-preview-name">Clasificaci칩n actual cargada</div>
                  <div class="file-preview-size">Puedes cambiarla seleccionando una nueva</div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- BOTONES DE ACCI칍N -->
        <div class="form-actions">
          <button type="submit" class="btn btn-submit" id="btnSubmit">
            <i class="fas fa-paper-plane"></i>
            Enviar Solicitud
          </button>
          
          <button type="button" class="btn btn-cancel" id="btnCancelar" onclick="cancelarSolicitud()" style="background: #6c757d; margin-left: 10px;">
            <i class="fas fa-times"></i>
            Cancelar Solicitud
          </button>
        </div>
      </form>
    {% endif %}
  </div>

  <script>
    // Toggle de discapacidades
    function toggleDiscapacidades(mostrar) {
      const container = document.getElementById('tipos-discapacidad-container');
      if (container) {
        container.style.display = mostrar ? 'block' : 'none';
        
        // Limpiar selecciones si se oculta
        if (!mostrar) {
          const checkboxes = container.querySelectorAll('input[type="checkbox"]');
          checkboxes.forEach(cb => cb.checked = false);
          const otraInput = container.querySelector('input[type="text"]');
          if (otraInput) otraInput.value = '';
        }
      }
    }

    // Validaci칩n de contrase침a
    const passwordInput = document.getElementById('password');
    const passwordConfirm = document.getElementById('password_confirm');
    const strengthDiv = document.getElementById('password-strength');
    const matchDiv = document.getElementById('password-match');

    if (passwordInput) {
      passwordInput.addEventListener('input', function() {
        const password = this.value;
        let strength = '';
        let className = '';

        if (password.length >= 8) {
          const hasLower = /[a-z]/.test(password);
          const hasUpper = /[A-Z]/.test(password);
          const hasNumber = /[0-9]/.test(password);
          const hasSpecial = /[^a-zA-Z0-9]/.test(password);

          const score = [hasLower, hasUpper, hasNumber, hasSpecial].filter(Boolean).length;

          if (score <= 2) {
            strength = 'D칠bil';
            className = 'strength-weak';
          } else if (score === 3) {
            strength = 'Media';
            className = 'strength-medium';
          } else {
            strength = 'Fuerte';
            className = 'strength-strong';
          }
        } else {
          strength = 'M칤nimo 8 caracteres';
          className = 'strength-weak';
        }

        strengthDiv.textContent = `Seguridad: ${strength}`;
        strengthDiv.className = `password-strength ${className}`;
      });

      passwordConfirm.addEventListener('input', function() {
        if (this.value === '') {
          matchDiv.textContent = '';
          return;
        }

        if (this.value === passwordInput.value) {
          matchDiv.innerHTML = '<i class="fas fa-check-circle"></i> Las contrase침as coinciden';
          matchDiv.style.color = '#28a745';
        } else {
          matchDiv.innerHTML = '<i class="fas fa-times-circle"></i> Las contrase침as no coinciden';
          matchDiv.style.color = '#dc3545';
        }
      });
    }

    // Preview de archivos mejorado
    const fileInputs = document.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => {
      input.addEventListener('change', function(e) {
        const file = this.files[0];
        if (!file) return;
        
        const previewId = this.id.replace('_', '-');
        const parentDiv = this.closest('.form-group');
        
        // Limpiar previews anteriores
        const oldPreviews = parentDiv.querySelectorAll('.file-preview-image, .file-preview-info');
        oldPreviews.forEach(el => el.remove());
        
        // Verificar tama침o (5MB m치ximo)
        const maxSize = 5 * 1024 * 1024; // 5MB en bytes
        if (file.size > maxSize) {
          Swal.fire({
            icon: 'error',
            title: 'Archivo muy grande',
            text: 'El archivo no debe superar los 5MB',
          });
          this.value = '';
          return;
        }
        
        // Formatear tama침o del archivo
        const formatSize = (bytes) => {
          if (bytes < 1024) return bytes + ' B';
          if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
          return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        };
        
        // Si es imagen, mostrar preview
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'file-preview-image';
            img.style.display = 'block';
            parentDiv.appendChild(img);
            
            // Agregar info del archivo
            const info = document.createElement('div');
            info.className = 'file-preview-info';
            info.style.display = 'flex';
            info.innerHTML = `
              <i class="fas fa-check-circle"></i>
              <div class="file-preview-details">
                <div class="file-preview-name">${file.name}</div>
                <div class="file-preview-size">${formatSize(file.size)}</div>
              </div>
            `;
            parentDiv.appendChild(info);
          };
          reader.readAsDataURL(file);
        } 
        // Si es PDF, mostrar info
        else if (file.type === 'application/pdf') {
          const info = document.createElement('div');
          info.className = 'file-preview-info';
          info.style.display = 'flex';
          info.innerHTML = `
            <i class="fas fa-file-pdf" style="color: #dc3545;"></i>
            <div class="file-preview-details">
              <div class="file-preview-name">${file.name}</div>
              <div class="file-preview-size">${formatSize(file.size)} - Documento PDF</div>
            </div>
          `;
          parentDiv.appendChild(info);
        }
      });
    });

    // Validaci칩n de fecha de nacimiento
    const fechaNacimientoInput = document.getElementById('fecha_nacimiento_nino');
    const errorEdadDiv = document.getElementById('error-edad');
    
    if (fechaNacimientoInput) {
      fechaNacimientoInput.addEventListener('change', function() {
        const fechaNacimiento = new Date(this.value);
        const hoy = new Date();
        
        // Calcular edad en a침os
        let edad = hoy.getFullYear() - fechaNacimiento.getFullYear();
        const mes = hoy.getMonth() - fechaNacimiento.getMonth();
        if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNacimiento.getDate())) {
          edad--;
        }
        
        // Calcular edad en meses
        let meses = (hoy.getFullYear() - fechaNacimiento.getFullYear()) * 12;
        meses -= fechaNacimiento.getMonth();
        meses += hoy.getMonth();
        if (hoy.getDate() < fechaNacimiento.getDate()) {
          meses--;
        }
        
        // Validar rangos
        if (meses < 12) {
          this.classList.add('error-edad');
          errorEdadDiv.style.display = 'block';
          errorEdadDiv.textContent = '丘멆잺 El ni침o debe tener al menos 12 meses de edad para matricularse.';
        } else if (edad > 5) {
          this.classList.add('error-edad');
          errorEdadDiv.style.display = 'block';
          errorEdadDiv.textContent = '丘멆잺 El ni침o supera los 5 a침os de edad. Solo se pueden matricular ni침os de 1 a 5 a침os.';
        } else {
          this.classList.remove('error-edad');
          errorEdadDiv.style.display = 'none';
          errorEdadDiv.textContent = '';
        }
      });
    }

    // Env칤o del formulario
    const form = document.getElementById('formularioMatricula');
    if (form) {
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Validar fecha de nacimiento antes de enviar
        if (fechaNacimientoInput && fechaNacimientoInput.classList.contains('error-edad')) {
          Swal.fire({
            icon: 'error',
            title: 'Edad no v치lida',
            text: errorEdadDiv.textContent.replace('丘멆잺 ', ''),
            confirmButtonColor: '#dc3545'
          });
          return;
        }

        // Validar contrase침as
        const password = document.getElementById('password');
        const passwordConf = document.getElementById('password_confirm');
        
        if (password && password.value !== passwordConf.value) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Las contrase침as no coinciden',
          });
          return;
        }

        // VALIDACI칍N: Si es correcci칩n, verificar que se cargaron archivos nuevos para campos marcados
        {% if en_correccion and campos_corregir %}
        const camposArchivos = ['foto_nino', 'carnet_vacunacion_nino', 'certificado_eps_nino', 'registro_civil_nino', 'documento_identidad_padre', 'clasificacion_sisben_padre'];
        const camposCorregir = {{ campos_corregir|safe }};
        const archivosCorregirPendientes = [];

        camposCorregir.forEach(campo => {
          if (camposArchivos.includes(campo)) {
            // Verificar si se carg칩 un archivo nuevo
            const inputId = campo.replace('_nino', '').replace('_padre', '').replace('documento_identidad', 'doc').replace('clasificacion_sisben', 'sisben').replace('carnet_vacunacion', 'carnet_vacunacion').replace('certificado_eps', 'certificado_eps').replace('registro_civil', 'registro_civil').replace('foto', 'foto_nino');
            
            const inputElement = document.getElementById(inputId);
            if (!inputElement || !inputElement.files || inputElement.files.length === 0) {
              // Obtener nombre legible del campo
              const nombresLegibles = {
                'foto_nino': 'Foto del Ni침o',
                'carnet_vacunacion_nino': 'Carnet de Vacunaci칩n',
                'certificado_eps_nino': 'Certificado EPS',
                'registro_civil_nino': 'Registro Civil',
                'documento_identidad_padre': 'Documento de Identidad del Acudiente',
                'clasificacion_sisben_padre': 'Clasificaci칩n SISBEN'
              };
              archivosCorregirPendientes.push(nombresLegibles[campo] || campo);
            }
          }
        });

        if (archivosCorregirPendientes.length > 0) {
          Swal.fire({
            icon: 'warning',
            title: 'Archivos por Corregir',
            html: `
              <p style="margin-bottom: 15px;">Debe cargar archivos nuevos para los siguientes campos marcados para correcci칩n:</p>
              <ul style="text-align: left; display: inline-block; color: #856404;">
                ${archivosCorregirPendientes.map(c => `<li><strong>${c}</strong></li>`).join('')}
              </ul>
              <p style="margin-top: 15px; color: #666;">Por favor, seleccione y cargue los archivos correctos antes de enviar.</p>
            `,
            confirmButtonText: 'Entendido',
            confirmButtonColor: '#f39c12'
          });
          return;
        }
        {% endif %}

        // Deshabilitar bot칩n
        const btnSubmit = document.getElementById('btnSubmit');
        btnSubmit.disabled = true;
        btnSubmit.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';

        // Enviar formulario
        const formData = new FormData(this);

        try {
          const response = await fetch(window.location.href, {
            method: 'POST',
            body: formData,
          });

          // Verificar si la respuesta es JSON v치lida
          let data;
          try {
            data = await response.json();
          } catch (jsonError) {
            throw new Error('El servidor no respondi칩 correctamente. Por favor, intenta nuevamente.');
          }

          // Verificar el estado de la respuesta
          if (response.ok && data.success) {
            Swal.fire({
              icon: 'success',
              title: '춰Solicitud Enviada Exitosamente!',
              html: `
                <p>${data.mensaje || 'Tu solicitud ha sido enviada correctamente.'}</p>
                <p class="mt-2"><strong>El hogar comunitario la revisar치 pronto.</strong></p>
                <p class="text-muted">Recibir치s un correo electr칩nico con la respuesta.</p>
              `,
              confirmButtonText: 'Entendido',
              confirmButtonColor: '#667eea',
              allowOutsideClick: false,
            }).then(() => {
              // Mostrar mensaje de cierre
              window.location.reload();
            });
          } else {
            // Error del servidor o validaci칩n
            Swal.fire({
              icon: 'error',
              title: 'No se pudo enviar la solicitud',
              html: `
                <p>${data.error || 'Hubo un problema al procesar tu solicitud.'}</p>
                <p class="mt-2 text-muted">Por favor, verifica los datos e intenta nuevamente.</p>
              `,
              confirmButtonText: 'Reintentar',
              confirmButtonColor: '#d33',
            });
            btnSubmit.disabled = false;
            btnSubmit.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Solicitud';
          }
        } catch (error) {
          console.error('Error al enviar solicitud:', error);
          Swal.fire({
            icon: 'error',
            title: 'Error de Conexi칩n',
            html: `
              <p>No se pudo conectar con el servidor.</p>
              <p class="mt-2"><strong>Posibles causas:</strong></p>
              <ul class="text-left" style="display: inline-block;">
                <li>Problema de conexi칩n a internet</li>
                <li>El servidor no est치 disponible</li>
                <li>Tiempo de espera agotado</li>
              </ul>
              <p class="mt-2 text-danger"><strong>Por favor, intenta nuevamente.</strong></p>
            `,
            confirmButtonText: 'Reintentar',
            confirmButtonColor: '#d33',
          });
          btnSubmit.disabled = false;
          btnSubmit.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Solicitud';
        }
      });
    }

    // Funci칩n para cancelar la solicitud
    async function cancelarSolicitud() {
      const result = await Swal.fire({
        title: '쮺ancelar Solicitud?',
        html: `
          <p>쮼st치 seguro que desea cancelar esta solicitud de matriculaci칩n?</p>
          <p class="text-danger"><strong>Esta acci칩n no se puede deshacer.</strong></p>
          <textarea id="motivoCancelacion" class="swal2-textarea" placeholder="Motivo de cancelaci칩n (opcional)" style="width: 100%; margin-top: 15px;"></textarea>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'S칤, Cancelar',
        cancelButtonText: 'No, Volver',
        preConfirm: () => {
          return document.getElementById('motivoCancelacion').value;
        }
      });

      if (result.isConfirmed) {
        try {
          const formData = new FormData();
          formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
          formData.append('motivo', result.value || '');

          const response = await fetch('{% url "cancelar_solicitud_usuario" token=solicitud.token %}', {
            method: 'POST',
            body: formData,
          });

          const data = await response.json();

          if (response.ok && data.success) {
            Swal.fire({
              icon: 'success',
              title: 'Solicitud Cancelada',
              text: data.mensaje || 'Su solicitud ha sido cancelada exitosamente.',
              confirmButtonColor: '#667eea',
              allowOutsideClick: false,
            }).then(() => {
              window.location.reload();
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: data.error || 'No se pudo cancelar la solicitud.',
              confirmButtonColor: '#d33',
            });
          }
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'Error de Conexi칩n',
            text: 'No se pudo conectar con el servidor. Intente nuevamente.',
            confirmButtonColor: '#d33',
          });
        }
      }
    }
  </script>
  
  <!-- 游 Script de Geograf칤a de Colombia -->
  {% load static %}
  <script src="{% static 'js/geografia_colombia.js' %}"></script>
  <script>
    // Configuraci칩n espec칤fica para formulario p칰blico (ID de padre)
    document.addEventListener('DOMContentLoaded', function() {
      // Inicializar geograf칤a para campos de padre
      initGeografiaColombia({
        departamentoSelector: '#id_departamento_padre',
        municipioSelector: '#id_ciudad_padre',
        localidadSelector: '#id_localidad_bogota_padre',
        localidadContainer: '#localidad-padre-group',
      });
      
      // Preseleccionar valores si existen (modo edici칩n/correcci칩n)
      {% if solicitud.departamento_padre_id %}
        document.getElementById('id_departamento_padre').value = '{{ solicitud.departamento_padre_id }}';
        document.getElementById('id_departamento_padre').dataset.selectedId = '{{ solicitud.departamento_padre_id }}';
      {% endif %}
      
      {% if solicitud.ciudad_padre_id %}
        document.getElementById('id_ciudad_padre').dataset.selectedId = '{{ solicitud.ciudad_padre_id }}';
      {% endif %}
      
      {% if solicitud.localidad_bogota_padre_id %}
        document.getElementById('id_localidad_bogota_padre').dataset.selectedId = '{{ solicitud.localidad_bogota_padre_id }}';
      {% endif %}
    });
  </script>
</body>
</html>
