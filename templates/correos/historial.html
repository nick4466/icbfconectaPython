{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Correos</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <style>
        body {
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background-image: url("{% static 'img/fondito.jpg' %}");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        header{
            background-color: rgba(255, 255, 255, 0.85);
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid #e5d5f5;
            backdrop-filter: blur(4px);
        }

        header img {
            height: 60px;
        }

        nav ul {
            list-style: none;
            display: flex;
            gap: 20px;
            padding: 0;
            margin: 0;
        }

        nav ul li a, nav ul li button {
            text-decoration: none;
            color: #9B59B6;
            font-weight: bold;
            font-size: 16px;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.3s ease;
            background: none;
            border: none;
            cursor: pointer;
            font-family: 'Roboto', sans-serif;
        }

        nav ul li a:hover, nav ul li button:hover {
            background-color: #f3c1e5;
        }

        nav ul .dropdown { position: relative; }
        nav ul .dropdown-content {
            display: none;
            position: absolute;
            background-color: rgba(255, 255, 255, 0.98);
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 8px;
            padding: 8px 0;
        }
        nav ul .dropdown-content a { color: #9B59B6; padding: 12px 16px; text-decoration: none; display: block; }
        nav ul .dropdown-content a:hover { background-color: #f3c1e5; }
        nav ul .dropdown:hover .dropdown-content { display: block; }


        .container {
            max-width: 1100px;
            margin: 40px auto;
            background-color: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 14px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #7a3eb1;
            font-size: 32px;
            margin-bottom: 25px;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
            font-size: 16px;
        }

        thead {
            background-color: #6d178d;
            color: white;
            font-weight: 700;
        }

        thead th {
            padding: 14px;
            text-transform: uppercase;
            font-size: 15px;
        }

        tbody tr {
            background-color: #ffffff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            border-radius: 8px;
        }

        tbody td {
            padding: 12px;
            font-size: 15px;
            color: #444;
            vertical-align: top;
        }

        tbody tr:hover {
            background-color: #f6e6ff !important;
            transform: scale(1.01);
            transition: 0.2s;
        }

        .btn {
            background-color: #921fc0;
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: background-color 0.3s ease;
        }

        .btn:hover {
            background-color: #b931d1;
        }

        .btn-delete {
            background-color: #dc3545 !important;
            color: white !important;
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-delete:hover {
            background-color: #a00 !important;
        }

        .status.success { color: green; font-weight: bold; }
        .status.error { color: red; font-weight: bold; }

        .messages {
            margin-bottom: 20px;
            padding: 12px;
            background-color: #e6ffe6;
            color: #2a662a;
            border-radius: 8px;
        }

        .destinatarios-lista {
            list-style: none;
            padding-left: 0;
        }
        .destinatarios-lista li {
            margin-bottom: 4px;
        }

        /* Contenedor superior filtro + vaciar */
        .top-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

    </style>
</head>

<body>

<header>
    <img src="{% static 'img/logoSinFondo.png' %}" alt="Logo">
    <nav>
      <ul>
        <li><a href="{% url 'madre_dashboard' %}"><i class="fas fa-home"></i> Inicio</a></li>
        <li><a href="{% url 'listar_ninos' %}"><i class="fas fa-user-graduate"></i> Matrículas</a></li>
        <li><a href="{% url 'planeaciones:lista_planeaciones' %}"><i class="fas fa-book"></i> Planeaciones</a></li>
        <li><a href="{% url 'gestion_ninos' %}"><i class="fas fa-child"></i> Gestión De Niños</a></li>
        <li class="dropdown">
          <a href="javascript:void(0)"><i class="fas fa-cog"></i> Ajustes</a>
          <div class="dropdown-content">
            <a href="{% url 'editar_perfil' %}"><i class="fa-solid fa-user-pen"></i> Editar Perfil</a>
            <a href="{% url 'cambiar_contrasena' %}"><i class="fa-solid fa-key"></i> Cambiar Contraseña</a>
          </div>
        </li>
        <li>
            <form method="post" action="{% url 'logout' %}" style="display: inline;">
                {% csrf_token %}
                <button type="submit"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</button>
            </form>
        </li>
      </ul>
    </nav>
</header>

<div class="container">

    <h1>Historial de Correos</h1>

    {% if messages %}
    <div class="messages">
        {% for message in messages %}
            <p>{{ message }}</p>
        {% endfor %}
    </div>
    {% endif %}

    <!-- FILTRO + VACIAR -->
    <div class="top-actions">

        <!-- FILTRAR -->
        <form method="GET">
            <input type="month" name="mes" value="{{ request.GET.mes }}">
            <button type="submit" class="btn"><i class="fas fa-filter"></i> Filtrar</button>
        </form>

        <!-- VACIAR HISTORIAL -->
        <form action="{% url 'correos:vaciar_historial' %}" method="POST"
              onsubmit="return confirm('¿Estás seguro de vaciar todo el historial?');">
            {% csrf_token %}
            <button type="submit" class="btn-delete">
                <i class="fas fa-trash-alt"></i> Vaciar historial
            </button>
        </form>

    </div>

    <table>
        <thead>
            <tr>
                <th>Asunto</th>
                <th>Destinatarios</th>
                <th>Fecha</th>
                <th>Adjuntos</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>

        <tbody>
            {% for log in logs %}
            <tr>
                <td>{{ log.asunto }}</td>

                <!-- LISTA DE DESTINATARIOS BONITA -->
                <td>
                    <ul class="destinatarios-lista">
                        {% for email in log.lista_destinatarios %}
                            <li>{{ email }}</li>
                        {% endfor %}
                    </ul>
                </td>

                <td>{{ log.fecha_envio|date:"d/m/Y H:i" }}</td>

                <td>
                    {% if log.adjuntos.exists %}
                        {% for adj in log.adjuntos.all %}
                            <a href="{{ adj.archivo.url }}" target="_blank">{{ adj.nombre_original }}</a><br>
                        {% endfor %}
                    {% else %}
                        Sin adjuntos
                    {% endif %}
                </td>

                <td class="status {% if log.enviado_con_exito %}success{% else %}error{% endif %}">
                    {% if log.enviado_con_exito %}
                        Enviado
                    {% else %}
                        Error
                    {% endif %}
                </td>

                <td>
                    <form method="POST" action="{% url 'correos:eliminar_log' log.id %}"
                          onsubmit="return confirm('¿Eliminar este registro?');">
                        {% csrf_token %}
                        <button class="btn-delete"><i class="fas fa-trash-alt"></i> Eliminar</button>
                    </form>
                </td>
            </tr>

            {% empty %}
            <tr>
                <td colspan="6" style="text-align:center;">No hay registros.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <br>

    <a href="{% url 'correos:enviar' %}" class="btn">
        <i class="fas fa-paper-plane"></i> Enviar nuevo correo
    </a>

</div>

</body>
</html>
