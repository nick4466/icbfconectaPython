{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agendar Visita Técnica</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Poppins",sans-serif;background:#f3f6fa;color:#333}
    .container{max-width:900px;margin:40px auto;padding:0 20px}
    .header{background:linear-gradient(135deg,#004080,#007bff);color:white;padding:30px;border-radius:12px 12px 0 0;box-shadow:0 4px 15px rgba(0,0,0,0.1)}
    .header h1{font-size:28px;margin-bottom:10px;display:flex;align-items:center;gap:15px}
    .header p{opacity:0.9;font-size:16px}
    .hogar-info{background:white;padding:25px;border-left:5px solid #007bff;margin-bottom:30px;box-shadow:0 2px 10px rgba(0,0,0,0.08);border-radius:8px}
    .hogar-info h2{color:#004080;margin-bottom:15px;font-size:20px}
    .hogar-info .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px}
    .hogar-info .info-item{display:flex;align-items:start;gap:10px}
    .hogar-info .info-item i{color:#007bff;margin-top:3px}
    .hogar-info .info-item strong{color:#555;min-width:100px}
    .form-container{background:white;padding:35px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.1)}
    .form-group{margin-bottom:25px}
    .form-group label{display:block;font-weight:600;color:#333;margin-bottom:8px;font-size:15px}
    .form-group label i{margin-right:8px;color:#007bff}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:12px 15px;border:2px solid #e0e0e0;border-radius:8px;font-family:"Poppins",sans-serif;font-size:14px;transition:border-color .3s}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:#007bff;outline:none}
    .form-group textarea{resize:vertical;min-height:100px}
    .form-group small{color:#666;font-size:13px;margin-top:5px;display:block}
    .form-group .error{color:#dc3545;font-size:13px;margin-top:5px;display:block}
    .form-actions{display:flex;gap:15px;justify-content:flex-end;margin-top:30px;padding-top:20px;border-top:2px solid #e0e0e0}
    .btn{padding:12px 28px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:15px;text-decoration:none;display:inline-flex;align-items:center;gap:10px;transition:all .3s}
    .btn-primary{background:#007bff;color:white}
    .btn-primary:hover{background:#0056b3;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,123,255,0.3)}
    .btn-secondary{background:#6c757d;color:white}
    .btn-secondary:hover{background:#5a6268}
    .alert{padding:15px 20px;border-radius:8px;margin-bottom:20px;display:flex;align-items:center;gap:12px}
    .alert i{font-size:20px}
    .alert.info{background:#d1ecf1;color:#0c5460;border-left:4px solid #0c5460}
    .alert.error{background:#f8d7da;color:#721c24;border-left:4px solid #721c24}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-calendar-plus"></i> Agendar Visita Técnica</h1>
      <p>Complete los datos para programar la visita técnica V1 al hogar comunitario</p>
    </div>

    <!-- Información del Hogar -->
    <div class="hogar-info">
      <h2><i class="fas fa-home"></i> {{ hogar.nombre_hogar }}</h2>
      <div class="info-grid">
        <div class="info-item">
          <i class="fas fa-user"></i>
          <div>
            <strong>Agente Educativo:</strong><br>
            {{ hogar.madre.usuario.nombres }} {{ hogar.madre.usuario.apellidos }}
          </div>
        </div>
        <div class="info-item">
          <i class="fas fa-phone"></i>
          <div>
            <strong>Teléfono:</strong><br>
            {{ hogar.madre.usuario.telefono }}
          </div>
        </div>
        <div class="info-item">
          <i class="fas fa-envelope"></i>
          <div>
            <strong>Email:</strong><br>
            {{ hogar.madre.usuario.email }}
          </div>
        </div>
        <div class="info-item">
          <i class="fas fa-map-marker-alt"></i>
          <div>
            <strong>Ubicación:</strong><br>
            {{ hogar.direccion }}, {{ hogar.ciudad.nombre }}
          </div>
        </div>
      </div>
    </div>

    <!-- Mensajes -->
    {% if messages %}
      {% for message in messages %}
        <div class="alert {% if message.tags == 'error' %}error{% else %}info{% endif %}">
          <i class="fas fa-{% if message.tags == 'error' %}exclamation-circle{% else %}info-circle{% endif %}"></i>
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    <!-- Formulario -->
    <div class="form-container">
      <form method="post" id="agendarForm">
        {% csrf_token %}
        
        <div class="alert info">
          <i class="fas fa-info-circle"></i>
          <div>
            Al agendar la visita, se enviará automáticamente un correo electrónico al agente educativo 
            con la fecha y hora programadas.
          </div>
        </div>

        <div class="form-group">
          <label for="{{ form.fecha_programada.id_for_label }}">
            <i class="fas fa-calendar-alt"></i> Fecha y Hora de la Visita
          </label>
          {{ form.fecha_programada }}
          <small>Seleccione la fecha y hora en que se realizará la visita técnica</small>
          {% if form.fecha_programada.errors %}
            {% for error in form.fecha_programada.errors %}
              <span class="error">{{ error }}</span>
            {% endfor %}
          {% endif %}
        </div>

        <div class="form-group">
          <label for="{{ form.visitador.id_for_label }}">
            <i class="fas fa-user-tie"></i> Visitador Asignado
          </label>
          {{ form.visitador }}
          <small>Administrador que realizará la visita técnica</small>
          {% if form.visitador.errors %}
            {% for error in form.visitador.errors %}
              <span class="error">{{ error }}</span>
            {% endfor %}
          {% endif %}
        </div>

        <div class="form-group">
          <label for="{{ form.tipo_visita.id_for_label }}">
            <i class="fas fa-clipboard-check"></i> Tipo de Visita
          </label>
          {{ form.tipo_visita }}
          <small>V1: Primera visita de habilitación (por defecto)</small>
          {% if form.tipo_visita.errors %}
            {% for error in form.tipo_visita.errors %}
              <span class="error">{{ error }}</span>
            {% endfor %}
          {% endif %}
        </div>

        <div class="form-group">
          <label for="{{ form.observaciones.id_for_label }}">
            <i class="fas fa-comment-alt"></i> Observaciones (Opcional)
          </label>
          {{ form.observaciones }}
          <small>Notas adicionales sobre la visita</small>
          {% if form.observaciones.errors %}
            {% for error in form.observaciones.errors %}
              <span class="error">{{ error }}</span>
            {% endfor %}
          {% endif %}
        </div>

        <div class="form-actions">
          <a href="{% url 'listar_hogares_pendientes_visita' %}" class="btn btn-secondary">
            <i class="fas fa-times"></i> Cancelar
          </a>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-paper-plane"></i> Agendar y Enviar Correo
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Configurar input de fecha para datetime-local
    document.addEventListener('DOMContentLoaded', function() {
      const fechaInput = document.querySelector('input[name="fecha_programada"]');
      if (fechaInput && fechaInput.type !== 'datetime-local') {
        fechaInput.type = 'datetime-local';
        
        // Establecer mínimo a la fecha actual
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        fechaInput.min = now.toISOString().slice(0, 16);
      }
    });

    // Validación del formulario
    document.getElementById('agendarForm').addEventListener('submit', function(e) {
      const fechaInput = document.querySelector('input[name="fecha_programada"]');
      const visitadorSelect = document.querySelector('select[name="visitador"]');
      
      if (!fechaInput.value) {
        e.preventDefault();
        alert('Por favor seleccione la fecha y hora de la visita');
        fechaInput.focus();
        return;
      }
      
      if (!visitadorSelect.value) {
        e.preventDefault();
        alert('Por favor seleccione el visitador asignado');
        visitadorSelect.focus();
        return;
      }
      
      // Confirmar antes de enviar
      if (!confirm('¿Está seguro de agendar esta visita? Se enviará un correo electrónico al agente educativo.')) {
        e.preventDefault();
      }
    });
  </script>
</body>
</html>
