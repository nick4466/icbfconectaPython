{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ICBF Conecta - Gestión de Hogares</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Poppins", sans-serif;
      background-color: #f3f6fa;
      color: #333;
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 250px;
      background: linear-gradient(180deg, #004080, #007bff);
      color: white;
      display: flex;
      flex-direction: column;
      padding: 25px 0;
      box-shadow: 3px 0 12px rgba(0,0,0,0.1);
    }

    .sidebar img {
      height: 70px;
      margin: 0 auto 20px;
    }

    .sidebar h2 {
      text-align: center;
      font-weight: 700;
      margin-bottom: 25px;
      font-size: 18px;
      letter-spacing: 1px;
    }

    .sidebar a {
      color: white;
      text-decoration: none;
      padding: 14px 25px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 500;
      transition: background 0.3s ease;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background: rgba(255, 255, 255, 0.15);
      border-left: 4px solid #ffffff;
    }

    .sidebar .dropdown { position: relative; }
    .sidebar .dropdown .dropdown-menu {
      display: none;
      position: absolute;
      left: 100%;
      top: 0;
      background-color: #004080;
      min-width: 200px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      z-index: 1;
      border-radius: 0 8px 8px 0;
    }
    .sidebar .dropdown:hover .dropdown-menu { display: block; }
    .sidebar .dropdown-menu a {
      padding: 12px 16px;
      border-left: none !important;
    }

    .sidebar .logout {
      margin-top: auto;
      border-top: 1px solid rgba(255,255,255,0.2);
      padding-top: 15px;
    }

    /* Main content */
    .main {
      flex: 1;
      padding: 40px;
      overflow-y: auto;
    }

    .main header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .main header h1 {
      font-size: 28px;
      color: #004080;
      font-weight: 700;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-left: 5px solid;
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .stat-card.pendiente { border-left-color: #ffc107; }
    .stat-card.revision { border-left-color: #17a2b8; }
    .stat-card.aprobado { border-left-color: #28a745; }
    .stat-card.alerta { border-left-color: #dc3545; }

    .stat-number {
      font-size: 36px;
      font-weight: bold;
      margin: 10px 0;
      color: #004080;
    }

    .stat-label {
      color: #666;
      font-size: 14px;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Filters Section */
    .filters-section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .filter-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-group select,
    .filter-group input[type="text"] {
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      font-family: 'Poppins', sans-serif;
    }

    .filter-group input[type="text"] {
      flex: 1;
      min-width: 250px;
    }

    .btn-filter {
      background: #004080;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      text-decoration: none;
      display: inline-block;
    }

    .btn-filter:hover {
      background: #0066cc;
    }

    /* Table */
    .hogares-table {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .hogares-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .hogares-table th {
      background: #f8f9fa;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: #004080;
      border-bottom: 2px solid #dee2e6;
      font-size: 14px;
    }

    .hogares-table td {
      padding: 15px;
      border-bottom: 1px solid #dee2e6;
      font-size: 14px;
    }

    .hogares-table tr:hover {
      background: #f8f9fa;
    }

    .badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      display: inline-block;
    }

    .badge.pendiente_visita {
      background: #fff3cd;
      color: #856404;
    }

    .badge.en_revision {
      background: #d1ecf1;
      color: #0c5460;
    }

    .badge.aprobado {
      background: #d4edda;
      color: #155724;
    }

    .badge.rechazado {
      background: #f8d7da;
      color: #721c24;
    }

    .badge.pendiente_revision {
      background: #fff3cd;
      color: #856404;
    }

    .alerta-visita {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 8px 12px;
      margin-top: 8px;
      border-radius: 5px;
      font-size: 12px;
      display: inline-block;
    }

    .btn-accion {
      padding: 6px 12px;
      border-radius: 5px;
      text-decoration: none;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-block;
      margin: 2px;
      border: none;
      cursor: pointer;
    }

    .btn-detalle {
      background: #6c757d;
      color: white;
    }

    .btn-detalle:hover {
      background: #545b62;
    }

    /* Paginación */
    .pagination {
      text-align: center;
      margin-top: 20px;
    }

    .pagination a,
    .pagination span {
      padding: 8px 12px;
      margin: 2px;
      background: #007bff;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      display: inline-block;
      transition: background 0.3s ease;
    }

    .pagination span {
      background: #6c757d;
    }

    .pagination a:hover {
      background: #0056b3;
    }

    /* Responsive */
    @media (max-width: 800px) {
      body {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        height: auto;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
        padding: 10px 0;
      }
      .sidebar h2, .sidebar img {
        display: none;
      }
      .main {
        padding: 20px;
      }
      .stats-grid {
        grid-template-columns: 1fr;
      }
      .filter-group {
        flex-direction: column;
        align-items: stretch;
      }
      .hogares-table {
        overflow-x: auto;
      }
    }
  </style>
</head>

<body>
  <!-- SIDEBAR -->
  <div class="sidebar">
    <img src="{% static 'img/logoSinFondo.png' %}" alt="Logo ICBF" />
    <h2>ICBF Conecta</h2>
    <a href="{% url 'dashboard_admin' %}"><i class="fa-solid fa-tachometer-alt"></i> Inicio</a>
    <a href="{% url 'hogares_dashboard' %}" class="active"><i class="fa-solid fa-home"></i> Hogares</a>
    <a href="{% url 'listar_madres' %}"><i class="fa-solid fa-user-group"></i> Agentes Educativos</a>
    <a href="{% url 'listar_administradores' %}"><i class="fa-solid fa-user-shield"></i> Administradores</a>
    <a href="{% url 'admin_reportes' %}"><i class="fa-solid fa-chart-line"></i> Reportes</a>
    <div class="dropdown">
      <a href="#"><i class="fa-solid fa-cog"></i> Ajustes</a>
      <div class="dropdown-menu">
        <a href="{% url 'editar_perfil' %}"><i class="fa-solid fa-user-pen"></i> Editar Perfil</a>
        <a href="{% url 'cambiar_contrasena' %}"><i class="fa-solid fa-key"></i> Cambiar Contraseña</a>
      </div>
    </div>

    <div class="logout">
        <form method="post" action="{% url 'logout' %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit" style="background: none; border: none; color: white; cursor: pointer; padding: 14px 25px; display: flex; align-items: center; gap: 10px; font-family: 'Poppins', sans-serif; font-size: 16px; font-weight: 500; width: 100%; text-align: left;">
                <i class="fa-solid fa-right-from-bracket"></i> Cerrar sesión
            </button>
        </form>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main">
    <header>
      <h1><i class="fas fa-home"></i> Gestión de Hogares Comunitarios</h1>
      <span>Bienvenido, {{ user.nombres|default:'Admin' }}</span>
    </header>

    <!-- Estadísticas -->
    <div class="stats-grid">
      <div class="stat-card pendiente">
        <div class="stat-label">
          <i class="fas fa-clock"></i> Pendientes de Visita
        </div>
        <div class="stat-number">{{ pendientes_count }}</div>
      </div>

      <div class="stat-card revision">
        <div class="stat-label">
          <i class="fas fa-search"></i> En Revisión
        </div>
        <div class="stat-number">{{ revision_count }}</div>
      </div>

      <div class="stat-card aprobado">
        <div class="stat-label">
          <i class="fas fa-check-circle"></i> Aprobados
        </div>
        <div class="stat-number">{{ aprobados_count }}</div>
      </div>

      <div class="stat-card alerta">
        <div class="stat-label">
          <i class="fas fa-exclamation-triangle"></i> Sin Visita (+1 año)
        </div>
        <div class="stat-number">{{ alertas_count }}</div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filters-section">
      <form method="GET" class="filter-group">
        <select name="estado" id="estado_filter">
          <option value="">Todos los estados</option>
          <option value="pendiente_visita" {% if filtro_estado == 'pendiente_visita' %}selected{% endif %}>Pendiente de Visita</option>
          <option value="en_revision" {% if filtro_estado == 'en_revision' %}selected{% endif %}>En Revisión</option>
          <option value="aprobado" {% if filtro_estado == 'aprobado' %}selected{% endif %}>Aprobado</option>
          <option value="rechazado" {% if filtro_estado == 'rechazado' %}selected{% endif %}>Rechazado</option>
          <option value="alertas" {% if filtro_estado == 'alertas' %}selected{% endif %}>Con Alertas (Sin visita 1 año)</option>
        </select>

        <input type="text" name="search" placeholder="Buscar por nombre, madre o documento..." value="{{ busqueda }}">

        <button type="submit" class="btn-filter">
          <i class="fas fa-filter"></i> Filtrar
        </button>

        <a href="{% url 'hogares_dashboard' %}" class="btn-filter" style="background:#6c757d;">
          <i class="fas fa-redo"></i> Limpiar
        </a>
      </form>
    </div>

    <!-- Tabla de Hogares -->
    <div class="hogares-table">
      <table>
        <thead>
          <tr>
            <th>Hogar</th>
            <th>Agente Educativo</th>
            <th>Regional / Ciudad</th>
            <th>Estado</th>
            <th>Fecha Creación</th>
            <th>Próxima Visita</th>
            <th>Última Visita</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for item in page_obj %}
          <tr {% if item.tiene_alerta %}style="background:#fff3cd;"{% endif %}>
            <td>
              <strong>{{ item.hogar.nombre_hogar }}</strong><br>
              <small style="color:#666;">{{ item.hogar.direccion }}</small>
            </td>
            <td>
              {{ item.madre_nombre }}<br>
              <small style="color:#666;">{{ item.madre_documento }}</small>
            </td>
            <td>
              {% if item.hogar.regional %}
                {{ item.hogar.regional.nombre }}<br>
                <small style="color:#666;">{{ item.hogar.ciudad.nombre }}</small>
              {% else %}
                <span style="color:#999;">No especificado</span>
              {% endif %}
            </td>
            <td>
              <span class="badge {{ item.hogar.estado }}">
                {{ item.hogar.get_estado_display }}
              </span>
            </td>
            <td>
              {% if item.hogar.fecha_registro %}
                {{ item.hogar.fecha_registro|date:"d/m/Y" }}
              {% else %}
                <span style="color:#999;">N/A</span>
              {% endif %}
            </td>
            <td>
              {% if item.proxima_visita %}
                <strong>{{ item.proxima_visita.fecha_programada|date:"d/m/Y" }}</strong><br>
                <small style="color:#666;">{{ item.proxima_visita.get_tipo_visita_display }}</small>
              {% else %}
                <span style="color:#dc3545;">Sin programar</span>
              {% endif %}
            </td>
            <td>
              {% if item.ultima_visita %}
                {{ item.ultima_visita.fecha_realizada|date:"d/m/Y" }}
              {% else %}
                <span style="color:#999;">Nunca</span>
              {% endif %}
            </td>
            <td>
              <a href="{% url 'detalle_hogar' item.hogar.id %}" class="btn-accion btn-detalle">
                <i class="fas fa-eye"></i> Ver Detalles
              </a>

              {% if item.proxima_visita and item.proxima_visita.estado == 'agendada' %}
                {% if item.proxima_visita.fecha_programada.date <= today %}
                  <a href="{% url 'realizar_visita_tecnica' item.hogar.id %}" class="btn-accion" style="background:#28a745;color:white;">
                    <i class="fas fa-clipboard-check"></i> Realizar Visita
                  </a>
                {% else %}
                  <small style="color:#666;display:block;margin-top:5px;">
                    Visita programada: {{ item.proxima_visita.fecha_programada|date:"d/m/Y" }}
                  </small>
                {% endif %}
              {% else %}
                <a href="{% url 'programar_visita' item.hogar.id %}" class="btn-accion" style="background:#ffc107;color:#000;">
                  <i class="fas fa-calendar-plus"></i> Programar Visita
                </a>
              {% endif %}

              {% if item.tiene_alerta %}
                <div class="alerta-visita">
                  <i class="fas fa-exclamation-triangle"></i> 
                  Sin visita hace más de 1 año
                </div>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" style="text-align:center; padding:40px; color:#999;">
              <i class="fas fa-inbox" style="font-size:48px;"></i><br><br>
              No se encontraron hogares con los filtros seleccionados
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    {% if page_obj.has_other_pages %}
    <div class="pagination">
      {% if page_obj.has_previous %}
        <a href="?page=1{% if filtro_estado %}&estado={{ filtro_estado }}{% endif %}{% if busqueda %}&search={{ busqueda }}{% endif %}">Primero</a>
        <a href="?page={{ page_obj.previous_page_number }}{% if filtro_estado %}&estado={{ filtro_estado }}{% endif %}{% if busqueda %}&search={{ busqueda }}{% endif %}">Anterior</a>
      {% endif %}

      <span>
        Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
      </span>

      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if filtro_estado %}&estado={{ filtro_estado }}{% endif %}{% if busqueda %}&search={{ busqueda }}{% endif %}">Siguiente</a>
        <a href="?page={{ page_obj.paginator.num_pages }}{% if filtro_estado %}&estado={{ filtro_estado }}{% endif %}{% if busqueda %}&search={{ busqueda }}{% endif %}">Último</a>
      {% endif %}
    </div>
    {% endif %}

  </div>
</body>
</html>
