{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% if modo_edicion %}Editar{% else %}Crear{% endif %} Agente Educativo</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Poppins",sans-serif;background:#f3f6fa;color:#333;display:flex;min-height:100vh}
    .sidebar{width:250px;background:linear-gradient(180deg,#004080,#007bff);color:white;display:flex;flex-direction:column;padding:25px 0}
    .sidebar img{height:70px;margin:0 auto 20px}
    .sidebar h2{text-align:center;font-weight:700;margin-bottom:25px;font-size:18px}
    .sidebar a{color:white;text-decoration:none;padding:14px 25px;display:flex;align-items:center;gap:10px;font-weight:500;transition:background .3s ease}
    .sidebar a:hover,.sidebar a.active{background:rgba(255,255,255,0.15);border-left:4px solid #fff}
    .sidebar .dropdown{position:relative}
    .sidebar .dropdown-menu{display:none;position:absolute;left:100%;top:0;background:#004080;min-width:200px;box-shadow:0 8px 16px rgba(0,0,0,.2);z-index:1;border-radius:0 8px 8px 0}
    .sidebar .dropdown:hover .dropdown-menu{display:block}
    .sidebar .dropdown-menu a{padding:12px 16px;border-left:none!important}
    .main{flex:1;padding:40px;max-width:1200px;margin:0 auto}
    .main header{display:flex;justify-content:space-between;align-items:center;margin-bottom:40px}
    .main header h1{font-size:28px;color:#004080;font-weight:700}
    
    /* Contenedor de formulario centrado - más ancho para dos columnas */
    .step-form{max-width:1400px;margin:0 auto;background:white;padding:30px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.08)}
    
    /* Sistema de grid de dos columnas */
    .two-column-grid{display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-bottom:30px}
    .full-width{grid-column:1 / -1}
    
    /* Paneles con borde */
    .column-panel{background:#f8f9fa;padding:20px;border-radius:8px;border:1px solid #e0e0e0}
    .column-panel h4{color:#004080;margin:0 0 15px 0;font-size:16px;border-left:4px solid #007bff;padding-left:10px}
    
    .form-group{margin-bottom:24px}
    form label{font-weight:600;color:#555;margin-bottom:8px;font-size:14px;display:block}
    form input, form select, form textarea{width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;font-family:"Poppins",sans-serif;font-size:15px;transition:all 0.3s ease}
    form input:focus, form select:focus, form textarea:focus{border-color:#007bff;box-shadow:0 0 0 3px rgba(0,123,255,.15);outline:none}
    form input[type="file"]{padding:8px;background:#f8f9fa;border:2px dashed #ccc;cursor:pointer}
    form input[type="file"]:hover{border-color:#007bff;background:#f0f7ff}
    
    /* Vista previa de archivos */
    .file-preview-container{margin-top:15px;padding:15px;background:#f8f9fa;border-radius:8px;border:1px solid #e0e0e0}
    .file-preview-container img{max-width:100%;max-height:300px;border-radius:8px;display:block;margin:0 auto}
    .file-preview-container iframe{width:100%;height:400px;border:none;border-radius:8px}
    .file-preview-container .pdf-icon{text-align:center;padding:20px}
    .file-preview-container .pdf-icon i{font-size:64px;color:#dc3545;margin-bottom:10px}
    .file-preview-container .file-name{font-size:14px;color:#666;margin-top:10px;text-align:center;word-break:break-all}
    .remove-file-btn{background:#dc3545;color:white;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;margin-top:10px;display:block;margin-left:auto;margin-right:auto}
    .remove-file-btn:hover{background:#c82333}
    .form-actions{margin-top:30px;display:flex;gap:15px;justify-content:flex-end}
    .btn-guardar,.btn-volver{padding:10px 28px;border:none;border-radius:6px;color:white;font-weight:600;font-size:16px;cursor:pointer;transition:background .2s}
    .btn-guardar{background:linear-gradient(90deg,#28a745,#218838)}
    .btn-volver{background:#6c757d}
    .btn-volver:hover{background:#495057}
    .btn-guardar:hover{background:#218838}
    .messages{list-style:none;padding:0;margin:0 0 20px 0}
    .messages li{padding:12px;border-radius:6px;margin-bottom:8px;color:white;font-weight:500;display:flex;justify-content:space-between;align-items:center}
    .messages li.success{background:#28a745}
    .messages li.error{background:#dc3545}
    .close-message{background:none;border:none;color:white;font-size:20px;cursor:pointer}
    .required-star{color:#dc3545;margin-left:4px;font-weight:bold}
    
    /* Indicadores de pasos mejorados */
    .step-indicators{display:flex;justify-content:center;gap:20px;margin-bottom:40px;padding:20px;background:white;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}
    .step-indicator{display:flex;align-items:center;gap:10px;padding:12px 24px;border-radius:8px;background:#f8f9fa;color:#999;font-weight:600;transition:all 0.3s ease}
    .step-indicator.active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;box-shadow:0 4px 15px rgba(102,126,234,0.4)}
    .step-indicator.completed{background:#28a745;color:white}
    .step-indicator i{font-size:20px}
    
    /* Alertas de validación */
    .alert-warning{animation:fadeIn 0.3s ease-in}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}

    /* --- ESTILOS RESPONSIVOS --- */
    @media (max-width: 992px) {
      body {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        height: auto;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
      }
      .sidebar h2, .sidebar img {
        display: none; /* Ocultar elementos no esenciales */
      }
      .sidebar a {
        border-left: none;
        border-bottom: 4px solid transparent;
      }
      .sidebar a:hover, .sidebar a.active {
        border-left: none;
        border-bottom: 4px solid #ffffff;
      }
      .main {
        padding: 20px;
      }
      .form-actions {
        flex-direction: column;
      }
      /* Responsive para dos columnas */
      .two-column-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      .step-form {
        max-width: 100%;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <img src="{% static 'img/logoSinFondo.png' %}" alt="Logo ICBF" />
    <h2>ICBF Conecta</h2>
    <a href="{% url 'dashboard_admin' %}"><i class="fa-solid fa-tachometer-alt"></i> Inicio</a>
    <a href="{% url 'listar_hogares' %}"><i class="fa-solid fa-house"></i> Hogares</a>
    <a href="{% url 'listar_madres' %}" class="active"><i class="fa-solid fa-users"></i> Agentes Educativos</a>
    <a href="{% url 'listar_administradores' %}"><i class="fa-solid fa-user-shield"></i> Administradores</a>
    <a href="{% url 'admin_reportes' %}" ><i class="fa-solid fa-chart-line"></i> Reportes</a>
    <div class="dropdown">
      <a href="#"><i class="fa-solid fa-cog"></i> Ajustes</a>
      <div class="dropdown-menu">
        <a href="{% url 'editar_perfil' %}"><i class="fa-solid fa-user-pen"></i> Editar Perfil</a>
        <a href="{% url 'cambiar_contrasena' %}"><i class="fa-solid fa-key"></i> Cambiar Contraseña</a>
      </div>
    </div>
    <div class="logout">
      <form method="post" action="{% url 'logout' %}" style="display:inline">
        {% csrf_token %}
        <button type="submit" style="background:none;border:none;color:white;cursor:pointer;padding:14px 25px;display:flex;align-items:center;gap:10px;font-family:'Poppins',sans-serif;font-size:16px;font-weight:500;width:100%;text-align:left;">
          <i class="fa-solid fa-right-from-bracket"></i> Cerrar sesión
        </button>
      </form>
    </div>
  </div>

  <div class="main">
    <header>
      <h1>{% if modo_edicion %}Editar{% else %}Crear{% endif %} Agente Educativo</h1>
    </header>

    {% if messages %}
    <ul class="messages">
      {% for message in messages %}
      <li class="{{ message.tags }}">
        {{ message }}
        <button class="close-message">&times;</button>
      </li>
      {% endfor %}
    </ul>
    {% endif %}

    <form method="post" enctype="multipart/form-data" id="madreCreationForm">
      {% csrf_token %}
      
      <!-- Campo oculto para número de convivientes -->
      <input type="hidden" name="num_convivientes" id="hidden_num_convivientes" value="0">

      <!-- ==================== FORMULARIO ÚNICO - TODOS LOS CAMPOS ==================== -->
      <div class="step-form" style="display:block">
        <h2>{% if modo_edicion %}Editar{% else %}Crear{% endif %} Agente Educativo - Formulario Completo</h2>
        <hr style="margin-bottom:20px" />
        
        <!-- ==================== SECCIÓN 1: INFORMACIÓN PERSONAL ==================== -->
        <h3 class="full-width" style="color:#004080;margin:25px 0 15px;font-size:18px;border-bottom:2px solid #007bff;padding-bottom:8px">
          <i class="fas fa-user"></i> 1. Información Personal del Agente Educativo
        </h3>
        
        <!-- GRID DE DOS COLUMNAS -->
        <div class="two-column-grid">
          <!-- COLUMNA IZQUIERDA: DATOS DE IDENTIFICACIÓN -->
          <div class="column-panel">
            <h4><i class="fas fa-id-card"></i> Datos de Identificación</h4>
            
            <div class="form-group">
              <label for="{{ usuario_form.tipo_documento.id_for_label }}">{{ usuario_form.tipo_documento.label }} <span class="required-star">*</span></label>
              {{ usuario_form.tipo_documento }}
              {% for error in usuario_form.tipo_documento.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
            
            <div class="form-group">
              <label for="{{ usuario_form.documento.id_for_label }}">{{ usuario_form.documento.label }} <span class="required-star">*</span></label>
              {{ usuario_form.documento }}
              <div id="documento-validation" style="display:none;margin-top:8px;padding:10px;border-radius:6px;"></div>
              {% for error in usuario_form.documento.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
            
            <div class="form-group">
              <label for="{{ usuario_form.nombres.id_for_label }}">{{ usuario_form.nombres.label }} <span class="required-star">*</span></label>
              {{ usuario_form.nombres }}
              {% for error in usuario_form.nombres.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
            
            <div class="form-group">
              <label for="{{ usuario_form.apellidos.id_for_label }}">{{ usuario_form.apellidos.label }} <span class="required-star">*</span></label>
              {{ usuario_form.apellidos }}
              {% for error in usuario_form.apellidos.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
            
            <div class="form-group">
              <label for="{{ usuario_form.fecha_nacimiento.id_for_label }}">{{ usuario_form.fecha_nacimiento.label }} <span class="required-star">*</span></label>
              {{ usuario_form.fecha_nacimiento }}
              <div id="edad-validation" style="margin-top:8px;padding:10px;border-radius:6px;display:none;"></div>
              <small style="color:#666;display:block;margin-top:5px;">{{ usuario_form.fecha_nacimiento.help_text }}</small>
              {% for error in usuario_form.fecha_nacimiento.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
            
            <div class="form-group">
              <label for="{{ usuario_form.sexo.id_for_label }}">{{ usuario_form.sexo.label }} <span class="required-star">*</span></label>
              {{ usuario_form.sexo }}
              {% for error in usuario_form.sexo.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
          </div>
          
          <!-- COLUMNA DERECHA: DATOS DE CONTACTO Y UBICACIÓN -->
          <div class="column-panel">
            <h4><i class="fas fa-phone"></i> Datos de Contacto</h4>
            
            <div class="form-group">
              <label for="{{ usuario_form.correo.id_for_label }}">{{ usuario_form.correo.label }} <span class="required-star">*</span></label>
              {{ usuario_form.correo }}
              {% for error in usuario_form.correo.errors %}<span class="error">{{ error }}</span>{% endfor %}
              <small style="color:#666;display:block;margin-top:5px;">Se usará para notificaciones del sistema</small>
            </div>
            
            <div class="form-group">
              <label for="{{ usuario_form.telefono.id_for_label }}">{{ usuario_form.telefono.label }} {% if usuario_form.telefono.field.required %}<span class="required-star">*</span>{% endif %}</label>
              {{ usuario_form.telefono }}
              {% for error in usuario_form.telefono.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
            
            <h4 style="margin-top:25px"><i class="fas fa-map-marker-alt"></i> Ubicación de Residencia</h4>
            
            <div class="form-group">
              <label for="{{ usuario_form.departamento_residencia.id_for_label }}">{{ usuario_form.departamento_residencia.label }} <span class="required-star">*</span></label>
              {{ usuario_form.departamento_residencia }}
              {% for error in usuario_form.departamento_residencia.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
            
            <div class="form-group">
              <label for="{{ usuario_form.ciudad_residencia.id_for_label }}">{{ usuario_form.ciudad_residencia.label }} <span class="required-star">*</span></label>
              {{ usuario_form.ciudad_residencia }}
              {% for error in usuario_form.ciudad_residencia.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
            
            <div class="form-group" id="localidad-bogota-group" style="display:none;">
              <label for="{{ usuario_form.localidad_bogota.id_for_label }}">{{ usuario_form.localidad_bogota.label }} <span class="required-star">*</span></label>
              {{ usuario_form.localidad_bogota }}
              {% for error in usuario_form.localidad_bogota.errors %}<span class="error">{{ error }}</span>{% endfor %}
              <small style="color:#666;display:block;margin-top:5px;">Solo aplica si reside en Bogotá D.C.</small>
            </div>
            
            <div class="form-group">
              <label for="{{ usuario_form.direccion.id_for_label }}">{{ usuario_form.direccion.label }} {% if usuario_form.direccion.field.required %}<span class="required-star">*</span>{% endif %}</label>
              {{ usuario_form.direccion }}
              {% for error in usuario_form.direccion.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
            
            <div class="form-group">
              <label for="{{ usuario_form.barrio.id_for_label }}">{{ usuario_form.barrio.label }} {% if usuario_form.barrio.field.required %}<span class="required-star">*</span>{% endif %}</label>
              {{ usuario_form.barrio }}
              {% for error in usuario_form.barrio.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
          </div>
        </div>        <!-- ==================== SECCIÓN 2: INFORMACIÓN ACADÉMICA Y DOCUMENTOS ==================== -->
        <h3 class="full-width" style="color:#004080;margin:40px 0 15px;font-size:18px;border-bottom:2px solid #007bff;padding-bottom:8px">
          <i class="fas fa-graduation-cap"></i> 2. Información Académica y Documentos del Agente Educativo
        </h3>

        <!-- GRID DE DOS COLUMNAS -->
        <div class="two-column-grid">
          <!-- COLUMNA IZQUIERDA: FORMACIÓN ACADÉMICA -->
          <div class="column-panel">
            <h4><i class="fas fa-user-graduate"></i> Formación Académica</h4>
            
            <div class="form-group">
              <label for="{{ madre_profile_form.nivel_escolaridad.id_for_label }}">{{ madre_profile_form.nivel_escolaridad.label }} <span class="required-star">*</span></label>
              {{ madre_profile_form.nivel_escolaridad }}
              {% for error in madre_profile_form.nivel_escolaridad.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
            
            <div class="form-group">
              <label for="{{ madre_profile_form.titulo_obtenido.id_for_label }}">{{ madre_profile_form.titulo_obtenido.label }}</label>
              {{ madre_profile_form.titulo_obtenido }}
              {% for error in madre_profile_form.titulo_obtenido.errors %}<span class="error">{{ error }}</span>{% endfor %}
              <small style="color:#666;display:block;margin-top:5px;">Opcional: Especifique el título académico obtenido</small>
            </div>
            
            <div class="form-group">
              <label for="{{ madre_profile_form.institucion.id_for_label }}">{{ madre_profile_form.institucion.label }}</label>
              {{ madre_profile_form.institucion }}
              {% for error in madre_profile_form.institucion.errors %}<span class="error">{{ error }}</span>{% endfor %}
              <small style="color:#666;display:block;margin-top:5px;">Opcional: Nombre de la institución educativa</small>
            </div>
            
            <div class="form-group">
              <label for="{{ madre_profile_form.experiencia_previa.id_for_label }}">{{ madre_profile_form.experiencia_previa.label }}</label>
              {{ madre_profile_form.experiencia_previa }}
              {% for error in madre_profile_form.experiencia_previa.errors %}<span class="error">{{ error }}</span>{% endfor %}
              <small style="color:#666;display:block;margin-top:5px;">Describa su experiencia trabajando con niños</small>
            </div>
          </div>
          
          <!-- COLUMNA DERECHA: CERTIFICADO LABORAL Y DECLARACIONES -->
          <div class="column-panel">
            <h4><i class="fas fa-file-certificate"></i> Certificado Laboral</h4>
            
            <div class="form-group">
              <label for="{{ madre_profile_form.certificado_laboral.id_for_label }}">
                Certificado Laboral <span class="required-star">*</span>
              </label>
              <input type="file" name="certificado_laboral" id="{{ madre_profile_form.certificado_laboral.id_for_label }}" 
                     accept="application/pdf,image/*"
                     onchange="previewFile(this, 'certificado_laboral')"
                     required>
              <div id="preview-certificado_laboral" class="file-preview-container" style="display:none;">
                <img class="preview-image" style="display:none;" />
                <div class="pdf-preview" style="display:none;">
                  <div class="pdf-icon">
                    <i class="fas fa-file-pdf"></i>
                    <div class="file-name"></div>
                  </div>
                  <iframe class="pdf-frame" style="display:none;"></iframe>
                </div>
                <button type="button" class="remove-file-btn" onclick="removeFile('certificado_laboral')">✕ Eliminar archivo</button>
              </div>
              {% for error in madre_profile_form.certificado_laboral.errors %}<span class="error">{{ error }}</span>{% endfor %}
              <small style="color:#666;display:block;margin-top:5px;">Certificado que acredite experiencia con niños</small>
            </div>
            
            <h4 style="margin-top:20px"><i class="fas fa-check-circle"></i> Declaraciones</h4>
            
            <div class="form-group">
              <div style="display:flex;align-items:flex-start;gap:10px;padding:15px;background-color:#e8f4f8;border-radius:8px;border-left:4px solid #007bff;">
                <label for="{{ madre_profile_form.no_retirado_icbf.id_for_label }}" style="margin:0;cursor:pointer;flex:1;order:1;">
                  <strong>Declaro que no he sido retirado del programa ICBF</strong>
                  <br><small style="color:#666;">Confirmo que nunca he sido desvinculado del programa</small>
                </label>
                <div style="order:2;">
                  {{ madre_profile_form.no_retirado_icbf }}
                </div>
              </div>
              {% for error in madre_profile_form.no_retirado_icbf.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
          </div>
        </div>
        
        <!-- CARTA DE DISPONIBILIDAD (ANCHO COMPLETO) -->
        <div class="full-width">
          <div class="form-group">
            <label for="{{ madre_profile_form.carta_disponibilidad.id_for_label }}">
              <i class="fas fa-file-contract"></i> Carta de Disponibilidad de Tiempo Completo <span class="required-star">*</span>
            </label>
            <input type="file" name="carta_disponibilidad" id="{{ madre_profile_form.carta_disponibilidad.id_for_label }}" 
                   accept="application/pdf,image/*"
                   onchange="previewFile(this, 'carta_disponibilidad')"
                   required>
            <div id="preview-carta_disponibilidad" class="file-preview-container" style="display:none;">
              <img class="preview-image" style="display:none;" />
              <div class="pdf-preview" style="display:none;">
                <div class="pdf-icon">
                  <i class="fas fa-file-pdf"></i>
                  <div class="file-name"></div>
                </div>
                <iframe class="pdf-frame" style="display:none;"></iframe>
              </div>
              <button type="button" class="remove-file-btn" onclick="removeFile('carta_disponibilidad')">✕ Eliminar archivo</button>
            </div>
            {% for error in madre_profile_form.carta_disponibilidad.errors %}<span class="error">{{ error }}</span>{% endfor %}
            <small style="color:#666;display:block;margin-top:5px;">Carta donde confirma disponibilidad para atender el hogar comunitario</small>
          </div>
        </div>

        <!-- Subsección: Autorización de Datos Personales -->
        <h4 style="color:#004080;margin:20px 0 10px;font-size:16px;border-left:4px solid #007bff;padding-left:10px">
          <i class="fas fa-shield-alt"></i> Protección de Datos Personales
        </h4>
        
        <div class="form-group">
          <div style="padding:15px;background-color:#fff3cd;border-radius:8px;border-left:4px solid #ffc107;">
            <p style="margin:0 0 10px 0;color:#856404;">
              <i class="fas fa-info-circle"></i> <strong>Autorización para el tratamiento de datos personales</strong>
            </p>
            <p style="margin:0;font-size:14px;color:#666;line-height:1.6;">
              Autorizo de manera libre, voluntaria, previa, explícita e informada al ICBF para que, en los términos legalmente establecidos, 
              realice la recolección, almacenamiento, uso, circulación, supresión y en general, el tratamiento de los datos personales 
              que he proporcionado en este formulario, para las finalidades relacionadas con la gestión de hogares comunitarios, 
              atención a la niñez, y demás procesos propios del programa. Declaro que he sido informado sobre mi derecho a conocer, 
              actualizar, rectificar y suprimir mis datos personales, así como revocar esta autorización en los casos en que sea procedente.
            </p>
          </div>
        </div>

        <!-- Subsección: Documentos Personales -->
        <h4 style="color:#004080;margin:20px 0 10px;font-size:16px;border-left:4px solid #007bff;padding-left:10px">
          <i class="fas fa-file-upload"></i> Documentos Personales
        </h4>
        
        <!-- Fila: Foto y Firma -->
        <div class="row" style="display:flex;gap:15px;margin-bottom:24px;">
          <!-- Foto del Agente Educativo -->
          <div class="form-group" style="flex:1;margin-bottom:0;">
            <label for="{{ madre_profile_form.foto_madre.id_for_label }}">
              <i class="fas fa-camera"></i> Foto del Agente Educativo <span class="required-star">*</span>
            </label>
            <input type="file" name="foto_madre" id="{{ madre_profile_form.foto_madre.id_for_label }}" 
                   accept="image/*,application/pdf"
                   onchange="previewFile(this, 'foto_madre')"
                   {% if madre_profile_form.foto_madre.field.required %}required{% endif %}>
            <div id="preview-foto_madre" class="file-preview-container" style="display:none;">
              <img class="preview-image" style="display:none;" />
              <div class="pdf-preview" style="display:none;">
                <div class="pdf-icon">
                  <i class="fas fa-file-pdf"></i>
                  <div class="file-name"></div>
                </div>
                <iframe class="pdf-frame" style="display:none;"></iframe>
              </div>
              <button type="button" class="remove-file-btn" onclick="removeFile('foto_madre')">✕ Eliminar archivo</button>
            </div>
            {% for error in madre_profile_form.foto_madre.errors %}<span class="error">{{ error }}</span>{% endfor %}
            <small style="color:#666;display:block;margin-top:5px;">Foto reciente tipo documento</small>
          </div>
          
          <!-- Firma Digital -->
          <div class="form-group" style="flex:1;margin-bottom:0;">
            <label for="{{ madre_profile_form.firma_digital.id_for_label }}">
              <i class="fas fa-signature"></i> {{ madre_profile_form.firma_digital.label }}
            </label>
            <input type="file" name="firma_digital" id="{{ madre_profile_form.firma_digital.id_for_label }}" 
                   accept="image/*,application/pdf"
                   onchange="previewFile(this, 'firma_digital')">
            <div id="preview-firma_digital" class="file-preview-container" style="display:none;">
              <img class="preview-image" style="display:none;" />
              <div class="pdf-preview" style="display:none;">
                <div class="pdf-icon">
                  <i class="fas fa-file-pdf"></i>
                  <div class="file-name"></div>
                </div>
                <iframe class="pdf-frame" style="display:none;"></iframe>
              </div>
              <button type="button" class="remove-file-btn" onclick="removeFile('firma_digital')">✕ Eliminar archivo</button>
            </div>
            {% for error in madre_profile_form.firma_digital.errors %}<span class="error">{{ error }}</span>{% endfor %}
            <small style="color:#666;display:block;margin-top:5px;">Firma escaneada o digital (opcional)</small>
          </div>
        </div>

        <!-- Sección: Documentos de Soporte -->
        <h3 style="color:#004080;margin:25px 0 15px;font-size:18px;border-bottom:2px solid #007bff;padding-bottom:8px">
          <i class="fas fa-folder-open"></i> Documentos de Soporte
        </h3>
        
        <!-- Documento de Identidad -->
        <div class="form-group">
          <label for="{{ madre_profile_form.documento_identidad_pdf.id_for_label }}">
            <i class="fas fa-id-card"></i> {{ madre_profile_form.documento_identidad_pdf.label }}
          </label>
          <input type="file" name="documento_identidad_pdf" id="{{ madre_profile_form.documento_identidad_pdf.id_for_label }}" 
                 accept="application/pdf,image/*"
                 onchange="previewFile(this, 'documento_identidad_pdf')">
          <div id="preview-documento_identidad_pdf" class="file-preview-container" style="display:none;">
            <img class="preview-image" style="display:none;" />
            <div class="pdf-preview" style="display:none;">
              <div class="pdf-icon">
                <i class="fas fa-file-pdf"></i>
                <div class="file-name"></div>
              </div>
              <iframe class="pdf-frame" style="display:none;"></iframe>
            </div>
            <button type="button" class="remove-file-btn" onclick="removeFile('documento_identidad_pdf')">✕ Eliminar archivo</button>
          </div>
          {% for error in madre_profile_form.documento_identidad_pdf.errors %}<span class="error">{{ error }}</span>{% endfor %}
        </div>
        
        <!-- Certificado de Escolaridad -->
        <div class="form-group">
          <label for="{{ madre_profile_form.certificado_escolaridad_pdf.id_for_label }}">
            <i class="fas fa-certificate"></i> {{ madre_profile_form.certificado_escolaridad_pdf.label }}
          </label>
          <input type="file" name="certificado_escolaridad_pdf" id="{{ madre_profile_form.certificado_escolaridad_pdf.id_for_label }}" 
                 accept="application/pdf,image/*"
                 onchange="previewFile(this, 'certificado_escolaridad_pdf')">
          <div id="preview-certificado_escolaridad_pdf" class="file-preview-container" style="display:none;">
            <img class="preview-image" style="display:none;" />
            <div class="pdf-preview" style="display:none;">
              <div class="pdf-icon">
                <i class="fas fa-file-pdf"></i>
                <div class="file-name"></div>
              </div>
              <iframe class="pdf-frame" style="display:none;"></iframe>
            </div>
            <button type="button" class="remove-file-btn" onclick="removeFile('certificado_escolaridad_pdf')">✕ Eliminar archivo</button>
          </div>
          {% for error in madre_profile_form.certificado_escolaridad_pdf.errors %}<span class="error">{{ error }}</span>{% endfor %}
        </div>
        
        <!-- Certificado de Antecedentes -->
        <div class="form-group">
          <label for="{{ madre_profile_form.certificado_antecedentes_pdf.id_for_label }}">
            <i class="fas fa-shield-alt"></i> {{ madre_profile_form.certificado_antecedentes_pdf.label }}
          </label>
          <input type="file" name="certificado_antecedentes_pdf" id="{{ madre_profile_form.certificado_antecedentes_pdf.id_for_label }}" 
                 accept="application/pdf,image/*"
                 onchange="previewFile(this, 'certificado_antecedentes_pdf')">
          <div id="preview-certificado_antecedentes_pdf" class="file-preview-container" style="display:none;">
            <img class="preview-image" style="display:none;" />
            <div class="pdf-preview" style="display:none;">
              <div class="pdf-icon">
                <i class="fas fa-file-pdf"></i>
                <div class="file-name"></div>
              </div>
              <iframe class="pdf-frame" style="display:none;"></iframe>
            </div>
            <button type="button" class="remove-file-btn" onclick="removeFile('certificado_antecedentes_pdf')">✕ Eliminar archivo</button>
          </div>
          {% for error in madre_profile_form.certificado_antecedentes_pdf.errors %}<span class="error">{{ error }}</span>{% endfor %}
        </div>
        
        <!-- Certificado Médico -->
        <div class="form-group">
          <label for="{{ madre_profile_form.certificado_medico_pdf.id_for_label }}">
            <i class="fas fa-heartbeat"></i> {{ madre_profile_form.certificado_medico_pdf.label }}
          </label>
          <input type="file" name="certificado_medico_pdf" id="{{ madre_profile_form.certificado_medico_pdf.id_for_label }}" 
                 accept="application/pdf,image/*"
                 onchange="previewFile(this, 'certificado_medico_pdf')">
          <div id="preview-certificado_medico_pdf" class="file-preview-container" style="display:none;">
            <img class="preview-image" style="display:none;" />
            <div class="pdf-preview" style="display:none;">
              <div class="pdf-icon">
                <i class="fas fa-file-pdf"></i>
                <div class="file-name"></div>
              </div>
              <iframe class="pdf-frame" style="display:none;"></iframe>
            </div>
            <button type="button" class="remove-file-btn" onclick="removeFile('certificado_medico_pdf')">✕ Eliminar archivo</button>
          </div>
          {% for error in madre_profile_form.certificado_medico_pdf.errors %}<span class="error">{{ error }}</span>{% endfor %}
        </div>
        
        <!-- Certificado de Residencia -->
        <div class="form-group">
          <label for="{{ madre_profile_form.certificado_residencia_pdf.id_for_label }}">
            <i class="fas fa-home"></i> {{ madre_profile_form.certificado_residencia_pdf.label }}
          </label>
          <input type="file" name="certificado_residencia_pdf" id="{{ madre_profile_form.certificado_residencia_pdf.id_for_label }}" 
                 accept="application/pdf,image/*"
                 onchange="previewFile(this, 'certificado_residencia_pdf')">
          <div id="preview-certificado_residencia_pdf" class="file-preview-container" style="display:none;">
            <img class="preview-image" style="display:none;" />
            <div class="pdf-preview" style="display:none;">
              <div class="pdf-icon">
                <i class="fas fa-file-pdf"></i>
                <div class="file-name"></div>
              </div>
              <iframe class="pdf-frame" style="display:none;"></iframe>
            </div>
            <button type="button" class="remove-file-btn" onclick="removeFile('certificado_residencia_pdf')">✕ Eliminar archivo</button>
          </div>
          {% for error in madre_profile_form.certificado_residencia_pdf.errors %}<span class="error">{{ error }}</span>{% endfor %}
        </div>
        
        <!-- Cartas de Recomendación -->
        <div class="form-group">
          <label for="{{ madre_profile_form.cartas_recomendacion_pdf.id_for_label }}">
            <i class="fas fa-envelope"></i> {{ madre_profile_form.cartas_recomendacion_pdf.label }}
          </label>
          <input type="file" name="cartas_recomendacion_pdf" id="{{ madre_profile_form.cartas_recomendacion_pdf.id_for_label }}" 
                 accept="application/pdf,image/*"
                 onchange="previewFile(this, 'cartas_recomendacion_pdf')">
          <div id="preview-cartas_recomendacion_pdf" class="file-preview-container" style="display:none;">
            <img class="preview-image" style="display:none;" />
            <div class="pdf-preview" style="display:none;">
              <div class="pdf-icon">
                <i class="fas fa-file-pdf"></i>
                <div class="file-name"></div>
              </div>
              <iframe class="pdf-frame" style="display:none;"></iframe>
            </div>
            <button type="button" class="remove-file-btn" onclick="removeFile('cartas_recomendacion_pdf')">✕ Eliminar archivo</button>
          </div>
          {% for error in madre_profile_form.cartas_recomendacion_pdf.errors %}<span class="error">{{ error }}</span>{% endfor %}
        </div>

        <!-- ==================== SECCIÓN 3: INFORMACIÓN DEL HOGAR COMUNITARIO ==================== -->
        <h3 class="full-width" style="color:#004080;margin:40px 0 15px;font-size:18px;border-bottom:2px solid #007bff;padding-bottom:8px">
          <i class="fas fa-home"></i> 3. Información del Hogar Comunitario
        </h3>

        <!-- GRID DE DOS COLUMNAS -->
        <div class="two-column-grid">
          <!-- COLUMNA IZQUIERDA: UBICACIÓN DEL HOGAR -->
          <div class="column-panel">
            <h4><i class="fas fa-map-marked-alt"></i> Ubicación del Hogar</h4>
            
            <div class="form-group">
              <label for="id_regional"><i class="fas fa-globe-americas"></i> Regional <span class="required-star">*</span></label>
              <select name="regional" id="id_regional" class="form-control" required>
                <option value="">-- Seleccione una Regional --</option>
                {% for regional in regionales %}
                  <option value="{{ regional.id }}" {% if hogar_form.data.regional == regional.id|stringformat:'s' or hogar_form.initial.regional == regional.id or hogar_form.instance.regional_id == regional.id %}selected{% endif %}>{{ regional.nombre }}</option>
                {% endfor %}
              </select>
              {% for error in hogar_form.regional.errors %}<span class="error">{{ error }}</span>{% endfor %}
              {% if regionales|length == 0 %}
                <div style="margin-top:10px;padding:12px;border-radius:6px;background:#fff3cd;color:#856404;border:1px solid #ffeeba;">
                  <i class="fas fa-exclamation-triangle"></i> No hay regionales registradas. Puedes <a href="{% url 'admin:core_regional_add' %}">agregar una regional</a> desde el panel de administración.
                </div>
              {% endif %}
            </div>
            
            <div class="form-group">
              <label for="id_ciudad"><i class="fas fa-city"></i> Ciudad <span class="required-star">*</span></label>
              <select name="ciudad" id="id_ciudad" class="form-control" required {% if not hogar_form.initial.regional and not hogar_form.data.regional %}disabled{% endif %} data-selected-id="{{ hogar_form.instance.ciudad_id }}">
                <option value="">-- Seleccione una Ciudad --</option>
                {% if hogar_form.fields.ciudad.queryset.exists %}
                  {% for ciudad in hogar_form.fields.ciudad.queryset %}
                    <option value="{{ ciudad.pk }}" {% if hogar_form.initial.ciudad == ciudad.pk or hogar_form.data.ciudad == ciudad.pk|stringformat:'s' %}selected{% endif %}>{{ ciudad.nombre }}</option>
                  {% endfor %}
                {% endif %}
              </select>
              {% for error in hogar_form.ciudad.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>

            <div class="form-group" id="localidad-hogar-group" style="display:none;">
              <label for="id_localidad_hogar"><i class="fas fa-map-pin"></i> Localidad <span class="required-star">*</span></label>
              {{ hogar_form.localidad_bogota }}
              <small style="color:#666;display:block;margin-top:5px;">Solo para hogares en Bogotá D.C.</small>
              {% for error in hogar_form.localidad_bogota.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>

            <div class="form-group">
              <label for="id_direccion_hogar"><i class="fas fa-location-arrow"></i> Dirección Completa <span class="required-star">*</span></label>
              <input type="text" name="direccion" id="id_direccion_hogar" class="form-control" 
                     placeholder="Ej: Cra 97#135a-30 SUBA" 
                     value="{{ hogar_form.direccion.value|default:'' }}" required>
              <small style="color:#666;display:block;margin-top:5px;">Ingrese la dirección completa del hogar</small>
              <div id="direccion-warning" class="alert-warning" style="display:none;margin-top:10px;padding:10px;border-radius:6px;background:#fff3cd;color:#856404;border:1px solid #ffeeba;">
                ⚠️ <strong>Advertencia:</strong> Verifique que la dirección corresponda a la localidad seleccionada.
              </div>
              {% for error in hogar_form.direccion.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>

            <div class="form-group">
              <label for="{{ hogar_form.barrio.id_for_label }}"><i class="fas fa-home"></i> Barrio</label>
              {{ hogar_form.barrio }}
              {% for error in hogar_form.barrio.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
          </div>
          
          <!-- COLUMNA DERECHA: DATOS BÁSICOS Y CARACTERÍSTICAS -->
          <div class="column-panel">
            <h4><i class="fas fa-info-circle"></i> Datos Básicos del Hogar</h4>
            
            <div class="form-group">
              <label for="{{ hogar_form.nombre_hogar.id_for_label }}"><i class="fas fa-signature"></i> Nombre del Hogar <span class="required-star">*</span></label>
              {{ hogar_form.nombre_hogar }}
              <div id="nombre-hogar-validation" style="display:none;margin-top:8px;padding:10px;border-radius:6px;"></div>
              {% for error in hogar_form.nombre_hogar.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>

            {% if not modo_edicion %}
            <div class="form-group">
              <label for="id_fecha_primera_visita"><i class="fas fa-calendar-check"></i> Fecha Programada para Primera Visita <span class="required-star">*</span></label>
              <input type="date" name="fecha_primera_visita" id="id_fecha_primera_visita" class="form-control" required>
              <div id="fecha-visita-validation" style="display:none;margin-top:8px;padding:10px;border-radius:6px;"></div>
              <small style="color:#666;display:block;margin-top:5px;">Máximo 5 semanas desde hoy, no sábados, domingos ni festivos</small>
            </div>
            {% endif %}
            
            <div class="form-group">
              <label for="{{ hogar_form.estrato.id_for_label }}"><i class="fas fa-layer-group"></i> Estrato Socioeconómico</label>
              {{ hogar_form.estrato }}
              {% for error in hogar_form.estrato.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
            
            <div class="form-group">
              <label for="{{ hogar_form.capacidad_maxima.id_for_label }}"><i class="fas fa-users"></i> Capacidad Máxima</label>
              <input type="number" name="capacidad_maxima" id="{{ hogar_form.capacidad_maxima.id_for_label }}" 
                     class="form-control" value="15" 
                     {% if not modo_edicion %}readonly disabled style="background-color:#e9ecef;cursor:not-allowed;"{% endif %}
                     min="1" max="30">
              <small style="color:#666;display:block;margin-top:5px;">Se asignará después de la visita técnica</small>
              {% if not modo_edicion %}
              <div style="margin-top:10px;padding:12px;border-radius:6px;background:#fff3cd;color:#856404;border:1px solid #ffeeba;font-size:13px;">
                <i class="fas fa-lock"></i> Campo bloqueado hasta la visita técnica
              </div>
              {% endif %}
              {% for error in hogar_form.capacidad_maxima.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>

            <div class="form-group">
              <label for="{{ hogar_form.estado.id_for_label }}"><i class="fas fa-toggle-on"></i> Estado del Hogar <span class="required-star">*</span></label>
              {{ hogar_form.estado }}
              {% if not modo_edicion %}
              <div style="margin-top:10px;padding:12px;border-radius:6px;background:#d1ecf1;color:#0c5460;border:1px solid #bee5eb;font-size:13px;">
                <i class="fas fa-info-circle"></i> Estado inicial: "Pendiente de Visita"
              </div>
              {% endif %}
              {% for error in hogar_form.estado.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
          </div>
        </div>

        </div>
        
        <!-- GRID DE DOS COLUMNAS: CARACTERÍSTICAS FÍSICAS Y TENENCIA -->
        <div class="two-column-grid">
          <!-- COLUMNA IZQUIERDA: CARACTERÍSTICAS FÍSICAS -->
          <div class="column-panel">
            <h4><i class="fas fa-building"></i> Características Físicas</h4>
            
            <div class="form-group">
              <label for="id_num_habitaciones"><i class="fas fa-door-closed"></i> Número de Habitaciones</label>
              <input type="number" name="num_habitaciones" id="id_num_habitaciones" class="form-control" min="1" 
                     value="{{ hogar_form.num_habitaciones.value|default:'' }}" 
                     placeholder="Ej: 3">
              {% for error in hogar_form.num_habitaciones.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>

            <div class="form-group">
              <label for="id_num_banos"><i class="fas fa-bath"></i> Número de Baños</label>
              <input type="number" name="num_banos" id="id_num_banos" class="form-control" min="1" 
                     value="{{ hogar_form.num_banos.value|default:'' }}" 
                     placeholder="Ej: 2">
              {% for error in hogar_form.num_banos.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>

            <div class="form-group">
              <label for="id_material_construccion"><i class="fas fa-hammer"></i> Material de Construcción</label>
              <textarea name="material_construccion" id="id_material_construccion" class="form-control" rows="2"
                        placeholder="Ej: Ladrillo, concreto, madera, etc.">{{ hogar_form.material_construccion.value|default:'' }}</textarea>
              {% for error in hogar_form.material_construccion.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>

            <div class="form-group">
              <label for="id_riesgos_cercanos"><i class="fas fa-exclamation-triangle"></i> Riesgos Cercanos</label>
              <textarea name="riesgos_cercanos" id="id_riesgos_cercanos" class="form-control" rows="3"
                        placeholder="Ej: Cerca de vías principales, zona de inundación, etc.">{{ hogar_form.riesgos_cercanos.value|default:'' }}</textarea>
              {% for error in hogar_form.riesgos_cercanos.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
          </div>
          
          <!-- COLUMNA DERECHA: TENENCIA DEL INMUEBLE -->
          <div class="column-panel">
            <h4><i class="fas fa-file-contract"></i> Tenencia del Inmueble</h4>
            
            <div class="form-group">
              <label for="{{ hogar_form.tipo_tenencia.id_for_label }}"><i class="fas fa-key"></i> Tipo de Tenencia</label>
              <select name="tipo_tenencia" id="{{ hogar_form.tipo_tenencia.id_for_label }}" class="form-control">
                <option value="">-- Seleccione el tipo de tenencia --</option>
                <option value="Propia" {% if hogar_form.tipo_tenencia.value == 'Propia' %}selected{% endif %}>Propia</option>
                <option value="Arrendada" {% if hogar_form.tipo_tenencia.value == 'Arrendada' %}selected{% endif %}>Arrendada</option>
                <option value="Comodato" {% if hogar_form.tipo_tenencia.value == 'Comodato' %}selected{% endif %}>Comodato</option>
              </select>
              <small style="color:#666;display:block;margin-top:5px;">Indique si es propio, arrendado o en comodato</small>
              {% for error in hogar_form.tipo_tenencia.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>

            <div class="form-group">
              <label for="{{ hogar_form.documento_tenencia_pdf.id_for_label }}"><i class="fas fa-file-pdf"></i> Documento de Tenencia</label>
              <input type="file" name="documento_tenencia_pdf" id="{{ hogar_form.documento_tenencia_pdf.id_for_label }}" 
                     accept="application/pdf,image/*"
                     onchange="previewFile(this, 'documento_tenencia_pdf')">
              <div id="preview-documento_tenencia_pdf" class="file-preview-container" style="display:none;">
                <img class="preview-image" style="display:none;" />
                <div class="pdf-preview" style="display:none;">
                  <div class="pdf-icon">
                    <i class="fas fa-file-pdf"></i>
                    <div class="file-name"></div>
                  </div>
                  <iframe class="pdf-frame" style="display:none;"></iframe>
                </div>
                <button type="button" class="remove-file-btn" onclick="removeFile('documento_tenencia_pdf')">✕ Eliminar archivo</button>
              </div>
              <small style="color:#666;display:block;margin-top:5px;">Documento que acredite la tenencia (opcional)</small>
              {% for error in hogar_form.documento_tenencia_pdf.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
            
            <h4 style="margin-top:25px"><i class="fas fa-map-marker-alt"></i> Geolocalización</h4>
            
            <div class="form-group">
              <label for="id_geolocalizacion_lat">Latitud</label>
              <input type="number" name="geolocalizacion_lat" id="id_geolocalizacion_lat" class="form-control" 
                     step="0.0000001" 
                     value="{{ hogar_form.geolocalizacion_lat.value|default:'' }}" 
                     placeholder="Ej: 4.6097100">
              <small style="color:#666;display:block;margin-top:5px;">Opcional (use Google Maps)</small>
              {% for error in hogar_form.geolocalizacion_lat.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>

            <div class="form-group">
              <label for="id_geolocalizacion_lon">Longitud</label>
              <input type="number" name="geolocalizacion_lon" id="id_geolocalizacion_lon" class="form-control" 
                     step="0.0000001" 
                     value="{{ hogar_form.geolocalizacion_lon.value|default:'' }}" 
                     placeholder="Ej: -74.0817500">
              <small style="color:#666;display:block;margin-top:5px;">Opcional (use Google Maps)</small>
              {% for error in hogar_form.geolocalizacion_lon.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
          </div>
        </div>

        <!-- GRID DE DOS COLUMNAS: FOTOS DEL HOGAR -->
        <div class="two-column-grid">
          <div class="column-panel">
            <h4><i class="fas fa-images"></i> Fotos del Interior</h4>
            <div class="form-group">
              <input type="file" name="fotos_interior" id="{{ hogar_form.fotos_interior.id_for_label }}" 
                     accept="image/*"
                     onchange="previewFile(this, 'fotos_interior')">
              <div id="preview-fotos_interior" class="file-preview-container" style="display:none;">
                <img class="preview-image" style="display:none;" />
                <button type="button" class="remove-file-btn" onclick="removeFile('fotos_interior')">✕ Eliminar archivo</button>
              </div>
              <small style="color:#666;display:block;margin-top:5px;">Suba fotos del interior del hogar (opcional)</small>
              {% for error in hogar_form.fotos_interior.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
          </div>
          
          <div class="column-panel">
            <h4><i class="fas fa-images"></i> Fotos del Exterior</h4>
            <div class="form-group">
              <input type="file" name="fotos_exterior" id="{{ hogar_form.fotos_exterior.id_for_label }}" 
                     accept="image/*"
                     onchange="previewFile(this, 'fotos_exterior')">
              <div id="preview-fotos_exterior" class="file-preview-container" style="display:none;">
                <img class="preview-image" style="display:none;" />
                <button type="button" class="remove-file-btn" onclick="removeFile('fotos_exterior')">✕ Eliminar archivo</button>
              </div>
              <small style="color:#666;display:block;margin-top:5px;">Suba fotos del exterior del hogar (opcional)</small>
              {% for error in hogar_form.fotos_exterior.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
          </div>
        </div>
        
        <!-- SECCIÓN DE CONVIVIENTES (ANCHO COMPLETO) -->
        <div class="full-width">
          <h4 style="color:#004080;margin:20px 0 10px;font-size:16px;border-left:4px solid #007bff;padding-left:10px">
            <i class="fas fa-users"></i> Personas que Viven en el Hogar
          </h4>

          <div class="form-group">
            <label for="num_convivientes"><i class="fas fa-user-plus"></i> ¿Cuántas personas viven en el hogar? <span class="required-star">*</span></label>
            <input type="number" id="num_convivientes" class="form-control" min="0" max="20" value="0" 
                   onchange="generarCamposConvivientes(this.value)"
                   placeholder="Ingrese el número de personas que conviven en el hogar">
            <small style="color:#666;display:block;margin-top:5px;">Incluya a todas las personas mayores de edad que viven permanentemente en el hogar (sin contar al agente educativo)</small>
          </div>

          <div id="convivientes-container" style="margin-top:20px;">
            <!-- Los campos de convivientes se generarán dinámicamente aquí -->
          </div>
        </div>

        <div id="seccion-visita-tecnica" style="{% if not modo_edicion %}opacity:0.5;pointer-events:none;{% endif %}">
          <h3 style="color:#004080;margin:40px 0 15px;font-size:18px;border-bottom:2px solid #007bff;padding-bottom:8px">
            <i class="fas fa-clipboard-check"></i> 4. Formulario de Primera Visita Técnica
          </h3>
          
          {% if not modo_edicion %}
          <div style="margin-bottom:20px;padding:15px;background-color:#fff3cd;color:#856404;border:1px solid #ffeeba;border-radius:6px;">
            <i class="fas fa-lock"></i> <strong>Sección bloqueada:</strong> Esta sección se habilitará automáticamente en la fecha programada de la visita técnica.
          </div>
          {% endif %}

          <!-- Subsección: Tipo y Características de la Vivienda -->
          <h4 style="color:#004080;margin:20px 0 10px;font-size:16px;border-left:4px solid #007bff;padding-left:10px">
            <i class="fas fa-home"></i> Tipo y Características de la Vivienda
          </h4>

          <div class="row" style="display:flex;gap:15px;margin-bottom:24px;">
            <div class="form-group" style="flex:1;margin-bottom:0;">
              <label>Tipo de Vivienda</label>
              <select name="visita_tipo_vivienda" class="form-control" {% if not modo_edicion %}disabled{% endif %}>
                <option value="">-- Seleccione --</option>
                <option value="casa">Casa</option>
                <option value="apartamento">Apartamento</option>
                <option value="casa_lote">Casa-Lote</option>
                <option value="finca">Finca</option>
              </select>
            </div>

            <div class="form-group" style="flex:1;margin-bottom:0;">
              <label>Ubicación</label>
              <select name="visita_ubicacion" class="form-control" {% if not modo_edicion %}disabled{% endif %}>
                <option value="">-- Seleccione --</option>
                <option value="urbana">Urbana</option>
                <option value="rural">Rural</option>
              </select>
            </div>

            <div class="form-group" style="flex:1;margin-bottom:0;">
              <label>¿Fuera de zonas de riesgo?</label>
              <select name="visita_sin_riesgo" class="form-control" {% if not modo_edicion %}disabled{% endif %}>
                <option value="">-- Seleccione --</option>
                <option value="si">Sí</option>
                <option value="no">No</option>
              </select>
              <small style="color:#666;display:block;margin-top:5px;">Inundaciones, deslizamientos, etc.</small>
            </div>
          </div>

          <!-- Subsección: Servicios Públicos -->
          <h4 style="color:#004080;margin:20px 0 10px;font-size:16px;border-left:4px solid #007bff;padding-left:10px">
            <i class="fas fa-plug"></i> Servicios Públicos
          </h4>

          <div class="form-group">
            <label style="display:block;margin-bottom:10px;"><strong>Servicios disponibles (marque los que aplican):</strong></label>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;">
              <div>
                <label style="cursor:pointer;display:flex;align-items:center;gap:8px;">
                  <input type="checkbox" name="visita_acueducto" value="1" {% if not modo_edicion %}disabled{% endif %}>
                  <span>Acueducto</span>
                </label>
              </div>
              <div>
                <label style="cursor:pointer;display:flex;align-items:center;gap:8px;">
                  <input type="checkbox" name="visita_alcantarillado" value="1" {% if not modo_edicion %}disabled{% endif %}>
                  <span>Alcantarillado</span>
                </label>
              </div>
              <div>
                <label style="cursor:pointer;display:flex;align-items:center;gap:8px;">
                  <input type="checkbox" name="visita_energia" value="1" {% if not modo_edicion %}disabled{% endif %}>
                  <span>Energía Eléctrica</span>
                </label>
              </div>
              <div>
                <label style="cursor:pointer;display:flex;align-items:center;gap:8px;">
                  <input type="checkbox" name="visita_gas" value="1" {% if not modo_edicion %}disabled{% endif %}>
                  <span>Gas Natural</span>
                </label>
              </div>
              <div>
                <label style="cursor:pointer;display:flex;align-items:center;gap:8px;">
                  <input type="checkbox" name="visita_internet" value="1" {% if not modo_edicion %}disabled{% endif %}>
                  <span>Internet</span>
                </label>
              </div>
              <div>
                <label style="cursor:pointer;display:flex;align-items:center;gap:8px;">
                  <input type="checkbox" name="visita_telefono" value="1" {% if not modo_edicion %}disabled{% endif %}>
                  <span>Teléfono</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Subsección: Espacios de la Vivienda -->
          <h4 style="color:#004080;margin:20px 0 10px;font-size:16px;border-left:4px solid #007bff;padding-left:10px">
            <i class="fas fa-door-open"></i> Espacios de la Vivienda
          </h4>

          <div class="form-group">
            <label style="display:block;margin-bottom:10px;"><strong>Espacios disponibles (marque los que aplican):</strong></label>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;">
              <div>
                <label style="cursor:pointer;display:flex;align-items:center;gap:8px;">
                  <input type="checkbox" name="visita_sala" value="1" {% if not modo_edicion %}disabled{% endif %}>
                  <span>Sala</span>
                </label>
              </div>
              <div>
                <label style="cursor:pointer;display:flex;align-items:center;gap:8px;">
                  <input type="checkbox" name="visita_comedor" value="1" {% if not modo_edicion %}disabled{% endif %}>
                  <span>Comedor</span>
                </label>
              </div>
              <div>
                <label style="cursor:pointer;display:flex;align-items:center;gap:8px;">
                  <input type="checkbox" name="visita_cocina" value="1" {% if not modo_edicion %}disabled{% endif %}>
                  <span>Cocina</span>
                </label>
              </div>
              <div>
                <label style="cursor:pointer;display:flex;align-items:center;gap:8px;">
                  <input type="checkbox" name="visita_patio" value="1" {% if not modo_edicion %}disabled{% endif %}>
                  <span>Patio</span>
                </label>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label>¿Hay espacio suficiente para los niños?</label>
            <select name="visita_espacio_suficiente" class="form-control" {% if not modo_edicion %}disabled{% endif %}>
              <option value="">-- Seleccione --</option>
              <option value="si">Sí</option>
              <option value="no">No</option>
              <option value="parcial">Parcialmente</option>
            </select>
          </div>

          <!-- Subsección: Condiciones Generales -->
          <h4 style="color:#004080;margin:20px 0 10px;font-size:16px;border-left:4px solid #007bff;padding-left:10px">
            <i class="fas fa-tasks"></i> Condiciones Generales
          </h4>

          <div class="row" style="display:flex;gap:15px;margin-bottom:24px;">
            <div class="form-group" style="flex:1;margin-bottom:0;">
              <label>Higiene</label>
              <select name="visita_higiene" class="form-control" {% if not modo_edicion %}disabled{% endif %}>
                <option value="">-- Seleccione --</option>
                <option value="excelente">Excelente</option>
                <option value="buena">Buena</option>
                <option value="regular">Regular</option>
                <option value="mala">Mala</option>
              </select>
            </div>

            <div class="form-group" style="flex:1;margin-bottom:0;">
              <label>Orden</label>
              <select name="visita_orden" class="form-control" {% if not modo_edicion %}disabled{% endif %}>
                <option value="">-- Seleccione --</option>
                <option value="excelente">Excelente</option>
                <option value="bueno">Bueno</option>
                <option value="regular">Regular</option>
                <option value="malo">Malo</option>
              </select>
            </div>

            <div class="form-group" style="flex:1;margin-bottom:0;">
              <label>Estado de la vivienda</label>
              <select name="visita_estado_vivienda" class="form-control" {% if not modo_edicion %}disabled{% endif %}>
                <option value="">-- Seleccione --</option>
                <option value="acabada">Acabada</option>
                <option value="buen_estado">Buen estado</option>
                <option value="deteriorada">Deteriorada</option>
                <option value="obra_negra">Obra negra</option>
              </select>
            </div>
          </div>

          <!-- Subsección: Otros Aspectos -->
          <h4 style="color:#004080;margin:20px 0 10px;font-size:16px;border-left:4px solid #007bff;padding-left:10px">
            <i class="fas fa-info-circle"></i> Otros Aspectos
          </h4>

          <div class="row" style="display:flex;gap:15px;margin-bottom:24px;">
            <div class="form-group" style="flex:1;margin-bottom:0;">
              <label>¿Hay animales en la vivienda?</label>
              <select name="visita_animales" class="form-control" {% if not modo_edicion %}disabled{% endif %}>
                <option value="">-- Seleccione --</option>
                <option value="no">No</option>
                <option value="si_controlados">Sí, controlados</option>
                <option value="si_sin_control">Sí, sin control</option>
              </select>
            </div>

            <div class="form-group" style="flex:1;margin-bottom:0;">
              <label>Número total de habitantes</label>
              <input type="number" name="visita_num_habitantes" class="form-control" min="1" {% if not modo_edicion %}disabled{% endif %}>
            </div>

            <div class="form-group" style="flex:1;margin-bottom:0;">
              <label>¿Convive con otros núcleos familiares?</label>
              <select name="visita_otros_nucleos" class="form-control" {% if not modo_edicion %}disabled{% endif %}>
                <option value="">-- Seleccione --</option>
                <option value="no">No</option>
                <option value="si">Sí</option>
              </select>
            </div>
          </div>

          <!-- Subsección: Espacios para los Niños -->
          <h4 style="color:#004080;margin:20px 0 10px;font-size:16px;border-left:4px solid #007bff;padding-left:10px">
            <i class="fas fa-child"></i> Espacios Específicos para los Niños
          </h4>

          <div class="form-group">
            <label style="display:block;margin-bottom:10px;"><strong>Áreas disponibles para los niños:</strong></label>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;">
              <div>
                <label style="cursor:pointer;display:flex;align-items:center;gap:8px;">
                  <input type="checkbox" name="visita_area_juego" value="1" {% if not modo_edicion %}disabled{% endif %}>
                  <span>Área de Juego</span>
                </label>
              </div>
              <div>
                <label style="cursor:pointer;display:flex;align-items:center;gap:8px;">
                  <input type="checkbox" name="visita_area_descanso" value="1" {% if not modo_edicion %}disabled{% endif %}>
                  <span>Área de Descanso</span>
                </label>
              </div>
              <div>
                <label style="cursor:pointer;display:flex;align-items:center;gap:8px;">
                  <input type="checkbox" name="visita_area_alimentacion" value="1" {% if not modo_edicion %}disabled{% endif %}>
                  <span>Área de Alimentación</span>
                </label>
              </div>
              <div>
                <label style="cursor:pointer;display:flex;align-items:center;gap:8px;">
                  <input type="checkbox" name="visita_area_recreacion" value="1" {% if not modo_edicion %}disabled{% endif %}>
                  <span>Área de Recreación</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Subsección: Condiciones Ambientales -->
          <h4 style="color:#004080;margin:20px 0 10px;font-size:16px;border-left:4px solid #007bff;padding-left:10px">
            <i class="fas fa-wind"></i> Condiciones Ambientales
          </h4>

          <div class="row" style="display:flex;gap:15px;margin-bottom:24px;">
            <div class="form-group" style="flex:1;margin-bottom:0;">
              <label>Ventilación</label>
              <select name="visita_ventilacion" class="form-control" {% if not modo_edicion %}disabled{% endif %}>
                <option value="">-- Seleccione --</option>
                <option value="excelente">Excelente</option>
                <option value="buena">Buena</option>
                <option value="regular">Regular</option>
                <option value="mala">Mala</option>
              </select>
            </div>

            <div class="form-group" style="flex:1;margin-bottom:0;">
              <label>Iluminación Natural</label>
              <select name="visita_iluminacion" class="form-control" {% if not modo_edicion %}disabled{% endif %}>
                <option value="">-- Seleccione --</option>
                <option value="excelente">Excelente</option>
                <option value="buena">Buena</option>
                <option value="regular">Regular</option>
                <option value="mala">Mala</option>
              </select>
            </div>

            <div class="form-group" style="flex:1;margin-bottom:0;">
              <label>¿Presencia de humedad?</label>
              <select name="visita_humedad" class="form-control" {% if not modo_edicion %}disabled{% endif %}>
                <option value="">-- Seleccione --</option>
                <option value="no">No</option>
                <option value="leve">Leve</option>
                <option value="moderada">Moderada</option>
                <option value="severa">Severa</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>¿Batería sanitaria adecuada para niños?</label>
            <select name="visita_bateria_sanitaria" class="form-control" {% if not modo_edicion %}disabled{% endif %}>
              <option value="">-- Seleccione --</option>
              <option value="si">Sí, completamente adecuada</option>
              <option value="parcial">Parcialmente adecuada</option>
              <option value="no">No adecuada</option>
            </select>
            <small style="color:#666;display:block;margin-top:5px;">Considere tamaño, seguridad y accesibilidad para niños</small>
          </div>

          <!-- Subsección: Aspectos Familiares y Convivencia -->
          <h4 style="color:#004080;margin:20px 0 10px;font-size:16px;border-left:4px solid #007bff;padding-left:10px">
            <i class="fas fa-users"></i> Aspectos Familiares y Convivencia
          </h4>

          <div class="form-group">
            <label>¿Los integrantes del hogar están de acuerdo con la función del agente educativo?</label>
            <select name="visita_familia_acuerdo" class="form-control" {% if not modo_edicion %}disabled{% endif %}>
              <option value="">-- Seleccione --</option>
              <option value="si_todos">Sí, todos</option>
              <option value="mayoria">La mayoría</option>
              <option value="algunos">Algunos</option>
              <option value="no">No</option>
            </select>
          </div>

          <div class="form-group">
            <label>Dinámica Familiar</label>
            <textarea name="visita_dinamica_familiar" class="form-control" rows="4" {% if not modo_edicion %}disabled{% endif %} placeholder="Describa cómo se toman las decisiones, actividades compartidas, relaciones con vecinos, redes comunitarias, manejo de conflictos, etc."></textarea>
          </div>

          <!-- Subsección: Capacidad para el Cuidado Infantil -->
          <h4 style="color:#004080;margin:20px 0 10px;font-size:16px;border-left:4px solid #007bff;padding-left:10px">
            <i class="fas fa-baby"></i> Capacidad para el Cuidado Infantil
          </h4>

          <div class="form-group">
            <label>Concepción sobre el juego infantil</label>
            <textarea name="visita_concepcion_juego" class="form-control" rows="3" {% if not modo_edicion %}disabled{% endif %} placeholder="¿Qué opina el aspirante sobre la importancia del juego en los niños?"></textarea>
          </div>

          <div class="form-group">
            <label>Concepción sobre desarrollo infantil</label>
            <textarea name="visita_concepcion_desarrollo" class="form-control" rows="3" {% if not modo_edicion %}disabled{% endif %} placeholder="¿Cómo entiende el aspirante el desarrollo de los niños?"></textarea>
          </div>

          <div class="form-group">
            <label>Manejo de disciplina y límites</label>
            <textarea name="visita_disciplina_limites" class="form-control" rows="3" {% if not modo_edicion %}disabled{% endif %} placeholder="¿Cómo maneja la disciplina y establece límites con los niños?"></textarea>
          </div>

          <div class="form-group">
            <label>Manejo de comportamientos difíciles</label>
            <textarea name="visita_comportamientos" class="form-control" rows="3" {% if not modo_edicion %}disabled{% endif %} placeholder="¿Cómo responde ante comportamientos difíciles de los niños?"></textarea>
          </div>

          <div class="form-group">
            <label>Posición sobre castigos</label>
            <textarea name="visita_castigos" class="form-control" rows="3" {% if not modo_edicion %}disabled{% endif %} placeholder="¿Qué opina sobre los castigos físicos y emocionales? ¿Qué alternativas conoce?"></textarea>
          </div>

          <!-- Subsección: Observaciones y Conclusiones de la Visita -->
          <h4 style="color:#004080;margin:20px 0 10px;font-size:16px;border-left:4px solid #007bff;padding-left:10px">
            <i class="fas fa-clipboard"></i> Observaciones y Conclusiones
          </h4>

          <div class="form-group">
            <label>Observaciones Generales de la Visita</label>
            <textarea name="visita_observaciones_generales" class="form-control" rows="5" {% if not modo_edicion %}disabled{% endif %} placeholder="Registre cualquier observación relevante sobre la visita técnica..."></textarea>
          </div>

          <div class="form-group">
            <label>Capacidad Máxima Calculada</label>
            <input type="number" name="visita_capacidad_calculada" class="form-control" min="1" max="30" {% if not modo_edicion %}disabled{% endif %}>
            <small style="color:#666;display:block;margin-top:5px;">Basada en el área social disponible y las condiciones evaluadas</small>
          </div>

          <div class="form-group">
            <label>Recomendación Final</label>
            <select name="visita_recomendacion" class="form-control" {% if not modo_edicion %}disabled{% endif %}>
              <option value="">-- Seleccione --</option>
              <option value="aprobado">Aprobado - Hogar Habilitado</option>
              <option value="aprobado_condiciones">Aprobado con Condiciones</option>
              <option value="no_aprobado">No Aprobado</option>
              <option value="requiere_nueva_visita">Requiere Nueva Visita</option>
            </select>
          </div>
        </div>

        <!-- Botones de Acción Final -->
        <div class="form-actions" style="margin-top:40px;padding-top:20px;border-top:2px solid #dee2e6;">
          <a href="{% url 'listar_madres' %}" class="btn-volver">
            <i class="fas fa-times"></i> Cancelar
          </a>
          {% if not modo_edicion %}
            <button type="submit" class="btn-guardar">
              <i class="fas fa-check"></i> Crear Agente Educativo y Hogar
            </button>
          {% else %}
            <button type="submit" class="btn-guardar">
              <i class="fas fa-save"></i> Guardar Cambios
            </button>
          {% endif %}
        </div>
      </div>

    </form>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Debug: Agregar listener al formulario para detectar problemas
      const form = document.getElementById('madreCreationForm');
      if (form) {
        form.addEventListener('submit', function(e) {
          console.log('Formulario enviándose...');
          
          // Validar edad antes de enviar
          if (typeof edadValida !== 'undefined' && !edadValida) {
            e.preventDefault();
            alert('No se puede crear el agente educativo. La edad debe estar entre 20 y 45 años.');
            
            // Scroll al campo de fecha de nacimiento
            const fechaInput = document.getElementById('id_fecha_nacimiento');
            if (fechaInput) {
              fechaInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
              fechaInput.focus();
            }
            
            return false;
          }
          
          // Verificar campos inválidos
          const invalidFields = form.querySelectorAll(':invalid');
          if (invalidFields.length > 0) {
            console.log('Campos inválidos encontrados:');
            invalidFields.forEach(field => {
              console.log(`  - ${field.name || field.id}: ${field.validationMessage}`);
            });
            e.preventDefault();
            alert('Por favor, complete todos los campos requeridos correctamente.');
            return false;
          }
        });
        
        // Detectar si el formulario no se envía
        form.addEventListener('invalid', function(e) {
          console.log('Campo inválido detectado:', e.target.name || e.target.id, e.target.validationMessage);
        }, true);
      }
      
      // --- LÓGICA: Mostrar/ocultar localidad para Bogotá en Hogar Comunitario ---
      const ciudadHogarSelect = document.getElementById('id_ciudad');
      const localidadHogarGroup = document.getElementById('localidad-hogar-group');
      const localidadHogarSelect = document.getElementById('id_localidad_hogar');
      const direccionInput = document.getElementById('id_direccion_hogar');
      const direccionWarning = document.getElementById('direccion-warning');

      // Función para verificar si es Bogotá y mostrar/ocultar localidad
      function checkBogotaHogar() {
        if (!ciudadHogarSelect || !localidadHogarGroup || !localidadHogarSelect) {
          console.log('Elementos no encontrados para checkBogotaHogar');
          return;
        }
        
        const selectedOption = ciudadHogarSelect.options[ciudadHogarSelect.selectedIndex];
        const ciudadNombre = selectedOption ? selectedOption.text.toUpperCase() : '';
        
        console.log('Ciudad seleccionada:', ciudadNombre);
        
        if (ciudadNombre.includes('BOGOTÁ') || ciudadNombre.includes('BOGOTA')) {
          console.log('Es Bogotá, mostrando localidades');
          localidadHogarGroup.style.display = 'block';
          localidadHogarSelect.required = true;
        } else {
          console.log('No es Bogotá, ocultando localidades');
          localidadHogarGroup.style.display = 'none';
          localidadHogarSelect.required = false;
          localidadHogarSelect.value = '';
        }
      }

      // --- AJAX: cargar ciudades según regional ---
      const regionalSelect = document.getElementById('id_regional');
      const ciudadSelect = document.getElementById('id_ciudad');

      if (regionalSelect && ciudadSelect) {
        // Deshabilitar ciudad inicialmente si no hay regional seleccionada
        if (!regionalSelect.value) {
          ciudadSelect.disabled = true;
          ciudadSelect.innerHTML = '<option value="">-- Seleccione una Ciudad --</option>';
        }

        regionalSelect.addEventListener('change', function() {
          const regionalId = this.value;
          ciudadSelect.innerHTML = '<option value="">Cargando...</option>';
          ciudadSelect.disabled = true;
          
          // Ocultar localidad mientras se cargan las ciudades
          if (localidadHogarGroup) {
            localidadHogarGroup.style.display = 'none';
          }

          if (regionalId) {
            fetch(`/ajax/cargar-ciudades/?regional_id=${regionalId}`)
              .then(response => response.json())
              .then(data => {
                ciudadSelect.innerHTML = '<option value="">-- Seleccione una Ciudad --</option>';
                data.forEach(ciudad => {
                  const option = document.createElement('option');
                  option.value = ciudad.id;
                  option.textContent = ciudad.nombre;
                  ciudadSelect.appendChild(option);
                });
                ciudadSelect.disabled = false;
                
                console.log('Ciudades cargadas:', data.length);
                
                // Verificar Bogotá después de cargar las ciudades
                checkBogotaHogar();
              })
              .catch(err => {
                ciudadSelect.innerHTML = '<option value="">-- Seleccione una Ciudad --</option>';
                ciudadSelect.disabled = true;
                console.error('Error al cargar ciudades:', err);
              });
          } else {
            ciudadSelect.innerHTML = '<option value="">-- Seleccione una Ciudad --</option>';
            ciudadSelect.disabled = true;
          }
        });

        // Si hay un valor inicial en regional (modo edición), disparar el change para cargar ciudades y seleccionar la ciudad actual
        if (regionalSelect.value) {
          const event = new Event('change');
          regionalSelect.dispatchEvent(event);
          // Esperar a que se carguen las ciudades y luego seleccionar la ciudad actual si existe
          setTimeout(() => {
            const selectedCityId = ciudadSelect.dataset.selectedId;
            if (selectedCityId) {
              console.log('Seleccionando ciudad previa:', selectedCityId);
              ciudadSelect.value = selectedCityId;
              ciudadSelect.disabled = false;
              checkBogotaHogar();
              
              // Si hay localidad pre-seleccionada, asegurarse de que se muestre
              {% if modo_edicion and hogar_form.instance.localidad_bogota_id %}
                const localidadSelect = document.getElementById('id_localidad_hogar');
                if (localidadSelect) {
                  setTimeout(() => {
                    localidadSelect.value = '{{ hogar_form.instance.localidad_bogota_id }}';
                    console.log('Localidad preseleccionada:', '{{ hogar_form.instance.localidad_bogota_id }}');
                  }, 100);
                }
              {% endif %}
            }
          }, 600);
        }
      }

      if (ciudadHogarSelect && localidadHogarGroup && localidadHogarSelect) {
        // Ejecutar al cambiar ciudad
        ciudadHogarSelect.addEventListener('change', checkBogotaHogar);
        
        // Ejecutar al cargar la página (por si ya hay ciudad seleccionada)
        setTimeout(() => {
          if (ciudadHogarSelect.value) {
            checkBogotaHogar();
          }
        }, 100);

        // Validación visual de coherencia dirección-localidad
        if (direccionInput && localidadHogarSelect && direccionWarning) {
          function validateDireccionLocalidad() {
            const localidadSeleccionada = localidadHogarSelect.options[localidadHogarSelect.selectedIndex];
            const direccion = direccionInput.value.toUpperCase();
            
            if (localidadSeleccionada && localidadSeleccionada.value && direccion) {
              const localidadNombre = localidadSeleccionada.text.toUpperCase();
              
              // Verificar si la dirección menciona la localidad
              // Esta es una validación básica, se puede mejorar
              if (!direccion.includes(localidadNombre) && direccion.length > 5) {
                direccionWarning.style.display = 'block';
                direccionWarning.innerHTML = `⚠️ <strong>Advertencia:</strong> La dirección no menciona "${localidadNombre}". Verifique que corresponda a esta localidad.`;
              } else {
                direccionWarning.style.display = 'none';
              }
            } else {
              direccionWarning.style.display = 'none';
            }
          }

          // Validar cuando cambie la localidad o la dirección
          localidadHogarSelect.addEventListener('change', validateDireccionLocalidad);
          direccionInput.addEventListener('blur', validateDireccionLocalidad);
          direccionInput.addEventListener('input', validateDireccionLocalidad);
        }
      }

      // --- Lógica para previsualización de imagen ---
      const fotoInput = document.getElementById('{{ madre_profile_form.foto_madre.id_for_label }}');
      const imagePreview = document.getElementById('image-preview');

      if (fotoInput && imagePreview) {
        fotoInput.addEventListener('change', function(event) {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
              imagePreview.src = e.target.result;
              imagePreview.style.display = 'block';
            }
            reader.readAsDataURL(file);
          }
        });
      }
    });
  </script>
  
  <!-- 🆕 Script de Geografía de Colombia -->
  <script src="{% static 'js/geografia_colombia.js' %}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Inicializar geografía con configuración personalizada
      initGeografiaColombia({
        departamentoSelector: '#id_departamento_residencia',
        municipioSelector: '#id_ciudad_residencia',
        localidadSelector: '#id_localidad_bogota',
        localidadContainer: '#localidad-bogota-group'
      });
      
      // Si hay valores preseleccionados (modo edición), disparar eventos
      const deptSelect = document.getElementById('id_departamento_residencia');
      if (deptSelect && deptSelect.value) {
        deptSelect.dispatchEvent(new Event('change'));
      }

      // ========================================
      // 📂 CARGAR ARCHIVOS EXISTENTES EN MODO EDICIÓN
      // ========================================
      {% if modo_edicion and madre_profile_form.instance %}
        console.log('Modo edición activado - Cargando archivos existentes...');
        const fileFields = [
          { name: 'foto_madre', url: '{% if madre_profile_form.instance.foto_madre %}{{ madre_profile_form.instance.foto_madre.url }}{% endif %}' },
          { name: 'firma_digital', url: '{% if madre_profile_form.instance.firma_digital %}{{ madre_profile_form.instance.firma_digital.url }}{% endif %}' },
          { name: 'documento_identidad_pdf', url: '{% if madre_profile_form.instance.documento_identidad_pdf %}{{ madre_profile_form.instance.documento_identidad_pdf.url }}{% endif %}' },
          { name: 'certificado_escolaridad_pdf', url: '{% if madre_profile_form.instance.certificado_escolaridad_pdf %}{{ madre_profile_form.instance.certificado_escolaridad_pdf.url }}{% endif %}' },
          { name: 'certificado_antecedentes_pdf', url: '{% if madre_profile_form.instance.certificado_antecedentes_pdf %}{{ madre_profile_form.instance.certificado_antecedentes_pdf.url }}{% endif %}' },
          { name: 'certificado_medico_pdf', url: '{% if madre_profile_form.instance.certificado_medico_pdf %}{{ madre_profile_form.instance.certificado_medico_pdf.url }}{% endif %}' },
          { name: 'certificado_residencia_pdf', url: '{% if madre_profile_form.instance.certificado_residencia_pdf %}{{ madre_profile_form.instance.certificado_residencia_pdf.url }}{% endif %}' },
          { name: 'cartas_recomendacion_pdf', url: '{% if madre_profile_form.instance.cartas_recomendacion_pdf %}{{ madre_profile_form.instance.cartas_recomendacion_pdf.url }}{% endif %}' },
          { name: 'certificado_laboral', url: '{% if madre_profile_form.instance.certificado_laboral %}{{ madre_profile_form.instance.certificado_laboral.url }}{% endif %}' },
          { name: 'carta_disponibilidad', url: '{% if madre_profile_form.instance.carta_disponibilidad %}{{ madre_profile_form.instance.carta_disponibilidad.url }}{% endif %}' },
          { name: 'documento_tenencia_pdf', url: '{% if hogar_form.instance.documento_tenencia_pdf %}{{ hogar_form.instance.documento_tenencia_pdf.url }}{% endif %}' }
        ];

        fileFields.forEach(field => {
          if (field.url && field.url.trim() !== '') {
            console.log(`Cargando archivo: ${field.name} - ${field.url}`);
            loadExistingFile(field.name, field.url);
          } else {
            console.log(`Sin archivo para: ${field.name}`);
          }
        });
        
        console.log('Archivos cargados completamente');
      {% endif %}
    });

    // ========================================
    // 📂 FUNCIÓN PARA CARGAR ARCHIVOS EXISTENTES
    // ========================================
    function loadExistingFile(fieldName, fileUrl) {
      const previewContainer = document.getElementById('preview-' + fieldName);
      if (!previewContainer) return;

      const previewImage = previewContainer.querySelector('.preview-image');
      const pdfPreview = previewContainer.querySelector('.pdf-preview');
      const pdfIcon = pdfPreview ? pdfPreview.querySelector('.pdf-icon') : null;
      const pdfFrame = pdfPreview ? pdfPreview.querySelector('.pdf-frame') : null;
      const fileName = pdfPreview ? pdfPreview.querySelector('.file-name') : null;

      // Mostrar contenedor
      previewContainer.style.display = 'block';

      // Detectar tipo de archivo por extensión
      const fileExt = fileUrl.split('.').pop().toLowerCase().split('?')[0];
      const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(fileExt);
      const isPDF = fileExt === 'pdf';

      // Ocultar ambas vistas primero
      if (previewImage) previewImage.style.display = 'none';
      if (pdfPreview) pdfPreview.style.display = 'none';
      if (pdfFrame) pdfFrame.style.display = 'none';
      if (pdfIcon) pdfIcon.style.display = 'none';

      if (isImage && previewImage) {
        // Mostrar imagen existente
        previewImage.src = fileUrl;
        previewImage.style.display = 'block';
      } else if (isPDF && pdfPreview) {
        // Mostrar PDF existente
        pdfPreview.style.display = 'block';
        if (fileName) {
          fileName.textContent = fileUrl.split('/').pop().split('?')[0];
        }
        
        // Mostrar PDF en iframe
        try {
          if (pdfFrame) {
            pdfFrame.src = fileUrl + '#toolbar=0&navpanes=0&scrollbar=0';
            pdfFrame.style.display = 'block';
          }
          if (pdfIcon) {
            pdfIcon.style.display = 'none';
          }
        } catch (e) {
          // Si falla, mostrar solo el ícono
          if (pdfIcon) pdfIcon.style.display = 'block';
          if (pdfFrame) pdfFrame.style.display = 'none';
        }
      }

      // Agregar botón para ver archivo en nueva pestaña
      const existingLink = previewContainer.querySelector('.view-existing-file');
      if (!existingLink) {
        const viewLink = document.createElement('a');
        viewLink.href = fileUrl;
        viewLink.target = '_blank';
        viewLink.className = 'view-existing-file';
        viewLink.style.cssText = 'display:inline-block;margin-top:10px;padding:8px 16px;background:#2563eb;color:white;border-radius:6px;text-decoration:none;font-size:14px;font-weight:600;';
        viewLink.innerHTML = '<i class="fas fa-external-link-alt"></i> Ver archivo completo';
        
        const removeBtn = previewContainer.querySelector('.remove-file-btn');
        if (removeBtn) {
          previewContainer.insertBefore(viewLink, removeBtn);
        } else {
          previewContainer.appendChild(viewLink);
        }
      }
    }
    
    // ========================================
    // 📎 VISTA PREVIA DE ARCHIVOS (Imágenes y PDFs)
    // ========================================
    function previewFile(input, fieldName) {
      const previewContainer = document.getElementById('preview-' + fieldName);
      const previewImage = previewContainer.querySelector('.preview-image');
      const pdfPreview = previewContainer.querySelector('.pdf-preview');
      const pdfIcon = pdfPreview.querySelector('.pdf-icon');
      const pdfFrame = pdfPreview.querySelector('.pdf-frame');
      const fileName = pdfPreview.querySelector('.file-name');
      
      if (input.files && input.files[0]) {
        const file = input.files[0];
        const fileType = file.type;
        const fileURL = URL.createObjectURL(file);
        
        // Mostrar contenedor
        previewContainer.style.display = 'block';
        
        // Ocultar ambas vistas primero
        previewImage.style.display = 'none';
        pdfPreview.style.display = 'none';
        pdfFrame.style.display = 'none';
        pdfIcon.style.display = 'none';
        
        if (fileType.startsWith('image/')) {
          // Vista previa de imagen
          previewImage.src = fileURL;
          previewImage.style.display = 'block';
        } else if (fileType === 'application/pdf') {
          // Vista previa de PDF
          pdfPreview.style.display = 'block';
          fileName.textContent = file.name;
          
          // Intentar mostrar PDF en iframe
          try {
            pdfFrame.src = fileURL;
            pdfFrame.style.display = 'block';
            pdfIcon.style.display = 'none';
          } catch (e) {
            // Si falla, mostrar solo el ícono
            pdfIcon.style.display = 'block';
            pdfFrame.style.display = 'none';
          }
        }
      }
    }
    
    function removeFile(fieldName) {
      const input = document.getElementById('id_' + fieldName);
      const previewContainer = document.getElementById('preview-' + fieldName);
      
      // Limpiar input
      input.value = '';
      
      // Ocultar vista previa
      previewContainer.style.display = 'none';
      
      // Limpiar contenido
      const previewImage = previewContainer.querySelector('.preview-image');
      const pdfFrame = previewContainer.querySelector('.pdf-frame');
      if (previewImage) previewImage.src = '';
      if (pdfFrame) pdfFrame.src = '';
    }

    // ========================================
    // 🔍 VALIDACIONES EN TIEMPO REAL
    // ========================================
    
    // Validación de documento duplicado
    const documentoInput = document.getElementById('id_documento');
    const documentoValidation = document.getElementById('documento-validation');
    const modoEdicion = '{{ modo_edicion|default:"False" }}' === 'True';
    const usuarioId = '{{ usuario_form.instance.id|default:"" }}';
    
    if (documentoInput && documentoValidation && !modoEdicion) {
      let documentoTimeout;
      
      documentoInput.addEventListener('input', function() {
        const documento = this.value.trim();
        
        // Limpiar timeout anterior
        clearTimeout(documentoTimeout);
        
        if (documento.length < 6) {
          documentoValidation.style.display = 'none';
          this.style.borderColor = '';
          return;
        }
        
        // Mostrar indicador de carga
        documentoValidation.style.display = 'block';
        documentoValidation.style.backgroundColor = '#e7f3ff';
        documentoValidation.style.color = '#004085';
        documentoValidation.style.border = '1px solid #bee5eb';
        documentoValidation.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando documento...';
        
        // Esperar 500ms antes de hacer la petición
        documentoTimeout = setTimeout(() => {
          fetch(`/ajax/validar-documento-madre/?documento=${encodeURIComponent(documento)}&usuario_id=${usuarioId}`)
            .then(response => response.json())
            .then(data => {
              if (data.existe) {
                documentoValidation.style.display = 'block';
                documentoValidation.style.backgroundColor = '#f8d7da';
                documentoValidation.style.color = '#721c24';
                documentoValidation.style.border = '1px solid #f5c6cb';
                documentoValidation.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <strong>Advertencia:</strong> ${data.mensaje}`;
                documentoInput.style.borderColor = '#dc3545';
                documentoInput.style.borderWidth = '2px';
              } else {
                documentoValidation.style.display = 'block';
                documentoValidation.style.backgroundColor = '#d4edda';
                documentoValidation.style.color = '#155724';
                documentoValidation.style.border = '1px solid #c3e6cb';
                documentoValidation.innerHTML = '<i class="fas fa-check-circle"></i> Documento disponible';
                documentoInput.style.borderColor = '#28a745';
                documentoInput.style.borderWidth = '2px';
                
                // Ocultar mensaje de éxito después de 2 segundos
                setTimeout(() => {
                  documentoValidation.style.display = 'none';
                  documentoInput.style.borderColor = '';
                  documentoInput.style.borderWidth = '';
                }, 2000);
              }
            })
            .catch(error => {
              console.error('Error al validar documento:', error);
              documentoValidation.style.display = 'none';
            });
        }, 500);
      });
    }
    
    // Validación de edad (20-45 años)
    const fechaNacimientoInput = document.getElementById('id_fecha_nacimiento');
    const edadValidation = document.getElementById('edad-validation');
    let edadValida = true; // Variable global para controlar el submit
    
    if (fechaNacimientoInput && edadValidation) {
      fechaNacimientoInput.addEventListener('change', function() {
        const fechaNacimiento = new Date(this.value);
        const hoy = new Date();
        
        if (!this.value) {
          edadValidation.style.display = 'none';
          this.style.borderColor = '';
          edadValida = false;
          return;
        }
        
        // Calcular edad
        let edad = hoy.getFullYear() - fechaNacimiento.getFullYear();
        const mes = hoy.getMonth() - fechaNacimiento.getMonth();
        if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNacimiento.getDate())) {
          edad--;
        }
        
        // Validar rango de edad
        if (edad < 20) {
          edadValidation.style.display = 'block';
          edadValidation.style.backgroundColor = '#f8d7da';
          edadValidation.style.color = '#721c24';
          edadValidation.style.border = '2px solid #dc3545';
          edadValidation.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <strong>Error:</strong> El agente educativo debe tener al menos 20 años. Edad actual: ${edad} años.`;
          this.style.borderColor = '#dc3545';
          this.style.borderWidth = '2px';
          edadValida = false;
        } else if (edad > 45) {
          edadValidation.style.display = 'block';
          edadValidation.style.backgroundColor = '#f8d7da';
          edadValidation.style.color = '#721c24';
          edadValidation.style.border = '2px solid #dc3545';
          edadValidation.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <strong>Error:</strong> El agente educativo no puede tener más de 45 años. Edad actual: ${edad} años.`;
          this.style.borderColor = '#dc3545';
          this.style.borderWidth = '2px';
          edadValida = false;
        } else {
          edadValidation.style.display = 'block';
          edadValidation.style.backgroundColor = '#d4edda';
          edadValidation.style.color = '#155724';
          edadValidation.style.border = '2px solid #28a745';
          edadValidation.innerHTML = `<i class="fas fa-check-circle"></i> Edad válida: ${edad} años (cumple con el requisito de 20-45 años)`;
          this.style.borderColor = '#28a745';
          this.style.borderWidth = '2px';
          edadValida = true;
          
          // Ocultar mensaje de éxito después de 3 segundos
          setTimeout(() => {
            edadValidation.style.display = 'none';
            fechaNacimientoInput.style.borderColor = '';
            fechaNacimientoInput.style.borderWidth = '';
          }, 3000);
        }
      });
      
      // Validar al cargar si ya hay fecha
      if (fechaNacimientoInput.value) {
        fechaNacimientoInput.dispatchEvent(new Event('change'));
      }
    }
    
    // Validación de nombre de hogar duplicado
    const nombreHogarInput = document.getElementById('id_nombre_hogar');
    const nombreHogarValidation = document.getElementById('nombre-hogar-validation');
    const hogarId = '{{ hogar_form.instance.id|default:"" }}';
    
    if (nombreHogarInput && nombreHogarValidation) {
      let nombreTimeout;
      
      nombreHogarInput.addEventListener('input', function() {
        const nombre = this.value.trim();
        
        // Limpiar timeout anterior
        clearTimeout(nombreTimeout);
        
        if (nombre.length < 3) {
          nombreHogarValidation.style.display = 'none';
          this.style.borderColor = '';
          return;
        }
        
        // Mostrar indicador de carga
        nombreHogarValidation.style.display = 'block';
        nombreHogarValidation.style.backgroundColor = '#e7f3ff';
        nombreHogarValidation.style.color = '#004085';
        nombreHogarValidation.style.border = '1px solid #bee5eb';
        nombreHogarValidation.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando nombre del hogar...';
        
        // Esperar 500ms antes de hacer la petición
        nombreTimeout = setTimeout(() => {
          fetch(`/ajax/validar-nombre-hogar/?nombre=${encodeURIComponent(nombre)}&hogar_id=${hogarId}`)
            .then(response => response.json())
            .then(data => {
              if (data.existe) {
                nombreHogarValidation.style.display = 'block';
                nombreHogarValidation.style.backgroundColor = '#f8d7da';
                nombreHogarValidation.style.color = '#721c24';
                nombreHogarValidation.style.border = '1px solid #f5c6cb';
                nombreHogarValidation.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <strong>Advertencia:</strong> ${data.mensaje}`;
                nombreHogarInput.style.borderColor = '#dc3545';
                nombreHogarInput.style.borderWidth = '2px';
              } else {
                nombreHogarValidation.style.display = 'block';
                nombreHogarValidation.style.backgroundColor = '#d4edda';
                nombreHogarValidation.style.color = '#155724';
                nombreHogarValidation.style.border = '1px solid #c3e6cb';
                nombreHogarValidation.innerHTML = '<i class="fas fa-check-circle"></i> Nombre disponible';
                nombreHogarInput.style.borderColor = '#28a745';
                nombreHogarInput.style.borderWidth = '2px';
                
                // Ocultar mensaje de éxito después de 2 segundos
                setTimeout(() => {
                  nombreHogarValidation.style.display = 'none';
                  nombreHogarInput.style.borderColor = '';
                  nombreHogarInput.style.borderWidth = '';
                }, 2000);
              }
            })
            .catch(error => {
              console.error('Error al validar nombre del hogar:', error);
              nombreHogarValidation.style.display = 'none';
            });
        }, 500);
      });
    }

    // ==================== VALIDACIÓN DE FECHA DE PRIMERA VISITA ====================
    const fechaVisitaInput = document.getElementById('id_fecha_primera_visita');
    const fechaVisitaValidation = document.getElementById('fecha-visita-validation');
    
    if (fechaVisitaInput) {
      // Festivos colombianos 2025-2026 (principales)
      const festivos = [
        '2025-01-01', '2025-01-06', '2025-03-24', '2025-04-17', '2025-04-18',
        '2025-05-01', '2025-06-02', '2025-06-23', '2025-06-30', '2025-07-20',
        '2025-08-07', '2025-08-18', '2025-10-13', '2025-11-03', '2025-11-17',
        '2025-12-08', '2025-12-25',
        '2026-01-01', '2026-01-12', '2026-03-23', '2026-04-02', '2026-04-03',
        '2026-05-01', '2026-05-18', '2026-06-08', '2026-06-15', '2026-06-29',
        '2026-07-20', '2026-08-07', '2026-08-17', '2026-10-12', '2026-11-02',
        '2026-11-16', '2026-12-08', '2026-12-25'
      ];
      
      // Establecer fecha mínima (mañana)
      const hoy = new Date();
      const manana = new Date(hoy);
      manana.setDate(hoy.getDate() + 1);
      fechaVisitaInput.min = manana.toISOString().split('T')[0];
      
      // Establecer fecha máxima (5 semanas = 35 días)
      const maxFecha = new Date(hoy);
      maxFecha.setDate(hoy.getDate() + 35);
      fechaVisitaInput.max = maxFecha.toISOString().split('T')[0];
      
      fechaVisitaInput.addEventListener('change', function() {
        const fechaSeleccionada = new Date(this.value + 'T00:00:00');
        const fechaStr = this.value;
        
        // Limpiar estilos previos
        this.style.borderColor = '';
        this.style.borderWidth = '';
        fechaVisitaValidation.style.display = 'none';
        
        if (!fechaStr) {
          return;
        }
        
        // Validar que no sea pasada
        if (fechaSeleccionada < manana) {
          this.style.borderColor = '#dc3545';
          this.style.borderWidth = '2px';
          fechaVisitaValidation.style.display = 'block';
          fechaVisitaValidation.style.backgroundColor = '#f8d7da';
          fechaVisitaValidation.style.color = '#721c24';
          fechaVisitaValidation.style.border = '1px solid #f5c6cb';
          fechaVisitaValidation.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <strong>Error:</strong> La fecha debe ser al menos mañana.';
          this.value = '';
          return;
        }
        
        // Validar que no supere 5 semanas
        if (fechaSeleccionada > maxFecha) {
          this.style.borderColor = '#dc3545';
          this.style.borderWidth = '2px';
          fechaVisitaValidation.style.display = 'block';
          fechaVisitaValidation.style.backgroundColor = '#f8d7da';
          fechaVisitaValidation.style.color = '#721c24';
          fechaVisitaValidation.style.border = '1px solid #f5c6cb';
          fechaVisitaValidation.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <strong>Error:</strong> La fecha no puede superar 5 semanas desde hoy. Seleccione una fecha más próxima.';
          this.value = '';
          return;
        }
        
        // Validar que no sea sábado o domingo
        const diaSemana = fechaSeleccionada.getDay();
        if (diaSemana === 0 || diaSemana === 6) {
          this.style.borderColor = '#dc3545';
          this.style.borderWidth = '2px';
          fechaVisitaValidation.style.display = 'block';
          fechaVisitaValidation.style.backgroundColor = '#f8d7da';
          fechaVisitaValidation.style.color = '#721c24';
          fechaVisitaValidation.style.border = '1px solid #f5c6cb';
          fechaVisitaValidation.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <strong>Error:</strong> No se pueden programar visitas en sábados o domingos.';
          this.value = '';
          return;
        }
        
        // Validar que no sea festivo
        if (festivos.includes(fechaStr)) {
          this.style.borderColor = '#dc3545';
          this.style.borderWidth = '2px';
          fechaVisitaValidation.style.display = 'block';
          fechaVisitaValidation.style.backgroundColor = '#f8d7da';
          fechaVisitaValidation.style.color = '#721c24';
          fechaVisitaValidation.style.border = '1px solid #f5c6cb';
          fechaVisitaValidation.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <strong>Error:</strong> No se pueden programar visitas en días festivos.';
          this.value = '';
          return;
        }
        
        // Fecha válida
        this.style.borderColor = '#28a745';
        this.style.borderWidth = '2px';
        fechaVisitaValidation.style.display = 'block';
        fechaVisitaValidation.style.backgroundColor = '#d4edda';
        fechaVisitaValidation.style.color = '#155724';
        fechaVisitaValidation.style.border = '1px solid #c3e6cb';
        
        const opciones = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const fechaFormateada = fechaSeleccionada.toLocaleDateString('es-ES', opciones);
        fechaVisitaValidation.innerHTML = `<i class="fas fa-check-circle"></i> Fecha válida: ${fechaFormateada}`;
      });
    }

    // ==================== GESTIÓN DE CONVIVIENTES ====================
    function generarCamposConvivientes(cantidad) {
      const container = document.getElementById('convivientes-container');
      const hiddenInput = document.getElementById('hidden_num_convivientes');
      
      container.innerHTML = ''; // Limpiar campos existentes
      
      // Actualizar campo oculto
      hiddenInput.value = cantidad;
      
      if (cantidad <= 0) {
        return;
      }
      
      for (let i = 0; i < cantidad; i++) {
        const convivienteDiv = document.createElement('div');
        convivienteDiv.className = 'conviviente-card';
        convivienteDiv.style.cssText = 'border:2px solid #007bff;border-radius:8px;padding:20px;margin-bottom:20px;background:#f8f9fa;';
        
        convivienteDiv.innerHTML = `
          <h5 style="color:#004080;margin:0 0 15px;font-size:16px;border-bottom:2px solid #007bff;padding-bottom:8px;">
            <i class="fas fa-user"></i> Conviviente ${i + 1}
          </h5>
          
          <!-- Fila 1: Tipo y Número de Documento -->
          <div class="row" style="display:flex;gap:15px;margin-bottom:15px;">
            <div class="form-group" style="flex:1;margin-bottom:0;">
              <label>Tipo de Documento <span class="required-star">*</span></label>
              <select name="conviviente_${i}_tipo_documento" class="form-control conviviente-tipo-doc" data-index="${i}" required>
                <option value="">-- Seleccione --</option>
                <option value="CC">Cédula de Ciudadanía</option>
                <option value="TI">Tarjeta de Identidad</option>
                <option value="CE">Cédula de Extranjería</option>
                <option value="PA">Pasaporte</option>
                <option value="RC">Registro Civil</option>
              </select>
            </div>
            
            <div class="form-group" style="flex:2;margin-bottom:0;">
              <label>Número de Documento <span class="required-star">*</span></label>
              <input type="text" name="conviviente_${i}_numero_documento" class="form-control" 
                     placeholder="Ej: 1234567890" required>
            </div>
          </div>
          
          <!-- Fila 2: Nombre y Parentesco -->
          <div class="row" style="display:flex;gap:15px;margin-bottom:15px;">
            <div class="form-group" style="flex:2;margin-bottom:0;">
              <label>Nombre Completo <span class="required-star">*</span></label>
              <input type="text" name="conviviente_${i}_nombre_completo" class="form-control" 
                     placeholder="Ej: Juan Pérez García" required>
            </div>
            
            <div class="form-group" style="flex:1;margin-bottom:0;">
              <label>Parentesco <span class="required-star">*</span></label>
              <select name="conviviente_${i}_parentesco" class="form-control" required>
                <option value="">-- Seleccione --</option>
                <option value="Cónyuge">Cónyuge</option>
                <option value="Hijo/a">Hijo/a</option>
                <option value="Padre/Madre">Padre/Madre</option>
                <option value="Hermano/a">Hermano/a</option>
                <option value="Abuelo/a">Abuelo/a</option>
                <option value="Tío/a">Tío/a</option>
                <option value="Sobrino/a">Sobrino/a</option>
                <option value="Otro">Otro</option>
              </select>
            </div>
          </div>
          
          <!-- Campo de Antecedentes (solo para mayores de edad) -->
          <div id="conviviente_${i}_antecedentes_container" style="display:none;">
            <div class="form-group">
              <label>
                <i class="fas fa-file-shield"></i> Certificado de Antecedentes <span class="required-star">*</span>
              </label>
              <input type="file" name="conviviente_${i}_antecedentes" 
                     id="conviviente_${i}_antecedentes"
                     accept="application/pdf,image/*"
                     onchange="previewFile(this, 'conviviente_${i}_antecedentes')"
                     class="conviviente-antecedentes">
              <div id="preview-conviviente_${i}_antecedentes" class="file-preview-container" style="display:none;">
                <img class="preview-image" style="display:none;" />
                <div class="pdf-preview" style="display:none;">
                  <div class="pdf-icon">
                    <i class="fas fa-file-pdf"></i>
                    <div class="file-name"></div>
                  </div>
                  <iframe class="pdf-frame" style="display:none;"></iframe>
                </div>
                <button type="button" class="remove-file-btn" onclick="removeFile('conviviente_${i}_antecedentes')">✕ Eliminar archivo</button>
              </div>
              <small style="color:#666;display:block;margin-top:5px;">Los mayores de edad deben adjuntar certificado de antecedentes</small>
            </div>
          </div>
        `;
        
        container.appendChild(convivienteDiv);
      }
      
      // Agregar listeners para detectar mayores de edad
      agregarListenersConvivientes();
    }
    
    function agregarListenersConvivientes() {
      const tiposDocumentos = document.querySelectorAll('.conviviente-tipo-doc');
      
      tiposDocumentos.forEach(select => {
        select.addEventListener('change', function() {
          const index = this.getAttribute('data-index');
          const antecedentesContainer = document.getElementById(`conviviente_${index}_antecedentes_container`);
          const antecedentesInput = document.getElementById(`conviviente_${index}_antecedentes`);
          
          // Si es CC, CE o PA = Mayor de edad, requiere antecedentes
          const esMayorEdad = ['CC', 'CE', 'PA'].includes(this.value);
          
          if (esMayorEdad) {
            antecedentesContainer.style.display = 'block';
            if (antecedentesInput) {
              antecedentesInput.setAttribute('required', 'required');
            }
          } else {
            antecedentesContainer.style.display = 'none';
            if (antecedentesInput) {
              antecedentesInput.removeAttribute('required');
              antecedentesInput.value = '';
            }
          }
        });
      });
    }
  </script>
</body>
</html>
