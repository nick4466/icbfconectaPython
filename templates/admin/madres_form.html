{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% if madre_profile_form.instance.id %}Editar{% else %}Crear{% endif %} Madre Comunitaria</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    /* Estilos idénticos a los tuyos, sin cambios visuales */
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:"Poppins",sans-serif;background:#f3f6fa;color:#333;display:flex;min-height:100vh}
    .sidebar{width:250px;background:linear-gradient(180deg,#004080,#007bff);color:white;display:flex;flex-direction:column;padding:25px 0}
    .sidebar img{height:70px;margin:0 auto 20px}
    .sidebar h2{text-align:center;font-weight:700;margin-bottom:25px;font-size:18px}
    .sidebar a{color:white;text-decoration:none;padding:14px 25px;display:flex;align-items:center;gap:10px;font-weight:500;transition:background .3s ease}
    .sidebar a:hover,.sidebar a.active{background:rgba(255,255,255,0.15);border-left:4px solid #fff}
    .sidebar .dropdown{position:relative}
    .sidebar .dropdown-menu{display:none;position:absolute;left:100%;top:0;background:#004080;min-width:200px;box-shadow:0 8px 16px rgba(0,0,0,.2);z-index:1;border-radius:0 8px 8px 0}
    .sidebar .dropdown:hover .dropdown-menu{display:block}
    .sidebar .dropdown-menu a{padding:12px 16px;border-left:none!important}
    .main{flex:1;padding:40px}
    .main header{display:flex;justify-content:space-between;align-items:center;margin-bottom:40px}
    .main header h1{font-size:28px;color:#004080;font-weight:700}
    .form-group{margin-bottom:20px}
    form label{font-weight:600;color:#555;margin-bottom:8px;font-size:14px;display:block}
    form input, form select, form textarea{width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;font-family:"Poppins",sans-serif;font-size:15px}
    form input:focus{border-color:#007bff;box-shadow:0 0 0 3px rgba(0,123,255,.15);outline:none}
    .form-actions{margin-top:30px;display:flex;gap:15px;justify-content:flex-end}
    .btn-guardar,.btn-volver{padding:10px 28px;border:none;border-radius:6px;color:white;font-weight:600;font-size:16px;cursor:pointer;transition:background .2s}
    .btn-guardar{background:linear-gradient(90deg,#28a745,#218838)}
    .btn-volver{background:#6c757d}
    .btn-volver:hover{background:#495057}
    .btn-guardar:hover{background:#218838}
    .messages{list-style:none;padding:0;margin:0 0 20px 0}
    .messages li{padding:12px;border-radius:6px;margin-bottom:8px;color:white;font-weight:500;display:flex;justify-content:space-between;align-items:center}
    .messages li.success{background:#28a745}
    .messages li.error{background:#dc3545}
    .close-message{background:none;border:none;color:white;font-size:20px;cursor:pointer}
    .required-star{color:#dc3545;margin-left:4px;font-weight:bold}
  </style>
</head>
<body>
  <script>
    let currentStep = 1;
    const modoEdicion = '{{ modo_edicion|default:"" }}' === 'True' || '{{ modo_edicion|default:"" }}' === 'true';

    function updateIndicators(step) {
      if (modoEdicion) return; // No mostrar indicadores en modo edición
      for (let i = 1; i <= 3; i++) {
        document.getElementById(`step${i}-indicator`).style.color = i <= step ? '#007bff' : '#ccc';
      }
    }

    function prevStep(step) {
      currentStep = step - 1;
      document.getElementById(`step${step}`).style.display = 'none';
      document.getElementById(`step${currentStep}`).style.display = 'block';
      updateIndicators(currentStep);
    }

    function nextStep(step) {
      currentStep = step + 1;
      document.getElementById(`step${step}`).style.display = 'none';
      document.getElementById(`step${currentStep}`).style.display = 'block';
      updateIndicators(currentStep);
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (modoEdicion) {
        // En modo edición, mostrar todos los pasos
        for (let i = 1; i <= 3; i++) {
          document.getElementById(`step${i}`).style.display = 'block';
        }
      } else {
        // En modo creación, mostrar según initial_step
        const initialStep = parseInt('{{ initial_step|default:1 }}');
        for (let i = 1; i <= 3; i++) {
          document.getElementById(`step${i}`).style.display = i === initialStep ? 'block' : 'none';
        }
        updateIndicators(initialStep);
      }
    });
  </script>

  <div class="sidebar">
    <img src="{% static 'img/logoSinFondo.png' %}" alt="Logo ICBF" />
    <h2>ICBF Conecta</h2>
    <a href="{% url 'admin_dashboard' %}"><i class="fa-solid fa-tachometer-alt"></i> Inicio</a>
    <a href="{% url 'listar_hogares' %}"><i class="fa-solid fa-house"></i> Hogares</a>
    <a href="{% url 'listar_madres' %}" class="active"><i class="fa-solid fa-users"></i> Madres</a>
    <a href="{% url 'listar_administradores' %}"><i class="fa-solid fa-user-shield"></i> Administradores</a>
    <a href="#"><i class="fa-solid fa-chart-line"></i> Reportes</a>
    <div class="dropdown">
      <a href="#"><i class="fa-solid fa-cog"></i> Ajustes</a>
      <div class="dropdown-menu">
        <a href="{% url 'editar_perfil' %}"><i class="fa-solid fa-user-pen"></i> Editar Perfil</a>
        <a href="{% url 'cambiar_contrasena' %}"><i class="fa-solid fa-key"></i> Cambiar Contraseña</a>
      </div>
    </div>
    <div class="logout">
      <form method="post" action="{% url 'logout' %}" style="display:inline">
        {% csrf_token %}
        <button type="submit" style="background:none;border:none;color:white;cursor:pointer;padding:14px 25px;display:flex;align-items:center;gap:10px;font-family:'Poppins',sans-serif;font-size:16px;font-weight:500;width:100%;text-align:left;">
          <i class="fa-solid fa-right-from-bracket"></i> Cerrar sesión
        </button>
      </form>
    </div>
  </div>

  <div class="main">
    <header>
      <h1>{% if modo_edicion %}Editar{% else %}Crear{% endif %} Madre Comunitaria</h1>
    </header>

    {% if messages %}
    <ul class="messages">
      {% for message in messages %}
      <li class="{{ message.tags }}">
        {{ message }}
        <button class="close-message">&times;</button>
      </li>
      {% endfor %}
    </ul>
    {% endif %}

    <form method="post" enctype="multipart/form-data" id="madreCreationForm">
      {% csrf_token %}

      {% if not modo_edicion %}
      <div style="display:flex;justify-content:space-around;margin-bottom:40px;font-weight:600;">
        <span id="step1-indicator">1. Datos de Usuario</span>
        <span id="step2-indicator">2. Perfil de la Madre</span>
        <span id="step3-indicator">3. Datos del Hogar</span>
      </div>
      {% endif %}

      <!-- PASO 1 -->
      <div class="step-form" id="step1" {% if modo_edicion %}style="display:block"{% endif %}>
        <h2>{% if modo_edicion %}Datos de Autenticación y Contacto{% else %}Paso 1: Datos de Autenticación y Contacto{% endif %}</h2>
        <hr style="margin-bottom:20px" />
        {% for field in usuario_form %}
        <div class="form-group">
          <label for="{{ field.id_for_label }}">{{ field.label }} {% if field.field.required %}<span class="required-star">*</span>{% endif %}</label>
          {{ field }} {% for error in field.errors %}<span class="error">{{ error }}</span>{% endfor %}
        </div>
        {% endfor %}
        <div class="form-actions">
          {% if not modo_edicion %}
          <button type="button" class="btn-guardar" onclick="nextStep(1)">Siguiente</button>
          {% endif %}
        </div>
      </div>

      <!-- PASO 2 -->
      <div class="step-form" id="step2" {% if modo_edicion %}style="display:block"{% else %}style="display:none"{% endif %}>
        <h2>{% if modo_edicion %}Perfil y Documentos de la Madre{% else %}Paso 2: Perfil y Documentos de la Madre{% endif %}</h2>
        <hr style="margin-bottom:20px" />
        {% for field in madre_profile_form %}
        <div class="form-group">
          <label for="{{ field.id_for_label }}">{{ field.label }} {% if field.field.required %}<span class="required-star">*</span>{% endif %}</label>
          {{ field }} {% for error in field.errors %}<span class="error">{{ error }}</span>{% endfor %}
        </div>
        {% endfor %}
        <div class="form-actions">
          {% if not modo_edicion %}
          <button type="button" class="btn-volver" onclick="prevStep(2)">Anterior</button>
          <button type="button" class="btn-guardar" onclick="nextStep(2)">Siguiente</button>
          {% endif %}
        </div>
      </div>

      <!-- PASO 3 -->
      <div class="step-form" id="step3" {% if modo_edicion %}style="display:block"{% else %}style="display:none"{% endif %}>
        <h2>{% if modo_edicion %}Datos del Hogar Comunitario{% else %}Paso 3: Datos del Hogar Comunitario{% endif %}</h2>
        <hr style="margin-bottom:20px" />
        {% for field in hogar_form %}
        <div class="form-group">
          <label for="{{ field.id_for_label }}">{{ field.label }} {% if field.field.required %}<span class="required-star">*</span>{% endif %}</label>
          {{ field }} {% for error in field.errors %}<span class="error">{{ error }}</span>{% endfor %}
        </div>
        {% endfor %}
        <div class="form-actions">
          {% if not modo_edicion %}
          <button type="button" class="btn-volver" onclick="prevStep(3)">Anterior</button>
          <button type="submit" class="btn-guardar">Finalizar Creación</button>
          {% else %}
          <a href="{% url 'listar_madres' %}" class="btn-volver">Cancelar</a>
          <button type="submit" class="btn-guardar">Guardar Cambios</button>
          {% endif %}
        </div>
      </div>
    </form>
  </div>
</body>
</html>
