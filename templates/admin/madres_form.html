{% load static %}
{% load custom_tags %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% if modo_edicion %}Editar{% else %}Crear{% endif %} Agente Educativo</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root {
      --primary: #1e3a8a;
      --primary-light: #3b82f6;
      --secondary: #64748b;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
      --light: #f8fafc;
      --dark: #0f172a;
      --border: #e2e8f0;
      --text: #1e293b;
      --text-light: #64748b;
      --sidebar-width: 260px;
      --topbar-height: 70px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: var(--light); color: var(--text); min-height: 100vh; }

    /* ========== SIDEBAR ========== */
    .sidebar { position: fixed; top: 0; left: 0; width: var(--sidebar-width); height: 100vh; background: linear-gradient(180deg, var(--primary) 0%, #1e40af 100%); color: white; display: flex; flex-direction: column; z-index: 1000; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
    .sidebar-header { padding: 1.5rem 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .sidebar-logo { display: flex; align-items: center; gap: 12px; text-decoration: none; color: white; }
    .sidebar-logo img { width: 45px; height: 45px; object-fit: contain; }
    .sidebar-logo-text h2 { font-size: 18px; font-weight: 700; margin: 0; }
    .sidebar-logo-text p { font-size: 11px; opacity: 0.9; margin: 0; }
    .sidebar-nav { flex: 1; padding: 1rem 0; overflow-y: auto; }
    .nav-item { margin-bottom: 0.25rem; }
    .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: rgba(255,255,255,0.9); text-decoration: none; transition: all 0.2s; font-size: 14px; font-weight: 500; border-left: 3px solid transparent; }
    .nav-link:hover { background: rgba(255,255,255,0.1); border-left-color: white; }
    .nav-link.active { background: rgba(255,255,255,0.15); border-left-color: white; color: white; }
    .nav-link i { width: 20px; text-align: center; font-size: 16px; }

    /* ========== MAIN CONTENT ========== */
    .main-content { margin-left: var(--sidebar-width); min-height: 100vh; display: flex; flex-direction: column; }
    .topbar { height: var(--topbar-height); background: white; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; position: sticky; top: 0; z-index: 100; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .topbar-left h1 { font-size: 24px; font-weight: 700; color: var(--primary); margin: 0; }
    .topbar-right { display: flex; align-items: center; gap: 1.5rem; }
    .user-menu { display: flex; align-items: center; gap: 12px; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; }
    .content-wrapper { flex: 1; padding: 2rem; }
    
    /* Contenedor de formulario centrado - más ancho para dos columnas */
    .step-form{max-width:1400px;margin:0 auto;background:white;padding:30px;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.08)}
    
    /* Sistema de grid de dos columnas */
    .two-column-grid{display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-bottom:30px}
    .full-width{grid-column:1 / -1}
    
    /* Paneles con borde */
    .column-panel{background:#f8f9fa;padding:20px;border-radius:8px;border:1px solid #e0e0e0}
    .column-panel h4{color:var(--primary);margin:0 0 15px 0;font-size:16px;border-left:4px solid var(--primary-light);padding-left:10px}
    
    .form-group{margin-bottom:24px}
    form label{font-weight:600;color:#555;margin-bottom:8px;font-size:14px;display:block}
    form input, form select, form textarea{width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;font-family:"Inter",sans-serif;font-size:15px;transition:all 0.3s ease}
    form input:focus, form select:focus, form textarea:focus{border-color:var(--primary-light);box-shadow:0 0 0 3px rgba(0,123,255,.15);outline:none}
    form input[type="file"]{padding:8px;background:#f8f9fa;border:2px dashed #ccc;cursor:pointer}
    form input[type="file"]:hover{border-color:var(--primary-light);background:#f0f7ff}
    
    /* Vista previa de archivos */
    .file-preview-container{
      margin-top:15px;
      padding:15px;
      background:#f8f9fa;
      border-radius:8px;
      border:1px solid #e0e0e0;
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn{
      from{opacity:0;transform:translateY(-10px)}
      to{opacity:1;transform:translateY(0)}
    }
    .file-preview-container img{
      max-width:100%;
      max-height:300px;
      border-radius:8px;
      display:block;
      margin:0 auto
    }
    .file-preview-container iframe{
      width:100%;
      height:400px;
      border:none;
      border-radius:8px
    }
    .file-preview-container .pdf-icon{
      text-align:center;
      padding:20px
    }
    .file-preview-container .pdf-icon i{
      font-size:64px;
      color:var(--danger);
      margin-bottom:10px
    }
    .file-preview-container .file-name{
      font-size:14px;
      color:#666;
      margin-top:10px;
      text-align:center;
      word-break:break-all
    }
    .remove-file-btn{
      background:var(--danger);
      color:white;
      border:none;
      padding:6px 12px;
      border-radius:4px;
      cursor:pointer;
      font-size:12px;
      margin-top:10px;
      display:block;
      margin-left:auto;
      margin-right:auto
    }
    .remove-file-btn:hover{background:#c82333}
    .form-actions{margin-top:30px;display:flex;gap:15px;justify-content:flex-end}
    .btn-guardar,.btn-volver{padding:10px 28px;border:none;border-radius:6px;color:white;font-weight:600;font-size:16px;cursor:pointer;transition:background .2s}
    .btn-guardar{background:linear-gradient(90deg,var(--success),#218838)}
    .btn-volver{background:#6c757d}
    .btn-volver:hover{background:#495057}
    .btn-guardar:hover{background:#218838}
    .messages{list-style:none;padding:0;margin:0 0 20px 0}
    .messages li{padding:15px 20px;border-radius:8px;margin-bottom:10px;color:white;font-weight:500;box-shadow:0 2px 8px rgba(0,0,0,0.15)}
    .messages li.success{background:var(--success)}
    .messages li.error{background:var(--danger);color:white;line-height:1.6}
    .close-message{background:none;border:none;color:white;font-size:20px;cursor:pointer;align-self:flex-start;margin-left:15px}
    .required-star{color:var(--danger);margin-left:4px;font-weight:bold}
    
    /* Estilos para campos con error */
    .errorlist{list-style:none;padding:0;margin:5px 0 0 0;color:var(--danger);font-size:13px;font-weight:500}
    .errorlist li{padding:5px 0;display:flex;align-items:center;gap:5px}
    .errorlist li:before{content:"⚠️";font-size:14px}
    .form-control.error, input.error, select.error, textarea.error{border:2px solid var(--danger)!important;background-color:#fff5f5!important;animation:shake 0.3s ease-in-out}
    @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
    
    /* Indicadores de pasos mejorados */
    .step-indicators{display:flex;justify-content:center;gap:20px;margin-bottom:40px;padding:20px;background:white;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.05)}
    .step-indicator{display:flex;align-items:center;gap:10px;padding:12px 24px;border-radius:8px;background:#f8f9fa;color:#999;font-weight:600;transition:all 0.3s ease}
    .step-indicator.active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;box-shadow:0 4px 15px rgba(102,126,234,0.4)}
    .step-indicator.completed{background:var(--success);color:white}
    .step-indicator i{font-size:20px}
    
    /* Alertas de validación */
    .alert-warning{animation:fadeIn 0.3s ease-in}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}

    /* --- ESTILOS RESPONSIVOS --- */
    @media (max-width: 992px) {
      body {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        height: auto;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
      }
      .sidebar h2, .sidebar img {
        display: none; /* Ocultar elementos no esenciales */
      }
      .sidebar a {
        border-left: none;
        border-bottom: 4px solid transparent;
      }
      .sidebar a:hover, .sidebar a.active {
        border-left: none;
        border-bottom: 4px solid #ffffff;
      }
      .main {
        padding: 20px;
      }
      .form-actions {
        flex-direction: column;
      }
      /* Responsive para dos columnas */
      .two-column-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      .step-form {
        max-width: 100%;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
    <!-- ========== SIDEBAR ========== -->
  {% include 'admin/components/admin_sidebar.html' %}

  <!-- ========== MAIN CONTENT ========== -->
  <main class="main-content">
    <!-- TOPBAR -->
    <div class="topbar">
      <div class="topbar-left">
        <h1>{% if modo_edicion %}Editar{% else %}Crear{% endif %} Agente Educativo</h1>
      </div>
      <div class="topbar-right">
        <div class="user-menu">
          <div class="user-avatar">
            {{ request.user.nombres.0 }}{{ request.user.apellidos.0 }}
          </div>
          <div>
            <div style="font-weight: 600; font-size: 14px;">{{ request.user.nombres }}</div>
            <div style="font-size: 12px; color: var(--text-light);">Administrador</div>
          </div>
        </div>
      </div>
    </div>

    <!-- CONTENT -->
    <div class="content-wrapper">

    {% if messages %}
    <ul class="messages">
      {% for message in messages %}
      <li class="{{ message.tags }}">
        {{ message }}
        <button class="close-message">&times;</button>
      </li>
      {% endfor %}
    </ul>
    {% endif %}

    <form method="post" enctype="multipart/form-data" id="madreCreationForm">
      {% csrf_token %}
      
      <!-- Campo oculto para número de convivientes -->
      <input type="hidden" name="num_convivientes" id="hidden_num_convivientes" value="0">

      <!-- ==================== FORMULARIO ÚNICO - TODOS LOS CAMPOS ==================== -->
      <div class="step-form" style="display:block">
        <h2>{% if modo_edicion %}Editar{% else %}Crear{% endif %} Agente Educativo - Formulario Completo</h2>
        <div style="margin: 10px 0 20px 0; padding: 12px; background: #e7f3ff; color: #004085; border-radius: 8px; border: 1px solid #bee5eb; font-size: 15px;">
          <i class="fas fa-info-circle"></i> Los campos marcados con <span class="required-star">*</span> son obligatorios.
        </div>
        <hr style="margin-bottom:20px" />
        
        <!-- ==================== SECCIÓN 1: INFORMACIÓN PERSONAL ==================== -->
        <h3 class="full-width" style="color:var(--primary);margin:25px 0 15px;font-size:18px;border-bottom:2px solid var(--primary-light);padding-bottom:8px">
          <i class="fas fa-user"></i> 1. Información Personal del Agente Educativo
        </h3>
        
        <!-- GRID DE DOS COLUMNAS -->
        <div class="two-column-grid">
          <!-- COLUMNA IZQUIERDA: DATOS DE IDENTIFICACIÓN -->
          <div class="column-panel">
            <h4><i class="fas fa-id-card"></i> Datos de Identificación</h4>
            
            <div class="form-group">
              <label for="{{ usuario_form.tipo_documento.id_for_label }}">{{ usuario_form.tipo_documento.label }} <span class="required-star">*</span></label>
              {{ usuario_form.tipo_documento }}
              {% for error in usuario_form.tipo_documento.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
            
            <div class="form-group">
              <label for="{{ usuario_form.documento.id_for_label }}">{{ usuario_form.documento.label }} <span class="required-star">*</span></label>
              {{ usuario_form.documento }}
              <div id="documento-validation" style="display:none;margin-top:8px;padding:10px;border-radius:6px;"></div>
              {% for error in usuario_form.documento.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
            
            <div class="form-group">
              <label for="{{ usuario_form.nombres.id_for_label }}">{{ usuario_form.nombres.label }} <span class="required-star">*</span></label>
              {{ usuario_form.nombres }}
              {% for error in usuario_form.nombres.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
            
            <div class="form-group">
              <label for="{{ usuario_form.apellidos.id_for_label }}">{{ usuario_form.apellidos.label }} <span class="required-star">*</span></label>
              {{ usuario_form.apellidos }}
              {% for error in usuario_form.apellidos.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
            
            <div class="form-group">
              <label for="{{ usuario_form.fecha_nacimiento.id_for_label }}">{{ usuario_form.fecha_nacimiento.label }} <span class="required-star">*</span></label>
              {{ usuario_form.fecha_nacimiento }}
              <div id="edad-validation" style="margin-top:8px;padding:10px;border-radius:6px;display:none;"></div>
              <small style="color:#666;display:block;margin-top:5px;">{{ usuario_form.fecha_nacimiento.help_text }}</small>
              {% for error in usuario_form.fecha_nacimiento.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
            
            <div class="form-group">
              <label for="{{ usuario_form.sexo.id_for_label }}">{{ usuario_form.sexo.label }} <span class="required-star">*</span></label>
              {{ usuario_form.sexo }}
              {% for error in usuario_form.sexo.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
          </div>
          
          <!-- COLUMNA DERECHA: DATOS DE CONTACTO Y UBICACIÓN -->
          <div class="column-panel">
            <h4><i class="fas fa-phone"></i> Datos de Contacto</h4>
            
            <div class="form-group">
              <label for="{{ usuario_form.correo.id_for_label }}">{{ usuario_form.correo.label }} <span class="required-star">*</span></label>
              {{ usuario_form.correo }}
              {% for error in usuario_form.correo.errors %}<span class="error">{{ error }}</span>{% endfor %}
              <small style="color:#666;display:block;margin-top:5px;">Se usará para notificaciones del sistema</small>
            </div>
            
            <div class="form-group">
              <label for="{{ usuario_form.telefono.id_for_label }}">{{ usuario_form.telefono.label }} {% if usuario_form.telefono.field.required %}<span class="required-star">*</span>{% endif %}</label>
              {{ usuario_form.telefono }}
              {% for error in usuario_form.telefono.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
            
            <h4 style="margin-top:25px"><i class="fas fa-map-marker-alt"></i> Ubicación de Residencia</h4>
            
            <div class="form-group">
              <label for="{{ usuario_form.departamento_residencia.id_for_label }}">{{ usuario_form.departamento_residencia.label }} <span class="required-star">*</span></label>
              {{ usuario_form.departamento_residencia }}
              {% for error in usuario_form.departamento_residencia.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
            
            <div class="form-group">
              <label for="{{ usuario_form.ciudad_residencia.id_for_label }}">{{ usuario_form.ciudad_residencia.label }} <span class="required-star">*</span></label>
              {{ usuario_form.ciudad_residencia }}
              {% for error in usuario_form.ciudad_residencia.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
            
            <div class="form-group" id="localidad-madre-group" style="display:none;">
              <label for="id_localidad_bogota_madre"><i class="fas fa-map"></i> Localidad (solo Bogotá) <span class="required-star">*</span></label>
              <select name="localidad_bogota_madre" id="id_localidad_bogota_madre" class="form-control" required>
                <option value="">-- Seleccione una Localidad --</option>
                {% for localidad in localidades_bogota %}
                  <option value="{{ localidad.id }}">{{ localidad.numero }}. {{ localidad.nombre }}</option>
                {% endfor %}
              </select>
              {% for error in usuario_form.localidad_bogota.errors %}<span class="error">{{ error }}</span>{% endfor %}
              <small style="color:#666;display:block;margin-top:5px;">Solo aplica si reside en Bogotá D.C.</small>
            </div>
            
            <div class="form-group" id="barrio-madre-group" style="display:none;">
              <label for="id_barrio_madre"><i class="fas fa-map-signs"></i> Barrio <span class="required-star">*</span></label>
              <select name="barrio" id="id_barrio_madre" class="form-control" required>
                <option value="">-- Seleccione un Barrio --</option>
              </select>
              {% for error in usuario_form.barrio.errors %}<span class="error">{{ error }}</span>{% endfor %}
              <small style="color:#666;display:block;margin-top:5px;">Se cargará dinámicamente según la localidad seleccionada</small>
            </div>
          </div>
        </div>        <!-- ==================== SECCIÓN 2: INFORMACIÓN ACADÉMICA Y DOCUMENTOS ==================== -->
        <h3 class="full-width" style="color:var(--primary);margin:40px 0 15px;font-size:18px;border-bottom:2px solid var(--primary-light);padding-bottom:8px">
          <i class="fas fa-graduation-cap"></i> 2. Información Académica y Documentos del Agente Educativo
        </h3>

        <!-- GRID DE DOS COLUMNAS -->
        <div class="two-column-grid">
          <!-- COLUMNA IZQUIERDA: FORMACIÓN ACADÉMICA -->
          <div class="column-panel">
            <h4><i class="fas fa-user-graduate"></i> Formación Académica</h4>
            
            <div class="form-group">
              <label for="{{ madre_profile_form.nivel_escolaridad.id_for_label }}">{{ madre_profile_form.nivel_escolaridad.label }} <span class="required-star">*</span></label>
              {{ madre_profile_form.nivel_escolaridad }}
              {% for error in madre_profile_form.nivel_escolaridad.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
            
            <div class="form-group">
              <label for="{{ madre_profile_form.titulo_obtenido.id_for_label }}">{{ madre_profile_form.titulo_obtenido.label }}</label>
              {{ madre_profile_form.titulo_obtenido }}
              {% for error in madre_profile_form.titulo_obtenido.errors %}<span class="error">{{ error }}</span>{% endfor %}
              <small style="color:#666;display:block;margin-top:5px;">Opcional: Especifique el título académico obtenido</small>
            </div>
            
            <div class="form-group">
              <label for="{{ madre_profile_form.institucion.id_for_label }}">{{ madre_profile_form.institucion.label }}</label>
              {{ madre_profile_form.institucion }}
              {% for error in madre_profile_form.institucion.errors %}<span class="error">{{ error }}</span>{% endfor %}
              <small style="color:#666;display:block;margin-top:5px;">Opcional: Nombre de la institución educativa</small>
            </div>
            
            <div class="form-group">
              <label for="{{ madre_profile_form.experiencia_previa.id_for_label }}">{{ madre_profile_form.experiencia_previa.label }}</label>
              {{ madre_profile_form.experiencia_previa }}
              {% for error in madre_profile_form.experiencia_previa.errors %}<span class="error">{{ error }}</span>{% endfor %}
              <small style="color:#666;display:block;margin-top:5px;">Describa su experiencia trabajando con niños</small>
            </div>
          </div>
          
          <!-- COLUMNA DERECHA: CERTIFICADO LABORAL Y DECLARACIONES -->
          <div class="column-panel">
            <h4><i class="fas fa-file-certificate"></i> Certificado Laboral</h4>
            
            <div class="form-group">
              <label for="{{ madre_profile_form.certificado_laboral.id_for_label }}">
                Certificado Laboral <span class="required-star">*</span>
              </label>
              
              <!-- PREVIEW DE NUEVA CARGA (ARRIBA DEL INPUT) -->
              <div id="preview-certificado_laboral" class="file-preview-container" style="display:none;margin-bottom:15px;padding:15px;background:#e0f5ff;border:2px solid #0369a1;border-radius:8px;">
                <div style="text-align:center;margin-bottom:15px;">
                  <span style="background:#0369a1;color:white;padding:6px 12px;border-radius:4px;font-size:12px;font-weight:600;">✓ Vista Previa</span>
                </div>
                <div class="image-container" style="text-align:center;display:none;margin-bottom:10px;">
                  <img class="preview-image" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;margin:0 auto;display:block;" />
                </div>
                <div class="pdf-preview" style="display:none;background:white;padding:20px;border-radius:6px;">
                  <div class="pdf-icon" style="text-align:center;">
                    <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                    <div class="file-name" style="font-size:12px;color:#666;margin-top:8px;"></div>
                  </div>
                  <iframe class="pdf-frame" style="display:none;width:100%;height:400px;border:none;border-radius:6px;margin-top:10px;"></iframe>
                </div>
                <button type="button" class="remove-file-btn" onclick="removeFile('certificado_laboral')" style="margin-top:10px;padding:8px 16px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;">✕ Eliminar archivo</button>
              </div>
              
              <!-- ARCHIVO GUARDADO ACTUALMENTE (si existe) -->
              {% if madre_profile_form.instance.certificado_laboral %}
                <div id="existing-certificado_laboral" style="background:#e0f2fe;padding:10px;border-radius:6px;margin-bottom:10px;border-left:4px solid #0369a1;">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    <p style="margin:0;color:#0369a1;font-size:14px;">
                      <i class="fas fa-check-circle"></i> <strong>Archivo actual:</strong> {{ madre_profile_form.instance.certificado_laboral.name|truncatewords:3 }}
                    </p>
                    <small style="color:#0c4a6e;font-size:11px;">Si no lo cambias, se mantendrá</small>
                  </div>
                  <!-- PREVIEW DE LA IMAGEN GUARDADA -->
                  <div style="margin-bottom:10px;text-align:center;">
                    {% if madre_profile_form.instance.certificado_laboral %}
                      {% if madre_profile_form.instance.certificado_laboral.name|lower|endswith:'.pdf' %}
                        <div style="padding:20px;background:white;border-radius:6px;display:flex;flex-direction:column;align-items:center;">
                          <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                          <p style="margin:0;font-size:12px;color:#666;">{{ madre_profile_form.instance.certificado_laboral.name }}</p>
                          <a href="{{ madre_profile_form.instance.certificado_laboral.url }}" target="_blank" style="margin-top:8px;padding:6px 12px;background:#2563eb;color:white;border-radius:4px;text-decoration:none;font-size:12px;font-weight:600;">
                            <i class="fas fa-eye"></i> Ver PDF
                          </a>
                        </div>
                      {% else %}
                        <img src="{{ madre_profile_form.instance.certificado_laboral.url }}" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;display:block;margin:0 auto;" alt="Documento actual">
                      {% endif %}
                    {% endif %}
                  </div>
                  <label style="display:flex;align-items:center;color:#0c4a6e;font-size:12px;cursor:pointer;">
                    <input type="checkbox" name="clear_certificado_laboral" style="margin-right:8px;"> 
                    <span>Borrar este archivo</span>
                  </label>
                </div>
              {% endif %}
              
              <!-- INPUT DE ARCHIVO -->
              <input type="file" name="certificado_laboral" id="{{ madre_profile_form.certificado_laboral.id_for_label }}" 
                     accept="application/pdf,image/*"
                     onchange="previewFile(this, 'certificado_laboral')"
                     required>
              
              {% for error in madre_profile_form.certificado_laboral.errors %}<span class="error">{{ error }}</span>{% endfor %}
              <small style="color:#666;display:block;margin-top:5px;">Certificado que acredite experiencia con niños</small>
            </div>
            
            <h4 style="margin-top:20px"><i class="fas fa-check-circle"></i> Declaraciones</h4>
            
            <div class="form-group">
              <div style="display:flex;align-items:flex-start;gap:10px;padding:15px;background-color:#e8f4f8;border-radius:8px;border-left:4px solid var(--primary-light);">
                <label for="{{ madre_profile_form.no_retirado_icbf.id_for_label }}" style="margin:0;cursor:pointer;flex:1;order:1;">
                  <strong>Declaro que no he sido retirado del programa ICBF <span class="required-star">*</span></strong>
                  <br><small style="color:#666;">No haber sido retirado de otros servicios de atención a la primera infancia por incumplimiento de mis obligaciones y de los Lineamientos del Programa. Confirmo que nunca he sido desvinculado del programa.</small>
                </label>
                <div style="order:2;">
                  {{ madre_profile_form.no_retirado_icbf }}
                </div>
              </div>
              {% for error in madre_profile_form.no_retirado_icbf.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
          </div>
        </div>
        
        <!-- CARTA DE DISPONIBILIDAD (ANCHO COMPLETO) -->
        <div class="full-width">
          <div class="form-group">
            <label for="{{ madre_profile_form.carta_disponibilidad.id_for_label }}">
              <i class="fas fa-file-contract"></i> Carta de Disponibilidad de Tiempo Completo <span class="required-star">*</span>
            </label>
            {% if madre_profile_form.instance.carta_disponibilidad %}
              <div id="existing-carta_disponibilidad" style="background:#e0f2fe;padding:10px;border-radius:6px;margin-bottom:10px;border-left:4px solid #0369a1;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                  <p style="margin:0;color:#0369a1;font-size:14px;">
                    <i class="fas fa-check-circle"></i> <strong>Archivo actual:</strong> {{ madre_profile_form.instance.carta_disponibilidad.name|truncatewords:3 }}
                  </p>
                  <small style="color:#0c4a6e;font-size:11px;">Si no lo cambias, se mantendrá</small>
                </div>
                <!-- PREVIEW DE LA IMAGEN GUARDADA -->
                <div style="margin-bottom:10px;text-align:center;">
                  {% if madre_profile_form.instance.carta_disponibilidad %}
                    {% if madre_profile_form.instance.carta_disponibilidad.name|lower|endswith:'.pdf' %}
                      <div style="padding:20px;background:white;border-radius:6px;display:flex;flex-direction:column;align-items:center;">
                        <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                        <p style="margin:0;font-size:12px;color:#666;">{{ madre_profile_form.instance.carta_disponibilidad.name }}</p>
                        <a href="{{ madre_profile_form.instance.carta_disponibilidad.url }}" target="_blank" style="margin-top:8px;padding:6px 12px;background:#2563eb;color:white;border-radius:4px;text-decoration:none;font-size:12px;font-weight:600;">
                          <i class="fas fa-eye"></i> Ver PDF
                        </a>
                      </div>
                    {% else %}
                      <img src="{{ madre_profile_form.instance.carta_disponibilidad.url }}" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;display:block;margin:0 auto;" alt="Documento actual">
                    {% endif %}
                  {% endif %}
                </div>
                <label style="display:flex;align-items:center;color:#0c4a6e;font-size:12px;cursor:pointer;">
                  <input type="checkbox" name="clear_carta_disponibilidad" style="margin-right:8px;"> 
                  <span>Borrar este archivo</span>
                </label>
              </div>
            {% endif %}
            <input type="file" name="carta_disponibilidad" id="{{ madre_profile_form.carta_disponibilidad.id_for_label }}" 
                   accept="application/pdf,image/*"
                   onchange="previewFile(this, 'carta_disponibilidad')"
                   required>
            <div id="preview-carta_disponibilidad" class="file-preview-container" style="display:none;margin-top:15px;padding:15px;background:#e0f5ff;border:2px solid #0369a1;border-radius:8px;">
              <div style="text-align:center;margin-bottom:15px;">
                <span style="background:#0369a1;color:white;padding:6px 12px;border-radius:4px;font-size:12px;font-weight:600;">✓ Vista Previa</span>
              </div>
              <div class="image-container" style="text-align:center;display:none;margin-bottom:10px;">
                <img class="preview-image" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;margin:0 auto;display:block;" />
              </div>
              <div class="pdf-preview" style="display:none;background:white;padding:20px;border-radius:6px;">
                <div class="pdf-icon" style="text-align:center;">
                  <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                  <div class="file-name" style="font-size:12px;color:#666;margin-top:8px;"></div>
                </div>
                <iframe class="pdf-frame" style="display:none;width:100%;height:400px;border:none;border-radius:6px;margin-top:10px;"></iframe>
              </div>
              <button type="button" class="remove-file-btn" onclick="removeFile('carta_disponibilidad')" style="margin-top:10px;padding:8px 16px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;">✕ Eliminar archivo</button>
            </div>
            {% for error in madre_profile_form.carta_disponibilidad.errors %}<span class="error">{{ error }}</span>{% endfor %}
            <small style="color:#666;display:block;margin-top:5px;">Carta donde confirma disponibilidad para atender el hogar comunitario</small>
          </div>
        </div>

        <!-- Subsección: Autorización de Datos Personales -->
        <h4 style="color:var(--primary);margin:20px 0 10px;font-size:16px;border-left:4px solid var(--primary-light);padding-left:10px">
          <i class="fas fa-shield-alt"></i> Protección de Datos Personales
        </h4>
        
        <div class="form-group">
          <div style="padding:15px;background-color:#fff3cd;border-radius:8px;border-left:4px solid #ffc107;">
            <p style="margin:0 0 10px 0;color:#856404;">
              <i class="fas fa-info-circle"></i> <strong>Autorización para el tratamiento de datos personales</strong>
            </p>
            <p style="margin:0;font-size:14px;color:#666;line-height:1.6;">
              Autorizo de manera libre, voluntaria, previa, explícita e informada al ICBF para que, en los términos legalmente establecidos, 
              realice la recolección, almacenamiento, uso, circulación, supresión y en general, el tratamiento de los datos personales 
              que he proporcionado en este formulario, para las finalidades relacionadas con la gestión de hogares comunitarios, 
              atención a la niñez, y demás procesos propios del programa. Declaro que he sido informado sobre mi derecho a conocer, 
              actualizar, rectificar y suprimir mis datos personales, así como revocar esta autorización en los casos en que sea procedente.
            </p>
          </div>
        </div>

        <!-- Subsección: Documentos Personales -->
        <h4 style="color:var(--primary);margin:20px 0 10px;font-size:16px;border-left:4px solid var(--primary-light);padding-left:10px">
          <i class="fas fa-file-upload"></i> Documentos Personales
        </h4>
        
        <!-- Fila: Foto y Firma -->
        <div class="row" style="display:flex;gap:15px;margin-bottom:24px;">
          <!-- Foto del Agente Educativo -->
          <div class="form-group" style="flex:1;margin-bottom:0;">
            <label for="{{ madre_profile_form.foto_madre.id_for_label }}">
              <i class="fas fa-camera"></i> Foto del Agente Educativo <span class="required-star">*</span>
            </label>
            {% if madre_profile_form.instance.foto_madre %}
              <div id="existing-foto_madre" style="background:#e0f2fe;padding:10px;border-radius:6px;margin-bottom:10px;border-left:4px solid #0369a1;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                  <p style="margin:0;color:#0369a1;font-size:14px;">
                    <i class="fas fa-check-circle"></i> <strong>Archivo actual:</strong> {{ madre_profile_form.instance.foto_madre.name|truncatewords:3 }}
                  </p>
                  <small style="color:#0c4a6e;font-size:11px;">Si no lo cambias, se mantendrá</small>
                </div>
                <!-- PREVIEW DE LA IMAGEN GUARDADA -->
                <div style="margin-bottom:10px;text-align:center;">
                  {% if madre_profile_form.instance.foto_madre %}
                    {% if madre_profile_form.instance.foto_madre.name|lower|endswith:'.pdf' %}
                      <div style="padding:20px;background:white;border-radius:6px;display:flex;flex-direction:column;align-items:center;">
                        <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                        <p style="margin:0;font-size:12px;color:#666;">{{ madre_profile_form.instance.foto_madre.name }}</p>
                        <a href="{{ madre_profile_form.instance.foto_madre.url }}" target="_blank" style="margin-top:8px;padding:6px 12px;background:#2563eb;color:white;border-radius:4px;text-decoration:none;font-size:12px;font-weight:600;">
                          <i class="fas fa-eye"></i> Ver PDF
                        </a>
                      </div>
                    {% else %}
                      <img src="{{ madre_profile_form.instance.foto_madre.url }}" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;display:block;margin:0 auto;" alt="Foto actual">
                    {% endif %}
                  {% endif %}
                </div>
                <label style="display:flex;align-items:center;color:#0c4a6e;font-size:12px;cursor:pointer;">
                  <input type="checkbox" name="clear_foto_madre" style="margin-right:8px;"> 
                  <span>Borrar este archivo</span>
                </label>
              </div>
            {% endif %}
            <input type="file" name="foto_madre" id="{{ madre_profile_form.foto_madre.id_for_label }}" 
                   accept="image/*,application/pdf"
                   onchange="previewFile(this, 'foto_madre')"
                   {% if madre_profile_form.foto_madre.field.required %}required{% endif %}>
            <div id="preview-foto_madre" class="file-preview-container" style="display:none;margin-top:15px;padding:15px;background:#e0f5ff;border:2px solid #0369a1;border-radius:8px;">
              <div style="text-align:center;margin-bottom:15px;">
                <span style="background:#0369a1;color:white;padding:6px 12px;border-radius:4px;font-size:12px;font-weight:600;">✓ Vista Previa</span>
              </div>
              <div class="image-container" style="text-align:center;display:none;margin-bottom:10px;">
                <img class="preview-image" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;margin:0 auto;display:block;" />
              </div>
              <div class="pdf-preview" style="display:none;background:white;padding:20px;border-radius:6px;">
                <div class="pdf-icon" style="text-align:center;">
                  <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                  <div class="file-name" style="font-size:12px;color:#666;margin-top:8px;"></div>
                </div>
                <iframe class="pdf-frame" style="display:none;width:100%;height:400px;border:none;border-radius:6px;margin-top:10px;"></iframe>
              </div>
              <button type="button" class="remove-file-btn" onclick="removeFile('foto_madre')" style="margin-top:10px;padding:8px 16px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;">✕ Eliminar archivo</button>
            </div>
            {% for error in madre_profile_form.foto_madre.errors %}<span class="error">{{ error }}</span>{% endfor %}
            <small style="color:#666;display:block;margin-top:5px;">Foto reciente tipo documento</small>
          </div>
          
          <!-- Firma Digital -->
          <div class="form-group" style="flex:1;margin-bottom:0;">
            <label for="{{ madre_profile_form.firma_digital.id_for_label }}">
              <i class="fas fa-signature"></i> {{ madre_profile_form.firma_digital.label }}
            </label>
            {% if madre_profile_form.instance.firma_digital %}
              <div id="existing-firma_digital" style="background:#e0f2fe;padding:10px;border-radius:6px;margin-bottom:10px;border-left:4px solid #0369a1;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                  <p style="margin:0;color:#0369a1;font-size:14px;">
                    <i class="fas fa-check-circle"></i> <strong>Archivo actual:</strong> {{ madre_profile_form.instance.firma_digital.name|truncatewords:3 }}
                  </p>
                  <small style="color:#0c4a6e;font-size:11px;">Si no lo cambias, se mantendrá</small>
                </div>
                <!-- PREVIEW DE LA IMAGEN GUARDADA -->
                <div style="margin-bottom:10px;text-align:center;">
                  {% if madre_profile_form.instance.firma_digital %}
                    {% if madre_profile_form.instance.firma_digital.name|lower|endswith:'.pdf' %}
                      <div style="padding:20px;background:white;border-radius:6px;display:flex;flex-direction:column;align-items:center;">
                        <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                        <p style="margin:0;font-size:12px;color:#666;">{{ madre_profile_form.instance.firma_digital.name }}</p>
                        <a href="{{ madre_profile_form.instance.firma_digital.url }}" target="_blank" style="margin-top:8px;padding:6px 12px;background:#2563eb;color:white;border-radius:4px;text-decoration:none;font-size:12px;font-weight:600;">
                          <i class="fas fa-eye"></i> Ver PDF
                        </a>
                      </div>
                    {% else %}
                      <img src="{{ madre_profile_form.instance.firma_digital.url }}" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;display:block;margin:0 auto;" alt="Firma actual">
                    {% endif %}
                  {% endif %}
                </div>
                <label style="display:flex;align-items:center;color:#0c4a6e;font-size:12px;cursor:pointer;">
                  <input type="checkbox" name="clear_firma_digital" style="margin-right:8px;"> 
                  <span>Borrar este archivo</span>
                </label>
              </div>
            {% endif %}
            <input type="file" name="firma_digital" id="{{ madre_profile_form.firma_digital.id_for_label }}" 
                   accept="image/*,application/pdf"
                   onchange="previewFile(this, 'firma_digital')">
            <div id="preview-firma_digital" class="file-preview-container" style="display:none;margin-top:15px;padding:15px;background:#e0f5ff;border:2px solid #0369a1;border-radius:8px;">
              <div style="text-align:center;margin-bottom:15px;">
                <span style="background:#0369a1;color:white;padding:6px 12px;border-radius:4px;font-size:12px;font-weight:600;">✓ Vista Previa</span>
              </div>
              <div class="image-container" style="text-align:center;display:none;margin-bottom:10px;">
                <img class="preview-image" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;margin:0 auto;display:block;" />
              </div>
              <div class="pdf-preview" style="display:none;background:white;padding:20px;border-radius:6px;">
                <div class="pdf-icon" style="text-align:center;">
                  <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                  <div class="file-name" style="font-size:12px;color:#666;margin-top:8px;"></div>
                </div>
                <iframe class="pdf-frame" style="display:none;width:100%;height:400px;border:none;border-radius:6px;margin-top:10px;"></iframe>
              </div>
              <button type="button" class="remove-file-btn" onclick="removeFile('firma_digital')" style="margin-top:10px;padding:8px 16px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;">✕ Eliminar archivo</button>
            </div>
            {% for error in madre_profile_form.firma_digital.errors %}<span class="error">{{ error }}</span>{% endfor %}
            <small style="color:#666;display:block;margin-top:5px;">Firma escaneada o digital (opcional)</small>
          </div>
        </div>

        <!-- Sección: Documentos de Soporte -->
        <h3 style="color:var(--primary);margin:25px 0 15px;font-size:18px;border-bottom:2px solid var(--primary-light);padding-bottom:8px">
          <i class="fas fa-folder-open"></i> Documentos de Soporte
        </h3>
        
        <!-- Documento de Identidad -->
        <div class="form-group">
          <label for="{{ madre_profile_form.documento_identidad_pdf.id_for_label }}">
            <i class="fas fa-id-card"></i> {{ madre_profile_form.documento_identidad_pdf.label }} <span class="required-star">*</span>
          </label>
          {% if madre_profile_form.instance.documento_identidad_pdf %}
            <div id="existing-documento_identidad_pdf" style="background:#e0f2fe;padding:10px;border-radius:6px;margin-bottom:10px;border-left:4px solid #0369a1;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <p style="margin:0;color:#0369a1;font-size:14px;">
                  <i class="fas fa-check-circle"></i> <strong>Archivo actual:</strong> {{ madre_profile_form.instance.documento_identidad_pdf.name|truncatewords:3 }}
                </p>
                <small style="color:#0c4a6e;font-size:11px;">Si no lo cambias, se mantendrá</small>
              </div>
              <!-- PREVIEW DE LA IMAGEN GUARDADA -->
              <div style="margin-bottom:10px;text-align:center;">
                {% if madre_profile_form.instance.documento_identidad_pdf %}
                  {% if madre_profile_form.instance.documento_identidad_pdf.name|lower|endswith:'.pdf' %}
                    <div style="padding:20px;background:white;border-radius:6px;display:flex;flex-direction:column;align-items:center;">
                      <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                      <p style="margin:0;font-size:12px;color:#666;">{{ madre_profile_form.instance.documento_identidad_pdf.name }}</p>
                      <a href="{{ madre_profile_form.instance.documento_identidad_pdf.url }}" target="_blank" style="margin-top:8px;padding:6px 12px;background:#2563eb;color:white;border-radius:4px;text-decoration:none;font-size:12px;font-weight:600;">
                        <i class="fas fa-eye"></i> Ver PDF
                      </a>
                    </div>
                  {% else %}
                    <img src="{{ madre_profile_form.instance.documento_identidad_pdf.url }}" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;display:block;margin:0 auto;" alt="Documento actual">
                  {% endif %}
                {% endif %}
              </div>
              <label style="display:flex;align-items:center;color:#0c4a6e;font-size:12px;cursor:pointer;">
                <input type="checkbox" name="clear_documento_identidad_pdf" style="margin-right:8px;"> 
                <span>Borrar este archivo</span>
              </label>
            </div>
          {% endif %}
             <input type="file" name="documento_identidad_pdf" id="{{ madre_profile_form.documento_identidad_pdf.id_for_label }}" 
               accept="application/pdf,image/*"
               onchange="previewFile(this, 'documento_identidad_pdf')" required>
          <div id="preview-documento_identidad_pdf" class="file-preview-container" style="display:none;margin-top:15px;padding:15px;background:#e0f5ff;border:2px solid #0369a1;border-radius:8px;">
            <div style="text-align:center;margin-bottom:15px;">
              <span style="background:#0369a1;color:white;padding:6px 12px;border-radius:4px;font-size:12px;font-weight:600;">✓ Vista Previa</span>
            </div>
            <div class="image-container" style="text-align:center;display:none;margin-bottom:10px;">
              <img class="preview-image" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;margin:0 auto;display:block;" />
            </div>
            <div class="pdf-preview" style="display:none;background:white;padding:20px;border-radius:6px;">
              <div class="pdf-icon" style="text-align:center;">
                <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                <div class="file-name" style="font-size:12px;color:#666;margin-top:8px;"></div>
              </div>
              <iframe class="pdf-frame" style="display:none;width:100%;height:400px;border:none;border-radius:6px;margin-top:10px;"></iframe>
            </div>
            <button type="button" class="remove-file-btn" onclick="removeFile('documento_identidad_pdf')" style="margin-top:10px;padding:8px 16px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;">✕ Eliminar archivo</button>
          </div>
          {% for error in madre_profile_form.documento_identidad_pdf.errors %}<span class="error">{{ error }}</span>{% endfor %}
        </div>
        
        <!-- Certificado de Escolaridad -->
        <div class="form-group">
          <label for="{{ madre_profile_form.certificado_escolaridad_pdf.id_for_label }}">
            <i class="fas fa-certificate"></i> {{ madre_profile_form.certificado_escolaridad_pdf.label }} <span class="required-star">*</span>
          </label>
          {% if madre_profile_form.instance.certificado_escolaridad_pdf %}
            <div id="existing-certificado_escolaridad_pdf" style="background:#e0f2fe;padding:10px;border-radius:6px;margin-bottom:10px;border-left:4px solid #0369a1;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <p style="margin:0;color:#0369a1;font-size:14px;">
                  <i class="fas fa-check-circle"></i> <strong>Archivo actual:</strong> {{ madre_profile_form.instance.certificado_escolaridad_pdf.name|truncatewords:3 }}
                </p>
                <small style="color:#0c4a6e;font-size:11px;">Si no lo cambias, se mantendrá</small>
              </div>
              <!-- PREVIEW DE LA IMAGEN GUARDADA -->
              <div style="margin-bottom:10px;text-align:center;">
                {% if madre_profile_form.instance.certificado_escolaridad_pdf %}
                  {% if madre_profile_form.instance.certificado_escolaridad_pdf.name|lower|endswith:'.pdf' %}
                    <div style="padding:20px;background:white;border-radius:6px;display:flex;flex-direction:column;align-items:center;">
                      <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                      <p style="margin:0;font-size:12px;color:#666;">{{ madre_profile_form.instance.certificado_escolaridad_pdf.name }}</p>
                      <a href="{{ madre_profile_form.instance.certificado_escolaridad_pdf.url }}" target="_blank" style="margin-top:8px;padding:6px 12px;background:#2563eb;color:white;border-radius:4px;text-decoration:none;font-size:12px;font-weight:600;">
                        <i class="fas fa-eye"></i> Ver PDF
                      </a>
                    </div>
                  {% else %}
                    <img src="{{ madre_profile_form.instance.certificado_escolaridad_pdf.url }}" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;display:block;margin:0 auto;" alt="Documento actual">
                  {% endif %}
                {% endif %}
              </div>
              <label style="display:flex;align-items:center;color:#0c4a6e;font-size:12px;cursor:pointer;">
                <input type="checkbox" name="clear_certificado_escolaridad_pdf" style="margin-right:8px;"> 
                <span>Borrar este archivo</span>
              </label>
            </div>
          {% endif %}
             <input type="file" name="certificado_escolaridad_pdf" id="{{ madre_profile_form.certificado_escolaridad_pdf.id_for_label }}" 
               accept="application/pdf,image/*"
               onchange="previewFile(this, 'certificado_escolaridad_pdf')" required>
          <div id="preview-certificado_escolaridad_pdf" class="file-preview-container" style="display:none;margin-top:15px;padding:15px;background:#e0f5ff;border:2px solid #0369a1;border-radius:8px;">
            <div style="text-align:center;margin-bottom:15px;">
              <span style="background:#0369a1;color:white;padding:6px 12px;border-radius:4px;font-size:12px;font-weight:600;">✓ Vista Previa</span>
            </div>
            <div class="image-container" style="text-align:center;display:none;margin-bottom:10px;">
              <img class="preview-image" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;margin:0 auto;display:block;" />
            </div>
            <div class="pdf-preview" style="display:none;background:white;padding:20px;border-radius:6px;">
              <div class="pdf-icon" style="text-align:center;">
                <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                <div class="file-name" style="font-size:12px;color:#666;margin-top:8px;"></div>
              </div>
              <iframe class="pdf-frame" style="display:none;width:100%;height:400px;border:none;border-radius:6px;margin-top:10px;"></iframe>
            </div>
            <button type="button" class="remove-file-btn" onclick="removeFile('certificado_escolaridad_pdf')" style="margin-top:10px;padding:8px 16px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;">✕ Eliminar archivo</button>
          </div>
          {% for error in madre_profile_form.certificado_escolaridad_pdf.errors %}<span class="error">{{ error }}</span>{% endfor %}
        </div>
        
        <!-- Certificado de Antecedentes -->
        <div class="form-group">
          <label for="{{ madre_profile_form.certificado_antecedentes_pdf.id_for_label }}">
            <i class="fas fa-shield-alt"></i> {{ madre_profile_form.certificado_antecedentes_pdf.label }} <span class="required-star">*</span>
          </label>
          {% if madre_profile_form.instance.certificado_antecedentes_pdf %}
            <div id="existing-certificado_antecedentes_pdf" style="background:#e0f2fe;padding:10px;border-radius:6px;margin-bottom:10px;border-left:4px solid #0369a1;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <p style="margin:0;color:#0369a1;font-size:14px;">
                  <i class="fas fa-check-circle"></i> <strong>Archivo actual:</strong> {{ madre_profile_form.instance.certificado_antecedentes_pdf.name|truncatewords:3 }}
                </p>
                <small style="color:#0c4a6e;font-size:11px;">Si no lo cambias, se mantendrá</small>
              </div>
              <!-- PREVIEW DE LA IMAGEN GUARDADA -->
              <div style="margin-bottom:10px;text-align:center;">
                {% if madre_profile_form.instance.certificado_antecedentes_pdf %}
                  {% if madre_profile_form.instance.certificado_antecedentes_pdf.name|lower|endswith:'.pdf' %}
                    <div style="padding:20px;background:white;border-radius:6px;display:flex;flex-direction:column;align-items:center;">
                      <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                      <p style="margin:0;font-size:12px;color:#666;">{{ madre_profile_form.instance.certificado_antecedentes_pdf.name }}</p>
                      <a href="{{ madre_profile_form.instance.certificado_antecedentes_pdf.url }}" target="_blank" style="margin-top:8px;padding:6px 12px;background:#2563eb;color:white;border-radius:4px;text-decoration:none;font-size:12px;font-weight:600;">
                        <i class="fas fa-eye"></i> Ver PDF
                      </a>
                    </div>
                  {% else %}
                    <img src="{{ madre_profile_form.instance.certificado_antecedentes_pdf.url }}" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;display:block;margin:0 auto;" alt="Documento actual">
                  {% endif %}
                {% endif %}
              </div>
              <label style="display:flex;align-items:center;color:#0c4a6e;font-size:12px;cursor:pointer;">
                <input type="checkbox" name="clear_certificado_antecedentes_pdf" style="margin-right:8px;"> 
                <span>Borrar este archivo</span>
              </label>
            </div>
          {% endif %}
             <input type="file" name="certificado_antecedentes_pdf" id="{{ madre_profile_form.certificado_antecedentes_pdf.id_for_label }}" 
               accept="application/pdf,image/*"
               onchange="previewFile(this, 'certificado_antecedentes_pdf')" required>
          <div id="preview-certificado_antecedentes_pdf" class="file-preview-container" style="display:none;margin-top:15px;padding:15px;background:#e0f5ff;border:2px solid #0369a1;border-radius:8px;">
            <div style="text-align:center;margin-bottom:15px;">
              <span style="background:#0369a1;color:white;padding:6px 12px;border-radius:4px;font-size:12px;font-weight:600;">✓ Vista Previa</span>
            </div>
            <div class="image-container" style="text-align:center;display:none;margin-bottom:10px;">
              <img class="preview-image" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;margin:0 auto;display:block;" />
            </div>
            <div class="pdf-preview" style="display:none;background:white;padding:20px;border-radius:6px;">
              <div class="pdf-icon" style="text-align:center;">
                <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                <div class="file-name" style="font-size:12px;color:#666;margin-top:8px;"></div>
              </div>
              <iframe class="pdf-frame" style="display:none;width:100%;height:400px;border:none;border-radius:6px;margin-top:10px;"></iframe>
            </div>
            <button type="button" class="remove-file-btn" onclick="removeFile('certificado_antecedentes_pdf')" style="margin-top:10px;padding:8px 16px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;">✕ Eliminar archivo</button>
          </div>
          {% for error in madre_profile_form.certificado_antecedentes_pdf.errors %}<span class="error">{{ error }}</span>{% endfor %}
        </div>
        
        <!-- Certificado Médico -->
        <div class="form-group">
          <label for="{{ madre_profile_form.certificado_medico_pdf.id_for_label }}">
            <i class="fas fa-heartbeat"></i> {{ madre_profile_form.certificado_medico_pdf.label }} <span class="required-star">*</span>
          </label>
          {% if madre_profile_form.instance.certificado_medico_pdf %}
            <div id="existing-certificado_medico_pdf" style="background:#e0f2fe;padding:10px;border-radius:6px;margin-bottom:10px;border-left:4px solid #0369a1;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <p style="margin:0;color:#0369a1;font-size:14px;">
                  <i class="fas fa-check-circle"></i> <strong>Archivo actual:</strong> {{ madre_profile_form.instance.certificado_medico_pdf.name|truncatewords:3 }}
                </p>
                <small style="color:#0c4a6e;font-size:11px;">Si no lo cambias, se mantendrá</small>
              </div>
              <!-- PREVIEW DE LA IMAGEN GUARDADA -->
              <div style="margin-bottom:10px;text-align:center;">
                {% if madre_profile_form.instance.certificado_medico_pdf %}
                  {% if madre_profile_form.instance.certificado_medico_pdf.name|lower|endswith:'.pdf' %}
                    <div style="padding:20px;background:white;border-radius:6px;display:flex;flex-direction:column;align-items:center;">
                      <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                      <p style="margin:0;font-size:12px;color:#666;">{{ madre_profile_form.instance.certificado_medico_pdf.name }}</p>
                      <a href="{{ madre_profile_form.instance.certificado_medico_pdf.url }}" target="_blank" style="margin-top:8px;padding:6px 12px;background:#2563eb;color:white;border-radius:4px;text-decoration:none;font-size:12px;font-weight:600;">
                        <i class="fas fa-eye"></i> Ver PDF
                      </a>
                    </div>
                  {% else %}
                    <img src="{{ madre_profile_form.instance.certificado_medico_pdf.url }}" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;display:block;margin:0 auto;" alt="Documento actual">
                  {% endif %}
                {% endif %}
              </div>
              <label style="display:flex;align-items:center;color:#0c4a6e;font-size:12px;cursor:pointer;">
                <input type="checkbox" name="clear_certificado_medico_pdf" style="margin-right:8px;"> 
                <span>Borrar este archivo</span>
              </label>
            </div>
          {% endif %}
             <input type="file" name="certificado_medico_pdf" id="{{ madre_profile_form.certificado_medico_pdf.id_for_label }}" 
               accept="application/pdf,image/*"
               onchange="previewFile(this, 'certificado_medico_pdf')" required>
          <div id="preview-certificado_medico_pdf" class="file-preview-container" style="display:none;margin-top:15px;padding:15px;background:#e0f5ff;border:2px solid #0369a1;border-radius:8px;">
            <div style="text-align:center;margin-bottom:15px;">
              <span style="background:#0369a1;color:white;padding:6px 12px;border-radius:4px;font-size:12px;font-weight:600;">✓ Vista Previa</span>
            </div>
            <div class="image-container" style="text-align:center;display:none;margin-bottom:10px;">
              <img class="preview-image" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;margin:0 auto;display:block;" />
            </div>
            <div class="pdf-preview" style="display:none;background:white;padding:20px;border-radius:6px;">
              <div class="pdf-icon" style="text-align:center;">
                <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                <div class="file-name" style="font-size:12px;color:#666;margin-top:8px;"></div>
              </div>
              <iframe class="pdf-frame" style="display:none;width:100%;height:400px;border:none;border-radius:6px;margin-top:10px;"></iframe>
            </div>
            <button type="button" class="remove-file-btn" onclick="removeFile('certificado_medico_pdf')" style="margin-top:10px;padding:8px 16px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;">✕ Eliminar archivo</button>
          </div>
          {% for error in madre_profile_form.certificado_medico_pdf.errors %}<span class="error">{{ error }}</span>{% endfor %}
        </div>
        
        <!-- Certificado de Residencia -->
        <div class="form-group">
          <label for="{{ madre_profile_form.certificado_residencia_pdf.id_for_label }}">
            <i class="fas fa-home"></i> {{ madre_profile_form.certificado_residencia_pdf.label }} <span class="required-star">*</span>
          </label>
          {% if madre_profile_form.instance.certificado_residencia_pdf %}
            <div id="existing-certificado_residencia_pdf" style="background:#e0f2fe;padding:10px;border-radius:6px;margin-bottom:10px;border-left:4px solid #0369a1;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <p style="margin:0;color:#0369a1;font-size:14px;">
                  <i class="fas fa-check-circle"></i> <strong>Archivo actual:</strong> {{ madre_profile_form.instance.certificado_residencia_pdf.name|truncatewords:3 }}
                </p>
                <small style="color:#0c4a6e;font-size:11px;">Si no lo cambias, se mantendrá</small>
              </div>
              <!-- PREVIEW DE LA IMAGEN GUARDADA -->
              <div style="margin-bottom:10px;text-align:center;">
                {% if madre_profile_form.instance.certificado_residencia_pdf %}
                  {% if madre_profile_form.instance.certificado_residencia_pdf.name|lower|endswith:'.pdf' %}
                    <div style="padding:20px;background:white;border-radius:6px;display:flex;flex-direction:column;align-items:center;">
                      <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                      <p style="margin:0;font-size:12px;color:#666;">{{ madre_profile_form.instance.certificado_residencia_pdf.name }}</p>
                      <a href="{{ madre_profile_form.instance.certificado_residencia_pdf.url }}" target="_blank" style="margin-top:8px;padding:6px 12px;background:#2563eb;color:white;border-radius:4px;text-decoration:none;font-size:12px;font-weight:600;">
                        <i class="fas fa-eye"></i> Ver PDF
                      </a>
                    </div>
                  {% else %}
                    <img src="{{ madre_profile_form.instance.certificado_residencia_pdf.url }}" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;display:block;margin:0 auto;" alt="Documento actual">
                  {% endif %}
                {% endif %}
              </div>
              <label style="display:flex;align-items:center;color:#0c4a6e;font-size:12px;cursor:pointer;">
                <input type="checkbox" name="clear_certificado_residencia_pdf" style="margin-right:8px;"> 
                <span>Borrar este archivo</span>
              </label>
            </div>
          {% endif %}
             <input type="file" name="certificado_residencia_pdf" id="{{ madre_profile_form.certificado_residencia_pdf.id_for_label }}" 
               accept="application/pdf,image/*"
               onchange="previewFile(this, 'certificado_residencia_pdf')" required>
          <div id="preview-certificado_residencia_pdf" class="file-preview-container" style="display:none;margin-top:15px;padding:15px;background:#e0f5ff;border:2px solid #0369a1;border-radius:8px;">
            <div style="text-align:center;margin-bottom:15px;">
              <span style="background:#0369a1;color:white;padding:6px 12px;border-radius:4px;font-size:12px;font-weight:600;">✓ Vista Previa</span>
            </div>
            <div class="image-container" style="text-align:center;display:none;margin-bottom:10px;">
              <img class="preview-image" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;margin:0 auto;display:block;" />
            </div>
            <div class="pdf-preview" style="display:none;background:white;padding:20px;border-radius:6px;">
              <div class="pdf-icon" style="text-align:center;">
                <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                <div class="file-name" style="font-size:12px;color:#666;margin-top:8px;"></div>
              </div>
              <iframe class="pdf-frame" style="display:none;width:100%;height:400px;border:none;border-radius:6px;margin-top:10px;"></iframe>
            </div>
            <button type="button" class="remove-file-btn" onclick="removeFile('certificado_residencia_pdf')" style="margin-top:10px;padding:8px 16px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;">✕ Eliminar archivo</button>
          </div>
          {% for error in madre_profile_form.certificado_residencia_pdf.errors %}<span class="error">{{ error }}</span>{% endfor %}
        </div>
        
        <!-- Cartas de Recomendación -->
        <div class="form-group">
          <label for="{{ madre_profile_form.cartas_recomendacion_pdf.id_for_label }}">
            <i class="fas fa-envelope"></i> {{ madre_profile_form.cartas_recomendacion_pdf.label }} <span class="required-star">*</span>
          </label>
          {% if madre_profile_form.instance.cartas_recomendacion_pdf %}
            <div id="existing-cartas_recomendacion_pdf" style="background:#e0f2fe;padding:10px;border-radius:6px;margin-bottom:10px;border-left:4px solid #0369a1;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <p style="margin:0;color:#0369a1;font-size:14px;">
                  <i class="fas fa-check-circle"></i> <strong>Archivo actual:</strong> {{ madre_profile_form.instance.cartas_recomendacion_pdf.name|truncatewords:3 }}
                </p>
                <small style="color:#0c4a6e;font-size:11px;">Si no lo cambias, se mantendrá</small>
              </div>
              <!-- PREVIEW DE LA IMAGEN GUARDADA -->
              <div style="margin-bottom:10px;text-align:center;">
                {% if madre_profile_form.instance.cartas_recomendacion_pdf %}
                  {% if madre_profile_form.instance.cartas_recomendacion_pdf.name|lower|endswith:'.pdf' %}
                    <div style="padding:20px;background:white;border-radius:6px;display:flex;flex-direction:column;align-items:center;">
                      <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                      <p style="margin:0;font-size:12px;color:#666;">{{ madre_profile_form.instance.cartas_recomendacion_pdf.name }}</p>
                      <a href="{{ madre_profile_form.instance.cartas_recomendacion_pdf.url }}" target="_blank" style="margin-top:8px;padding:6px 12px;background:#2563eb;color:white;border-radius:4px;text-decoration:none;font-size:12px;font-weight:600;">
                        <i class="fas fa-eye"></i> Ver PDF
                      </a>
                    </div>
                  {% else %}
                    <img src="{{ madre_profile_form.instance.cartas_recomendacion_pdf.url }}" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;display:block;margin:0 auto;" alt="Documento actual">
                  {% endif %}
                {% endif %}
              </div>
              <label style="display:flex;align-items:center;color:#0c4a6e;font-size:12px;cursor:pointer;">
                <input type="checkbox" name="clear_cartas_recomendacion_pdf" style="margin-right:8px;"> 
                <span>Borrar este archivo</span>
              </label>
            </div>
          {% endif %}
             <input type="file" name="cartas_recomendacion_pdf" id="{{ madre_profile_form.cartas_recomendacion_pdf.id_for_label }}" 
               accept="application/pdf,image/*"
               onchange="previewFile(this, 'cartas_recomendacion_pdf')" required>
          <div id="preview-cartas_recomendacion_pdf" class="file-preview-container" style="display:none;margin-top:15px;padding:15px;background:#e0f5ff;border:2px solid #0369a1;border-radius:8px;">
            <div style="text-align:center;margin-bottom:15px;">
              <span style="background:#0369a1;color:white;padding:6px 12px;border-radius:4px;font-size:12px;font-weight:600;">✓ Vista Previa</span>
            </div>
            <div class="image-container" style="text-align:center;display:none;margin-bottom:10px;">
              <img class="preview-image" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;margin:0 auto;display:block;" />
            </div>
            <div class="pdf-preview" style="display:none;background:white;padding:20px;border-radius:6px;">
              <div class="pdf-icon" style="text-align:center;">
                <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                <div class="file-name" style="font-size:12px;color:#666;margin-top:8px;"></div>
              </div>
              <iframe class="pdf-frame" style="display:none;width:100%;height:400px;border:none;border-radius:6px;margin-top:10px;"></iframe>
            </div>
            <button type="button" class="remove-file-btn" onclick="removeFile('cartas_recomendacion_pdf')" style="margin-top:10px;padding:8px 16px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;">✕ Eliminar archivo</button>
          </div>
          {% for error in madre_profile_form.cartas_recomendacion_pdf.errors %}<span class="error">{{ error }}</span>{% endfor %}
        </div>

        <!-- ==================== SECCIÓN 3: INFORMACIÓN DEL HOGAR COMUNITARIO ==================== -->
        <h3 class="full-width" style="color:var(--primary);margin:40px 0 15px;font-size:18px;border-bottom:2px solid var(--primary-light);padding-bottom:8px">
          <i class="fas fa-home"></i> 3. Información del Hogar Comunitario
        </h3>
        
        <div style="margin:10px 0 20px 0;padding:12px;background:#e7f3ff;color:#004085;border-radius:8px;border:1px solid #bee5eb;font-size:14px;">
          <i class="fas fa-info-circle"></i> Registre los datos del hogar comunitario separados de la residencia de la madre educativa.
        </div>

        <!-- GRID GEOGRAFÍA: REGIONAL → CIUDAD → LOCALIDAD (BOGOTÁ) → BARRIO -->
        <div class="two-column-grid">
          <!-- COLUMNA IZQUIERDA: IDENTIFICACIÓN Y UBICACIÓN GEOGRÁFICA -->
          <div class="column-panel">
            <h4><i class="fas fa-info-circle"></i> Identificación del Hogar</h4>
            
            <div class="form-group">
              <label for="id_nombre_hogar"><i class="fas fa-tag"></i> Nombre del Hogar <span class="required-star">*</span></label>
              <input type="text" 
                     name="nombre_hogar" 
                     id="id_nombre_hogar" 
                     class="form-control" 
                     placeholder="Ej: Hogar Pequeños Pasos"
                     value="{{ hogar_form.nombre_hogar.value|default:'' }}"
                     required>
              <div id="nombre-hogar-validation" style="display:none;margin-top:8px;padding:10px;border-radius:4px;font-size:13px;"></div>
              {% for error in hogar_form.nombre_hogar.errors %}<span class="error" style="color:#dc3545;font-weight:bold;display:block;margin-top:5px;">{{ error }}</span>{% endfor %}
            </div>
            
            <h4 style="margin-top:25px;"><i class="fas fa-map-location-dot"></i> Ubicación Geográfica</h4>
            
            <div class="form-group">
              <label for="id_regional"><i class="fas fa-map-location-dot"></i> Regional <span class="required-star">*</span></label>
              <select name="regional" id="id_regional" class="form-control" required>
                <option value="">-- Seleccione una Regional --</option>
                {% for regional in hogar_form.regional.field.queryset %}
                  <option value="{{ regional.id }}" {% if hogar_form.regional.value == regional.id %}selected{% endif %}>{{ regional.nombre }}</option>
                {% endfor %}
              </select>
              {% for error in hogar_form.regional.errors %}<span class="error">{{ error }}</span>{% endfor %}
              <small style="color:#666;display:block;margin-top:5px;">Seleccione la regional donde está ubicado el hogar</small>
            </div>
            
            <div class="form-group">
              <label for="id_ciudad"><i class="fas fa-city"></i> Ciudad <span class="required-star">*</span></label>
              <select name="ciudad" id="id_ciudad" class="form-control" required>
                <option value="">-- Seleccione una Ciudad --</option>
              </select>
              {% for error in hogar_form.ciudad.errors %}<span class="error">{{ error }}</span>{% endfor %}
              <small style="color:#666;display:block;margin-top:5px;">Se carga automáticamente según la regional</small>
            </div>
            
            <!-- LOCALIDAD BOGOTÁ (Solo si ciudad es Bogotá) -->
            <div class="form-group" id="localidad-hogar-group" style="display:none;">
              <label for="id_localidad_bogota"><i class="fas fa-map"></i> Localidad <span class="required-star">*</span></label>
              <select name="localidad_bogota" id="id_localidad_bogota" class="form-control">
                <option value="">-- Seleccione una Localidad --</option>
              </select>
              {% for error in hogar_form.localidad_bogota.errors %}<span class="error">{{ error }}</span>{% endfor %}
              <small style="color:#666;display:block;margin-top:5px;">Solo para hogares en Bogotá D.C.</small>
            </div>
            
            <!-- BARRIO (Depende de Localidad) -->
            <div class="form-group" id="barrio-hogar-group" style="display:none;">
              <label for="id_barrio_hogar"><i class="fas fa-building"></i> Barrio <span class="required-star">*</span></label>
              <select name="barrio" id="id_barrio_hogar" class="form-control">
                <option value="">-- Primero seleccione una Localidad --</option>
              </select>
              {% for error in hogar_form.barrio.errors %}<span class="error">{{ error }}</span>{% endfor %}
              <small style="color:#666;display:block;margin-top:5px;">Se carga según la localidad seleccionada</small>
            </div>
          </div>
          
          <!-- COLUMNA DERECHA: DIRECCIÓN Y DATOS DEL HOGAR -->
          <div class="column-panel">
            <h4><i class="fas fa-map-marker-alt"></i> Ubicación Física</h4>
            
            <div class="form-group">
              <label for="id_direccion"><i class="fas fa-road"></i> Dirección <span class="required-star">*</span></label>
              <input type="text" 
                     name="direccion" 
                     id="id_direccion" 
                     class="form-control" 
                     placeholder="Ej: Carrera 5 # 22-34, Apto 201"
                     value="{{ hogar_form.direccion.value|default:'' }}"
                     required>
              {% for error in hogar_form.direccion.errors %}<span class="error" style="color:#dc3545;font-weight:bold;display:block;margin-top:5px;">{{ error }}</span>{% endfor %}
              <small style="color:#666;display:block;margin-top:5px;">Dirección completa del hogar</small>
            </div>
            
            <div class="form-group">
              <label for="id_estrato"><i class="fas fa-layer-group"></i> Estrato Socioeconómico <span class="required-star">*</span></label>
              {{ hogar_form.estrato }}
              {% for error in hogar_form.estrato.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
            
            <h4 style="margin-top:25px;"><i class="fas fa-map-signs"></i> Geolocalización</h4>
            
            <div class="form-group">
              <label for="id_geolocalizacion_lat">Latitud</label>
              <input type="number" name="geolocalizacion_lat" id="id_geolocalizacion_lat" class="form-control" 
                     step="0.0000001" 
                     value="{{ hogar_form.geolocalizacion_lat.value|default:'' }}" 
                     placeholder="Ej: 4.6097100">
              <small style="color:#666;display:block;margin-top:5px;">Opcional (use Google Maps)</small>
            </div>

            <div class="form-group">
              <label for="id_geolocalizacion_lon">Longitud</label>
              <input type="number" name="geolocalizacion_lon" id="id_geolocalizacion_lon" class="form-control" 
                     step="0.0000001" 
                     value="{{ hogar_form.geolocalizacion_lon.value|default:'' }}" 
                     placeholder="Ej: -74.0817500">
              <small style="color:#666;display:block;margin-top:5px;">Opcional (use Google Maps)</small>
            </div>
          </div>
        </div>

        <!-- GRID DE DOS COLUMNAS: CARACTERÍSTICAS FÍSICAS Y TENENCIA -->
        <div class="two-column-grid">
          <!-- COLUMNA IZQUIERDA: CARACTERÍSTICAS FÍSICAS -->
          <div class="column-panel">
            <h4><i class="fas fa-building"></i> Características Físicas</h4>
            
            <div class="form-group">
              <label for="id_num_habitaciones"><i class="fas fa-door-closed"></i> Número de Habitaciones <span class="required-star">*</span></label>
              <select name="num_habitaciones_select" id="id_num_habitaciones_select" class="form-control" required>
                <option value="">-- Seleccione --</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="Otro">Otro</option>
              </select>
              <input type="number" name="num_habitaciones_otro" id="id_num_habitaciones_otro" class="form-control" style="display:none;margin-top:10px;" min="1" max="99" placeholder="Especifique el número" maxlength="2">
              <input type="hidden" name="num_habitaciones" id="id_num_habitaciones" required>
              <script>
                document.addEventListener('DOMContentLoaded', function() {
                  const selectHab = document.getElementById('id_num_habitaciones_select');
                  const otroHab = document.getElementById('id_num_habitaciones_otro');
                  const hiddenHab = document.getElementById('id_num_habitaciones');
                  // Si hay valor previo (modo edición)
                  const valorPrevioHab = hiddenHab.value || "{{ hogar_form.num_habitaciones.value|default:'' }}";
                  if (valorPrevioHab) {
                    let found = false;
                    for (let opt of selectHab.options) {
                      if (opt.value && valorPrevioHab == opt.value) {
                        selectHab.value = opt.value;
                        found = true;
                        break;
                      }
                    }
                    if (!found) {
                      selectHab.value = 'Otro';
                      otroHab.style.display = '';
                      otroHab.value = valorPrevioHab;
                      hiddenHab.value = valorPrevioHab;
                    } else {
                      otroHab.style.display = 'none';
                      otroHab.value = '';
                      hiddenHab.value = selectHab.value;
                    }
                  }
                  selectHab.addEventListener('change', function() {
                    if (this.value === 'Otro') {
                      otroHab.style.display = '';
                      otroHab.required = true;
                      hiddenHab.value = otroHab.value;
                    } else {
                      otroHab.style.display = 'none';
                      otroHab.required = false;
                      otroHab.value = '';
                      hiddenHab.value = this.value;
                    }
                  });
                  otroHab.addEventListener('input', function() {
                    hiddenHab.value = this.value;
                  });
                });
              </script>
              {% for error in hogar_form.num_habitaciones.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>

            <div class="form-group">
              <label for="id_num_banos"><i class="fas fa-bath"></i> Número de Baños <span class="required-star">*</span></label>
              <select name="num_banos_select" id="id_num_banos_select" class="form-control" required>
                <option value="">-- Seleccione --</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="Otro">Otro</option>
              </select>
              <input type="number" name="num_banos_otro" id="id_num_banos_otro" class="form-control" style="display:none;margin-top:10px;" min="1" max="99" placeholder="Especifique el número" maxlength="2">
              <input type="hidden" name="num_banos" id="id_num_banos" required>
              <script>
                document.addEventListener('DOMContentLoaded', function() {
                  const selectBan = document.getElementById('id_num_banos_select');
                  const otroBan = document.getElementById('id_num_banos_otro');
                  const hiddenBan = document.getElementById('id_num_banos');
                  // Si hay valor previo (modo edición)
                  const valorPrevioBan = hiddenBan.value || "{{ hogar_form.num_banos.value|default:'' }}";
                  if (valorPrevioBan) {
                    let found = false;
                    for (let opt of selectBan.options) {
                      if (opt.value && valorPrevioBan == opt.value) {
                        selectBan.value = opt.value;
                        found = true;
                        break;
                      }
                    }
                    if (!found) {
                      selectBan.value = 'Otro';
                      otroBan.style.display = '';
                      otroBan.value = valorPrevioBan;
                      hiddenBan.value = valorPrevioBan;
                    } else {
                      otroBan.style.display = 'none';
                      otroBan.value = '';
                      hiddenBan.value = selectBan.value;
                    }
                  }
                  selectBan.addEventListener('change', function() {
                    if (this.value === 'Otro') {
                      otroBan.style.display = '';
                      otroBan.required = true;
                      hiddenBan.value = otroBan.value;
                    } else {
                      otroBan.style.display = 'none';
                      otroBan.required = false;
                      otroBan.value = '';
                      hiddenBan.value = this.value;
                    }
                  });
                  otroBan.addEventListener('input', function() {
                    hiddenBan.value = this.value;
                  });
                });
              </script>
              {% for error in hogar_form.num_banos.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>

            <div class="form-group">
              <label for="id_material_construccion"><i class="fas fa-hammer"></i> Material de Construcción <span class="required-star">*</span></label>
              <select name="material_construccion_select" id="id_material_construccion_select" class="form-control" required>
                <option value="">-- Seleccione el material --</option>
                <option value="Ladrillo">Ladrillo</option>
                <option value="Cemento">Cemento</option>
                <option value="Concreto">Concreto</option>
                <option value="Madera">Madera</option>
                <option value="Bloque">Bloque</option>
                <option value="Guadua">Guadua</option>
                <option value="Zinc">Zinc</option>
                <option value="Adobe">Adobe</option>
                <option value="Otro">Otro</option>
              </select>
              <input type="text" name="material_construccion_otro" id="id_material_construccion_otro" class="form-control" style="display:none;margin-top:10px;" placeholder="Especifique el material" maxlength="100">
              <input type="hidden" name="material_construccion" id="id_material_construccion" required>
              <script>
                document.addEventListener('DOMContentLoaded', function() {
                  const select = document.getElementById('id_material_construccion_select');
                  const otroInput = document.getElementById('id_material_construccion_otro');
                  const hidden = document.getElementById('id_material_construccion');
                  // Si hay valor previo (modo edición)
                  const valorPrevio = hidden.value || "{{ hogar_form.material_construccion.value|default:'' }}";
                  if (valorPrevio) {
                    let found = false;
                    for (let opt of select.options) {
                      if (opt.value && valorPrevio.toLowerCase() === opt.value.toLowerCase()) {
                        select.value = opt.value;
                        found = true;
                        break;
                      }
                    }
                    if (!found) {
                      select.value = 'Otro';
                      otroInput.style.display = '';
                      otroInput.value = valorPrevio;
                      hidden.value = valorPrevio;
                    } else {
                      otroInput.style.display = 'none';
                      otroInput.value = '';
                      hidden.value = select.value;
                    }
                  }
                  select.addEventListener('change', function() {
                    if (this.value === 'Otro') {
                      otroInput.style.display = '';
                      otroInput.required = true;
                      hidden.value = otroInput.value;
                    } else {
                      otroInput.style.display = 'none';
                      otroInput.required = false;
                      otroInput.value = '';
                      hidden.value = this.value;
                    }
                  });
                  otroInput.addEventListener('input', function() {
                    hidden.value = this.value;
                  });
                });
              </script>
              {% for error in hogar_form.material_construccion.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>

            <div class="form-group">
              <label for="id_riesgos_cercanos"><i class="fas fa-exclamation-triangle"></i> Riesgos Cercanos <span class="required-star">*</span></label>
              <select name="riesgos_cercanos_select" id="id_riesgos_cercanos_select" class="form-control" required>
                <option value="">-- Seleccione el riesgo --</option>
                <option value="Vías principales">Cerca de vías principales</option>
                <option value="Zona de inundación">Zona de inundación</option>
                <option value="Zona de deslizamiento">Zona de deslizamiento</option>
                <option value="Zona industrial">Zona industrial</option>
                <option value="Cerca de ríos">Cerca de ríos</option>
                <option value="Cerca de torres eléctricas">Cerca de torres eléctricas</option>
                <option value="Cerca de basureros">Cerca de basureros</option>
                <option value="Otros">Otros</option>
              </select>
              <input type="text" name="riesgos_cercanos_otro" id="id_riesgos_cercanos_otro" class="form-control" style="display:none;margin-top:10px;" placeholder="Especifique el riesgo" maxlength="200">
              <input type="hidden" name="riesgos_cercanos" id="id_riesgos_cercanos" required>
              <script>
                document.addEventListener('DOMContentLoaded', function() {
                  const selectRiesgo = document.getElementById('id_riesgos_cercanos_select');
                  const otroRiesgo = document.getElementById('id_riesgos_cercanos_otro');
                  const hiddenRiesgo = document.getElementById('id_riesgos_cercanos');
                  // Si hay valor previo (modo edición)
                  const valorPrevioRiesgo = hiddenRiesgo.value || "{{ hogar_form.riesgos_cercanos.value|default:'' }}";
                  if (valorPrevioRiesgo) {
                    let found = false;
                    for (let opt of selectRiesgo.options) {
                      if (opt.value && valorPrevioRiesgo.toLowerCase() === opt.value.toLowerCase()) {
                        selectRiesgo.value = opt.value;
                        found = true;
                        break;
                      }
                    }
                    if (!found) {
                      selectRiesgo.value = 'Otros';
                      otroRiesgo.style.display = '';
                      otroRiesgo.value = valorPrevioRiesgo;
                      hiddenRiesgo.value = valorPrevioRiesgo;
                    } else {
                      otroRiesgo.style.display = 'none';
                      otroRiesgo.value = '';
                      hiddenRiesgo.value = selectRiesgo.value;
                    }
                  }
                  selectRiesgo.addEventListener('change', function() {
                    if (this.value === 'Otros') {
                      otroRiesgo.style.display = '';
                      otroRiesgo.required = true;
                      hiddenRiesgo.value = otroRiesgo.value;
                    } else {
                      otroRiesgo.style.display = 'none';
                      otroRiesgo.required = false;
                      otroRiesgo.value = '';
                      hiddenRiesgo.value = this.value;
                    }
                  });
                  otroRiesgo.addEventListener('input', function() {
                    hiddenRiesgo.value = this.value;
                  });
                });
              </script>
              {% for error in hogar_form.riesgos_cercanos.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
          </div>
          
          <!-- COLUMNA DERECHA: TENENCIA DEL INMUEBLE -->
          <div class="column-panel">
            <h4><i class="fas fa-file-contract"></i> Tenencia del Inmueble</h4>
            
            <div class="form-group">
              <label for="{{ hogar_form.tipo_tenencia.id_for_label }}"><i class="fas fa-key"></i> Tipo de Tenencia</label>
              <select name="tipo_tenencia" id="{{ hogar_form.tipo_tenencia.id_for_label }}" class="form-control">
                <option value="">-- Seleccione el tipo de tenencia --</option>
                <option value="Propia" {% if hogar_form.tipo_tenencia.value == 'Propia' %}selected{% endif %}>Propia</option>
                <option value="Arrendada" {% if hogar_form.tipo_tenencia.value == 'Arrendada' %}selected{% endif %}>Arrendada</option>
                <option value="Comodato" {% if hogar_form.tipo_tenencia.value == 'Comodato' %}selected{% endif %}>Comodato</option>
              </select>
              <small style="color:#666;display:block;margin-top:5px;">Indique si es propio, arrendado o en comodato</small>
              {% for error in hogar_form.tipo_tenencia.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>

            <div class="form-group">
              <label for="{{ hogar_form.documento_tenencia_pdf.id_for_label }}"><i class="fas fa-file-pdf"></i> Documento de Tenencia <span class="required-star">*</span></label>
              {% if hogar_form.instance.documento_tenencia_pdf %}
                <div id="existing-documento_tenencia_pdf" style="background:#e0f2fe;padding:10px;border-radius:6px;margin-bottom:10px;border-left:4px solid #0369a1;">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    <p style="margin:0;color:#0369a1;font-size:14px;">
                      <i class="fas fa-check-circle"></i> <strong>Archivo actual:</strong> {{ hogar_form.instance.documento_tenencia_pdf.name|truncatewords:3 }}
                    </p>
                    <small style="color:#0c4a6e;font-size:11px;">Si no lo cambias, se mantendrá</small>
                  </div>
                  <!-- PREVIEW DE LA IMAGEN GUARDADA -->
                  <div style="margin-bottom:10px;text-align:center;">
                    {% if hogar_form.instance.documento_tenencia_pdf %}
                      {% if hogar_form.instance.documento_tenencia_pdf.name|lower|endswith:'.pdf' %}
                        <div style="padding:20px;background:white;border-radius:6px;display:flex;flex-direction:column;align-items:center;">
                          <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                          <p style="margin:0;font-size:12px;color:#666;">{{ hogar_form.instance.documento_tenencia_pdf.name }}</p>
                          <a href="{{ hogar_form.instance.documento_tenencia_pdf.url }}" target="_blank" style="margin-top:8px;padding:6px 12px;background:#2563eb;color:white;border-radius:4px;text-decoration:none;font-size:12px;font-weight:600;">
                            <i class="fas fa-eye"></i> Ver PDF
                          </a>
                        </div>
                      {% else %}
                        <img src="{{ hogar_form.instance.documento_tenencia_pdf.url }}" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;display:block;margin:0 auto;" alt="Documento actual">
                      {% endif %}
                    {% endif %}
                  </div>
                  <label style="display:flex;align-items:center;color:#0c4a6e;font-size:12px;cursor:pointer;">
                    <input type="checkbox" name="clear_documento_tenencia_pdf" style="margin-right:8px;"> 
                    <span>Borrar este archivo</span>
                  </label>
                </div>
              {% endif %}
              <input type="file" name="documento_tenencia_pdf" id="{{ hogar_form.documento_tenencia_pdf.id_for_label }}" 
                accept="application/pdf,image/*"
                onchange="previewFile(this, 'documento_tenencia_pdf')" required>
              <div id="preview-documento_tenencia_pdf" class="file-preview-container" style="display:none;margin-top:15px;padding:15px;background:#e0f5ff;border:2px solid #0369a1;border-radius:8px;">
                <div style="text-align:center;margin-bottom:15px;">
                  <span style="background:#0369a1;color:white;padding:6px 12px;border-radius:4px;font-size:12px;font-weight:600;">✓ Vista Previa</span>
                </div>
                <div class="image-container" style="text-align:center;display:none;margin-bottom:10px;">
                  <img class="preview-image" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;margin:0 auto;display:block;" />
                </div>
                <div class="pdf-preview" style="display:none;background:white;padding:20px;border-radius:6px;">
                  <div class="pdf-icon" style="text-align:center;">
                    <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                    <div class="file-name" style="font-size:12px;color:#666;margin-top:8px;"></div>
                  </div>
                  <iframe class="pdf-frame" style="display:none;width:100%;height:400px;border:none;border-radius:6px;margin-top:10px;"></iframe>
                </div>
                <button type="button" class="remove-file-btn" onclick="removeFile('documento_tenencia_pdf')" style="margin-top:10px;padding:8px 16px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;">✕ Eliminar archivo</button>
              </div>
              <small style="color:#666;display:block;margin-top:5px;">Documento que acredite la tenencia (opcional)</small>
              {% for error in hogar_form.documento_tenencia_pdf.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
            
            <h4 style="margin-top:25px"><i class="fas fa-map-marker-alt"></i> Geolocalización</h4>
            
            <div class="form-group">
              <label for="id_geolocalizacion_lat">Latitud</label>
              <input type="number" name="geolocalizacion_lat" id="id_geolocalizacion_lat" class="form-control" 
                     step="0.0000001" 
                     value="{{ hogar_form.geolocalizacion_lat.value|default:'' }}" 
                     placeholder="Ej: 4.6097100">
              <small style="color:#666;display:block;margin-top:5px;">Opcional (use Google Maps)</small>
              {% for error in hogar_form.geolocalizacion_lat.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>

            <div class="form-group">
              <label for="id_geolocalizacion_lon">Longitud</label>
              <input type="number" name="geolocalizacion_lon" id="id_geolocalizacion_lon" class="form-control" 
                     step="0.0000001" 
                     value="{{ hogar_form.geolocalizacion_lon.value|default:'' }}" 
                     placeholder="Ej: -74.0817500">
              <small style="color:#666;display:block;margin-top:5px;">Opcional (use Google Maps)</small>
              {% for error in hogar_form.geolocalizacion_lon.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
          </div>
        </div>

        <!-- GRID DE DOS COLUMNAS: FOTOS DEL HOGAR -->
        <div class="two-column-grid">
          <div class="column-panel">
            <h4><i class="fas fa-images"></i> Fotos del Interior <span class="required-star">*</span></h4>
            <div class="form-group">
              {% if hogar_form.fotos_interior.value %}
                <div id="existing-fotos_interior" style="background:#e0f2fe;padding:10px;border-radius:6px;margin-bottom:10px;border-left:4px solid #0369a1;">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    <p style="margin:0;color:#0369a1;font-size:14px;">
                      <i class="fas fa-check-circle"></i> <strong>Archivo actual:</strong> {{ hogar_form.fotos_interior.value.name|truncatewords:3 }}
                    </p>
                    <small style="color:#0c4a6e;font-size:11px;">Si no lo cambias, se mantendrá</small>
                  </div>
                  <!-- PREVIEW DE LA IMAGEN GUARDADA -->
                  <div style="margin-bottom:10px;text-align:center;">
                    {% if hogar_form.fotos_interior.value %}
                      {% if hogar_form.fotos_interior.value.name|lower|endswith:'.pdf' %}
                        <div style="padding:20px;background:white;border-radius:6px;display:flex;flex-direction:column;align-items:center;">
                          <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                          <p style="margin:0;font-size:12px;color:#666;">{{ hogar_form.fotos_interior.value.name }}</p>
                          <a href="{{ hogar_form.fotos_interior.url }}" target="_blank" style="margin-top:8px;padding:6px 12px;background:#2563eb;color:white;border-radius:4px;text-decoration:none;font-size:12px;font-weight:600;">
                            <i class="fas fa-eye"></i> Ver PDF
                          </a>
                        </div>
                      {% else %}
                        <img src="{{ hogar_form.fotos_interior.url }}" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;display:block;margin:0 auto;" alt="Foto interior actual">
                      {% endif %}
                    {% endif %}
                  </div>
                  <label style="display:flex;align-items:center;color:#0c4a6e;font-size:12px;cursor:pointer;">
                    <input type="checkbox" name="clear_fotos_interior" style="margin-right:8px;"> 
                    <span>Borrar este archivo</span>
                  </label>
                </div>
              {% endif %}
              <label style="display:block;margin-bottom:8px;color:#666;font-size:12px;">
                {% if hogar_form.fotos_interior.value %}
                  Seleccionar nuevo archivo (dejar en blanco para mantener el actual):
                {% else %}
                  Seleccionar archivo:
                {% endif %}
              </label>
              <input type="file" name="fotos_interior" id="{{ hogar_form.fotos_interior.id_for_label }}" 
                     accept="image/*"
                     {% if not hogar_form.fotos_interior.value %}required{% endif %}
                     onchange="previewFile(this, 'fotos_interior')">
              <div id="preview-fotos_interior" class="file-preview-container" style="display:none;margin-top:15px;padding:15px;background:#e0f5ff;border:2px solid #0369a1;border-radius:8px;">
                <div style="text-align:center;margin-bottom:15px;">
                  <span style="background:#0369a1;color:white;padding:6px 12px;border-radius:4px;font-size:12px;font-weight:600;">✓ Vista Previa</span>
                </div>
                <div class="image-container" style="text-align:center;display:none;margin-bottom:10px;">
                  <img class="preview-image" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;margin:0 auto;display:block;" />
                </div>
                <div class="pdf-preview" style="display:none;background:white;padding:20px;border-radius:6px;">
                  <div class="pdf-icon" style="text-align:center;">
                    <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                    <div class="file-name" style="font-size:12px;color:#666;margin-top:8px;"></div>
                  </div>
                  <iframe class="pdf-frame" style="display:none;width:100%;height:400px;border:none;border-radius:6px;margin-top:10px;"></iframe>
                </div>
                <button type="button" class="remove-file-btn" onclick="removeFile('fotos_interior')" style="margin-top:10px;padding:8px 16px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;">✕ Eliminar archivo</button>
              </div>
              <small style="color:#666;display:block;margin-top:5px;">Suba foto del interior del hogar </small>
              {% for error in hogar_form.fotos_interior.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
          </div>
          
          <div class="column-panel">
            <h4><i class="fas fa-images"></i> Fotos del Exterior <span class="required-star">*</span></h4>
            <div class="form-group">
              {% if hogar_form.fotos_exterior.value %}
                <div id="existing-fotos_exterior" style="background:#e0f2fe;padding:10px;border-radius:6px;margin-bottom:10px;border-left:4px solid #0369a1;">
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    <p style="margin:0;color:#0369a1;font-size:14px;">
                      <i class="fas fa-check-circle"></i> <strong>Archivo actual:</strong> {{ hogar_form.fotos_exterior.value.name|truncatewords:3 }}
                    </p>
                    <small style="color:#0c4a6e;font-size:11px;">Si no lo cambias, se mantendrá</small>
                  </div>
                  <!-- PREVIEW DE LA IMAGEN GUARDADA -->
                  <div style="margin-bottom:10px;text-align:center;">
                    {% if hogar_form.fotos_exterior.value %}
                      {% if hogar_form.fotos_exterior.value.name|lower|endswith:'.pdf' %}
                        <div style="padding:20px;background:white;border-radius:6px;display:flex;flex-direction:column;align-items:center;">
                          <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                          <p style="margin:0;font-size:12px;color:#666;">{{ hogar_form.fotos_exterior.value.name }}</p>
                          <a href="{{ hogar_form.fotos_exterior.url }}" target="_blank" style="margin-top:8px;padding:6px 12px;background:#2563eb;color:white;border-radius:4px;text-decoration:none;font-size:12px;font-weight:600;">
                            <i class="fas fa-eye"></i> Ver PDF
                          </a>
                        </div>
                      {% else %}
                        <img src="{{ hogar_form.fotos_exterior.url }}" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;display:block;margin:0 auto;" alt="Foto exterior actual">
                      {% endif %}
                    {% endif %}
                  </div>
                  <label style="display:flex;align-items:center;color:#0c4a6e;font-size:12px;cursor:pointer;">
                    <input type="checkbox" name="clear_fotos_exterior" style="margin-right:8px;">
                    <span>Borrar este archivo</span>
                  </label>
                </div>
              {% endif %}
              <label style="display:block;margin-bottom:8px;color:#666;font-size:12px;">
                {% if hogar_form.fotos_exterior.value %}
                  Seleccionar nuevo archivo (dejar en blanco para mantener el actual):
                {% else %}
                  Seleccionar archivo:
                {% endif %}
              </label>
              <input type="file" name="fotos_exterior" id="{{ hogar_form.fotos_exterior.id_for_label }}" 
                     accept="image/*"
                     {% if not hogar_form.fotos_exterior.value %}required{% endif %}
                     onchange="previewFile(this, 'fotos_exterior')">
              <div id="preview-fotos_exterior" class="file-preview-container" style="display:none;margin-top:15px;padding:15px;background:#e0f5ff;border:2px solid #0369a1;border-radius:8px;">
                <div style="text-align:center;margin-bottom:15px;">
                  <span style="background:#0369a1;color:white;padding:6px 12px;border-radius:4px;font-size:12px;font-weight:600;">✓ Vista Previa</span>
                </div>
                <div class="image-container" style="text-align:center;display:none;margin-bottom:10px;">
                  <img class="preview-image" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;margin:0 auto;display:block;" />
                </div>
                <div class="pdf-preview" style="display:none;background:white;padding:20px;border-radius:6px;">
                  <div class="pdf-icon" style="text-align:center;">
                    <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                    <div class="file-name" style="font-size:12px;color:#666;margin-top:8px;"></div>
                  </div>
                  <iframe class="pdf-frame" style="display:none;width:100%;height:400px;border:none;border-radius:6px;margin-top:10px;"></iframe>
                </div>
                <button type="button" class="remove-file-btn" onclick="removeFile('fotos_exterior')" style="margin-top:10px;padding:8px 16px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;">✕ Eliminar archivo</button>
              </div>
              <small style="color:#666;display:block;margin-top:5px;">Suba fotos del exterior del hogar (mínimo 1 foto)</small>
              {% for error in hogar_form.fotos_exterior.errors %}<span class="error">{{ error }}</span>{% endfor %}
            </div>
          </div>
        </div>
        
        <!-- SECCIÓN DE CONVIVIENTES (ANCHO COMPLETO) -->
        <div class="full-width">
          <h4 style="color:var(--primary);margin:20px 0 10px;font-size:16px;border-left:4px solid var(--primary-light);padding-left:10px">
            <i class="fas fa-users"></i> Personas que Viven en el Hogar
          </h4>

          <div class="form-group">
            <label for="num_convivientes"><i class="fas fa-user-plus"></i> ¿Cuántas personas viven en el hogar? <span class="required-star">*</span></label>
            <input type="number" id="num_convivientes" class="form-control" min="0" max="20" value="0" 
                   onchange="generarCamposConvivientes(this.value)"
                   placeholder="Ingrese el número de personas que conviven en el hogar">
            <small style="color:#666;display:block;margin-top:5px;">Incluya a todas las personas mayores de edad que viven permanentemente en el hogar (sin contar al agente educativo)</small>
          </div>

          <div id="convivientes-container" style="margin-top:20px;">
            <!-- Los campos de convivientes se generarán dinámicamente aquí -->
          </div>
        </div>

        {% if not modo_edicion %}
        <!-- Mensaje informativo sobre formulario de activación -->
        <div style="margin-top:30px;padding:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border-radius:12px;box-shadow:0 4px 15px rgba(102,126,234,0.4);">
          <div style="display:flex;align-items:center;gap:15px;">
            <i class="fas fa-info-circle" style="font-size:48px;opacity:0.9;"></i>
            <div>
              <h3 style="margin:0 0 10px 0;font-size:20px;font-weight:700;">📋 Importante: Proceso de Activación del Hogar</h3>
              <p style="margin:0;font-size:15px;line-height:1.6;opacity:0.95;">
                El hogar será creado en estado <strong>"Pendiente de Visita"</strong>. Para activarlo y poder recibir niños, 
                debe realizarse la <strong>visita técnica</strong> en la fecha programada. El día de la visita se habilitará 
                automáticamente el <strong>Formulario de Activación</strong> donde se evaluarán las condiciones del hogar 
                y se determinará si es <strong>APTO</strong> o <strong>NO APTO</strong>.
              </p>
              <p style="margin:10px 0 0 0;font-size:14px;opacity:0.9;">
                <i class="fas fa-calendar-check"></i> Se enviará un correo de confirmación con la fecha de la visita programada.
              </p>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Botones de Acción Final -->
        <div class="form-actions" style="margin-top:40px;padding-top:20px;border-top:2px solid #dee2e6;">
          <a href="{% url 'listar_madres' %}" class="btn-volver">
            <i class="fas fa-times"></i> Cancelar
          </a>
          {% if not modo_edicion %}
            <button type="submit" class="btn-guardar">
              <i class="fas fa-check"></i> Crear Agente Educativo y Hogar
            </button>
          {% else %}
            <button type="submit" class="btn-guardar">
              <i class="fas fa-save"></i> Guardar Cambios
            </button>
          {% endif %}
        </div>
      </div>

    </form>
  </div>
  <script>
    // ========================================
    // 📎 FUNCIONES GLOBALES (ANTES de DOMContentLoaded)
    // ========================================
    
    function previewFile(input, fieldName) {
      const previewContainer = document.getElementById('preview-' + fieldName);
      
      if (!previewContainer) {
        console.error('Preview container not found for field:', fieldName);
        return;
      }
      
      const imageContainer = previewContainer.querySelector('.image-container');
      const previewImage = previewContainer.querySelector('.preview-image');
      const pdfPreview = previewContainer.querySelector('.pdf-preview');
      
      if (!previewImage || !pdfPreview) {
        console.error('Preview elements not found for field:', fieldName);
        return;
      }
      
      const pdfIcon = pdfPreview.querySelector('.pdf-icon');
      const pdfFrame = pdfPreview.querySelector('.pdf-frame');
      const fileName = pdfPreview.querySelector('.file-name');
      
      if (input.files && input.files[0]) {
        const file = input.files[0];
        const fileType = file.type;
        const fileName_text = file.name;
        const fileURL = URL.createObjectURL(file);
        
        console.log('File selected:', fileName_text, 'Type:', fileType);
        
        // Mostrar contenedor con animación
        previewContainer.style.display = 'block';
        
        // Ocultar ambas vistas primero
        if (imageContainer) imageContainer.style.display = 'none';
        pdfPreview.style.display = 'none';
        
        if (fileType.startsWith('image/')) {
          console.log('Mostrando imagen...');
          // Vista previa de imagen
          previewImage.src = fileURL;
          if (imageContainer) imageContainer.style.display = 'block';
        } else if (fileType === 'application/pdf') {
          console.log('Mostrando PDF...');
          // Vista previa de PDF
          pdfPreview.style.display = 'block';
          if (fileName) fileName.textContent = fileName_text;
          
          // Intentar mostrar PDF en iframe
          try {
            if (pdfFrame) {
              pdfFrame.src = fileURL;
              pdfFrame.style.display = 'block';
              if (pdfIcon) pdfIcon.style.display = 'none';
            }
          } catch (e) {
            // Si falla, mostrar solo el ícono
            console.log('Error loading PDF in iframe, showing icon instead');
            if (pdfIcon) pdfIcon.style.display = 'block';
            if (pdfFrame) pdfFrame.style.display = 'none';
          }
        } else {
          console.log('Tipo de archivo no soportado:', fileType);
          // Para otros tipos, mostrar el ícono PDF con el nombre
          pdfPreview.style.display = 'block';
          if (fileName) fileName.textContent = fileName_text;
          if (pdfIcon) pdfIcon.style.display = 'block';
          if (pdfFrame) pdfFrame.style.display = 'none';
        }
      } else {
        // Si no hay archivo seleccionado, ocultar preview
        previewContainer.style.display = 'none';
      }
    }
    
    function removeFile(fieldName) {
      const input = document.getElementById('id_' + fieldName);
      const previewContainer = document.getElementById('preview-' + fieldName);
      
      if (!input || !previewContainer) {
        console.error('Input or preview container not found for:', fieldName);
        return;
      }
      
      // Limpiar input
      input.value = '';
      
      // Ocultar vista previa
      previewContainer.style.display = 'none';
      
      // Limpiar contenido
      const previewImage = previewContainer.querySelector('.preview-image');
      const pdfFrame = previewContainer.querySelector('.pdf-frame');
      if (previewImage) previewImage.src = '';
      if (pdfFrame) pdfFrame.src = '';
    }

    document.addEventListener('DOMContentLoaded', function() {
      // ========================================
      // 🏠 CASCADAS GEOGRÁFICAS - HOGAR COMUNITARIO (SECCIÓN 3)
      // ========================================
      
      const regionalSelect = document.getElementById('id_regional');
      const ciudadSelect = document.getElementById('id_ciudad');
      const localidadGroup = document.getElementById('localidad-hogar-group');
      const localidadSelect = document.getElementById('id_localidad_bogota');
      const barrioGroup = document.getElementById('barrio-hogar-group');
      const barrioSelect = document.getElementById('id_barrio_hogar');
      
      console.log('Elementos encontrados:', {
        regional: !!regionalSelect,
        ciudad: !!ciudadSelect,
        localidad: !!localidadSelect,
        barrio: !!barrioSelect
      });
      
      // Función para cargar ciudades según regional
      function cargarCiudades() {
        const regionalId = regionalSelect.value;
        console.log('📍 Regional seleccionada:', regionalId);
        
        // Limpiar dependientes
        ciudadSelect.innerHTML = '<option value="">Cargando ciudades...</option>';
        ciudadSelect.disabled = true;
        localidadGroup.style.display = 'none';
        barrioGroup.style.display = 'none';
        
        if (!regionalId) {
          ciudadSelect.innerHTML = '<option value="">-- Seleccione una Ciudad --</option>';
          ciudadSelect.disabled = true;
          return;
        }
        
        // Cargar ciudades
        fetch(`/ajax/cargar-ciudades/?regional_id=${regionalId}`)
          .then(r => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.json();
          })
          .then(data => {
            console.log('✅ Ciudades recibidas:', data.length);
            ciudadSelect.innerHTML = '<option value="">-- Seleccione una Ciudad --</option>';
            
            data.forEach(ciudad => {
              const opt = document.createElement('option');
              opt.value = ciudad.id;
              opt.textContent = ciudad.nombre;
              ciudadSelect.appendChild(opt);
            });
            
            ciudadSelect.disabled = false;
          })
          .catch(err => {
            console.error('❌ Error cargando ciudades:', err);
            ciudadSelect.innerHTML = '<option value="">Error al cargar</option>';
            ciudadSelect.disabled = true;
          });
      }
      
      // Función para mostrar/ocultar localidad según ciudad
      function procesarCiudad() {
        const ciudadNombre = ciudadSelect.options[ciudadSelect.selectedIndex]?.text || '';
        const esBogota = ciudadNombre.toUpperCase().includes('BOGOT');
        
        console.log(`🏙️ Ciudad: "${ciudadNombre}" - ¿Bogotá? ${esBogota}`);
        
        barrioGroup.style.display = 'none';
        
        if (!esBogota || !ciudadSelect.value) {
          localidadGroup.style.display = 'none';
          localidadSelect.required = false;
          localidadSelect.value = '';
          return;
        }
        
        // Mostrar localidad para Bogotá
        localidadGroup.style.display = 'block';
        localidadSelect.required = true;
        localidadSelect.disabled = false; // 🔓 HABILITAR el select
        
        // Cargar localidades si el select está vacío
        if (localidadSelect.options.length === 1) {
          console.log('📥 Cargando localidades Bogotá...');
          fetch('/api/localidades-bogota/')
            .then(r => r.json())
            .then(data => {
              console.log('📦 Datos recibidos:', data);
              localidadSelect.innerHTML = '<option value="">-- Seleccione una Localidad --</option>';
              data.forEach(loc => {
                const opt = document.createElement('option');
                opt.value = loc.id;
                opt.textContent = `${loc.numero}. ${loc.nombre}`;
                localidadSelect.appendChild(opt);
              });
              localidadSelect.disabled = false; // 🔓 Asegurarse que está habilitado después de cargar
              console.log('✅ Localidades cargadas:', data.length);
            })
            .catch(err => {
              console.error('❌ Error en localidades:', err);
              localidadSelect.disabled = false; // 🔓 Habilitar aunque haya error, para que el usuario lo vea
            });
        }
      }
      
      // Función para cargar barrios según localidad
      function cargarBarrios() {
        const localidadId = localidadSelect.value;
        console.log('📍 Localidad seleccionada:', localidadId);
        
        if (!localidadId) {
          barrioSelect.innerHTML = '<option value="">-- Seleccione primero una Localidad --</option>';
          barrioSelect.disabled = true;
          barrioGroup.style.display = 'none';
          return;
        }
        
        barrioGroup.style.display = 'block';
        barrioSelect.innerHTML = '<option value="">Cargando barrios...</option>';
        barrioSelect.disabled = true;
        
        fetch(`/api/barrios-por-localidad/${localidadId}/`)
          .then(r => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.json();
          })
          .then(data => {
            console.log('✅ Barrios recibidos:', data.barrios?.length || 0);
            barrioSelect.innerHTML = '<option value="">-- Seleccione un Barrio --</option>';
            
            if (data.barrios && data.barrios.length > 0) {
              data.barrios.forEach(barrio => {
                const opt = document.createElement('option');
                opt.value = barrio.nombre;
                opt.textContent = barrio.nombre;
                barrioSelect.appendChild(opt);
              });
            }
            
            barrioSelect.disabled = false;
          })
          .catch(err => {
            console.error('❌ Error en barrios:', err);
            barrioSelect.innerHTML = '<option value="">Error al cargar</option>';
            barrioSelect.disabled = true;
          });
      }
      
      // Event listeners
      if (regionalSelect && ciudadSelect) {
        regionalSelect.addEventListener('change', cargarCiudades);
        console.log('✓ Listener agregado a Regional');
        
        // Auto-seleccionar BogotaDC
        let bogotaId = null;
        for (let i = 0; i < regionalSelect.options.length; i++) {
          if (regionalSelect.options[i].text.toUpperCase().includes('BOGOTA')) {
            bogotaId = regionalSelect.options[i].value;
            break;
          }
        }
        if (bogotaId) {
          regionalSelect.value = bogotaId;
          cargarCiudades();
        }
      }
      
      if (ciudadSelect) {
        ciudadSelect.addEventListener('change', procesarCiudad);
        console.log('✓ Listener agregado a Ciudad');
      }
      
      if (localidadSelect) {
        localidadSelect.addEventListener('change', cargarBarrios);
        console.log('✓ Listener agregado a Localidad');
      }
      
      // ========================================
      // 🔍 VALIDAR ESTRUCTURA DE PREVIEW
      // ========================================
      console.log('✓ Página cargada - Validando estructura de previsualización...');
      
      // Validar que existan los divs preview
      const previewDivs = document.querySelectorAll('[id^="preview-"]');
      console.log('Total de divs preview encontrados:', previewDivs.length);
      
      previewDivs.forEach(div => {
        const fieldName = div.id.replace('preview-', '');
        const hasImage = div.querySelector('.preview-image') !== null;
        const hasPdfPreview = div.querySelector('.pdf-preview') !== null;
        const hasRemoveBtn = div.querySelector('.remove-file-btn') !== null;
        
        if (!hasImage || !hasPdfPreview) {
          console.warn(`⚠️ Campo ${fieldName} falta estructura:`, {hasImage, hasPdfPreview, hasRemoveBtn});
        }
      });
      
      // ========================================
      // 📍 REORGANIZAR PREVIEWS ARRIBA DEL INPUT
      // ========================================
      console.log('Reorganizando previews...');
      previewDivs.forEach(previewDiv => {
        const fieldName = previewDiv.id.replace('preview-', '');
        const inputId = 'id_' + fieldName;
        const fileInput = document.getElementById(inputId);
        
        if (fileInput) {
          // Mover el div preview ANTES del input
          fileInput.parentNode.insertBefore(previewDiv, fileInput);
          console.log(`✓ Preview de ${fieldName} movido arriba del input`);
        }
      });
      
      // ========================================
      // ✖️ CERRAR MENSAJES DE ALERTA
      // ========================================
      document.querySelectorAll('.close-message').forEach(function(btn) {
        btn.addEventListener('click', function() {
          this.parentElement.style.opacity = '0';
          this.parentElement.style.transform = 'translateY(-10px)';
          this.parentElement.style.transition = 'all 0.3s ease';
          setTimeout(() => {
            this.parentElement.remove();
          }, 300);
        });
      });
      
      // ========================================
      // 🔴 MARCAR CAMPOS CON ERROR Y SCROLL AUTOMÁTICO
      // ========================================
      
      // Marcar todos los campos que tienen errores
      const errorFields = document.querySelectorAll('.errorlist');
      let firstErrorField = null;
      
      errorFields.forEach(function(errorList) {
        // Encontrar el input/select/textarea asociado
        const formGroup = errorList.closest('.form-group');
        if (formGroup) {
          const input = formGroup.querySelector('input, select, textarea');
          if (input) {
            // Agregar clase de error
            input.classList.add('error');
            
            // Guardar el primer campo con error
            if (!firstErrorField) {
              firstErrorField = input;
            }
            
            // Agregar evento para quitar el error cuando el usuario corrija
            input.addEventListener('input', function() {
              this.classList.remove('error');
            });
            input.addEventListener('change', function() {
              this.classList.remove('error');
            });
          }
        }
      });
      
      // Scroll automático al primer campo con error
      if (firstErrorField) {
        setTimeout(function() {
          firstErrorField.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
          });
          
          // Hacer focus en el campo
          setTimeout(function() {
            firstErrorField.focus();
          }, 500);
        }, 300);
      }
      
      // Debug: Agregar listener al formulario para detectar problemas
      const form = document.getElementById('madreCreationForm');
      if (form) {
        form.addEventListener('submit', function(e) {
          console.log('Formulario enviándose...');
          
          // Validar edad antes de enviar
          if (typeof edadValida !== 'undefined' && !edadValida) {
            e.preventDefault();
            alert('No se puede crear el agente educativo. La edad debe estar entre 20 y 45 años.');
            
            // Scroll al campo de fecha de nacimiento
            const fechaInput = document.getElementById('id_fecha_nacimiento');
            if (fechaInput) {
              fechaInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
              fechaInput.focus();
            }
            
            return false;
          }
          
          // Verificar campos inválidos
          const invalidFields = form.querySelectorAll(':invalid');
          if (invalidFields.length > 0) {
            console.log('Campos inválidos encontrados:');
            invalidFields.forEach(field => {
              console.log(`  - ${field.name || field.id}: ${field.validationMessage}`);
            });
            e.preventDefault();
            alert('Por favor, complete todos los campos requeridos correctamente.');
            return false;
          }
        });
        
        // Detectar si el formulario no se envía
        form.addEventListener('invalid', function(e) {
          console.log('Campo inválido detectado:', e.target.name || e.target.id, e.target.validationMessage);
        }, true);
      }

      // --- Lógica para previsualización de imagen ---
      const fotoInput = document.getElementById('{{ madre_profile_form.foto_madre.id_for_label }}');
      const imagePreview = document.getElementById('image-preview');

      if (fotoInput && imagePreview) {
        fotoInput.addEventListener('change', function(event) {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
              imagePreview.src = e.target.result;
              imagePreview.style.display = 'block';
            }
            reader.readAsDataURL(file);
          }
        });
      }
    });
  </script>
  <!-- Script: Validación de Bogotá y Geografía -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Validación: Solo permitir Bogotá
      const departamentoResidencia = document.getElementById('id_departamento_residencia');
      const form = document.getElementById('madreCreationForm');
      let alertaBogota = null;

      function validarSoloBogota(e) {
        if (!departamentoResidencia) return true;
        const valor = departamentoResidencia.options[departamentoResidencia.selectedIndex].text.toUpperCase();
        const esBogota = valor.includes('BOGOT');
        if (!esBogota) {
          if (!alertaBogota) {
            alertaBogota = document.createElement('div');
            alertaBogota.id = 'alerta-bogota';
            alertaBogota.style = 'margin-top:10px;padding:12px;border-radius:6px;background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;font-size:15px;';
            alertaBogota.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <strong>Solo se permite crear hogares para Bogotá D.C.</strong> Seleccione Bogotá D.C. en el departamento.';
            departamentoResidencia.parentElement.appendChild(alertaBogota);
          }
          if (e) e.preventDefault();
          return false;
        } else {
          if (alertaBogota) alertaBogota.remove();
          alertaBogota = null;
          return true;
        }
      }

      if (form) {
        form.addEventListener('submit', function(e) {
          if (!validarSoloBogota(e)) {
            departamentoResidencia.scrollIntoView({behavior:'smooth', block:'center'});
            departamentoResidencia.focus();
          }
        });
      }
      if (departamentoResidencia) {
        departamentoResidencia.addEventListener('change', function() {
          validarSoloBogota();
        });
      }
    });
  </script>
  
  <!-- 🆕 Script de Geografía de Colombia -->
  <script src="{% static 'js/geografia_colombia.js' %}"></script>
  
  <!-- Script Principal: Toda la lógica consolidada -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('🚀 Inicializando formulario de Madre Comunitaria...');
      
      // ========================================
      // 1️⃣ INICIALIZAR GEOGRAFÍA
      // ========================================
      initGeografiaColombia({
        departamentoSelector: '#id_departamento_residencia',
        municipioSelector: '#id_ciudad_residencia',
        localidadSelector: '#id_localidad_bogota_madre',
        localidadContainer: '#localidad-madre-group'
      });
      
      const deptSelect = document.getElementById('id_departamento_residencia');
      if (deptSelect && deptSelect.value) {
        deptSelect.dispatchEvent(new Event('change'));
      }

      // ========================================
      // 2️⃣ CARGAR BARRIOS POR LOCALIDAD - MADRE
      // ========================================
      const localidadMadreSelect = document.getElementById('id_localidad_bogota_madre');
      const barrioMadreSelect = document.getElementById('id_barrio_madre');
      const barrioMadreGroup = document.getElementById('barrio-madre-group');
      
      if (localidadMadreSelect && barrioMadreSelect) {
        localidadMadreSelect.addEventListener('change', function() {
          const localidadId = this.value;
          
          if (!localidadId) {
            barrioMadreSelect.innerHTML = '<option value="">-- Seleccione un Barrio --</option>';
            barrioMadreSelect.disabled = true;
            if (barrioMadreGroup) barrioMadreGroup.style.display = 'none';
            return;
          }
          
          if (barrioMadreGroup) barrioMadreGroup.style.display = 'block';
          
          fetch(`/api/barrios-por-localidad/${localidadId}/`)
            .then(response => response.ok ? response.json() : Promise.reject('Error al obtener barrios'))
            .then(data => {
              if (data.success && data.barrios.length > 0) {
                barrioMadreSelect.innerHTML = '<option value="">-- Seleccione un Barrio --</option>';
                data.barrios.forEach(barrio => {
                  const option = document.createElement('option');
                  option.value = barrio.nombre;
                  option.textContent = barrio.nombre;
                  barrioMadreSelect.appendChild(option);
                });
                barrioMadreSelect.disabled = false;
              }
            })
            .catch(error => {
              console.error('Error al cargar barrios de madre:', error);
              barrioMadreSelect.disabled = false;
            });
        });
        
        if (localidadMadreSelect.value) {
          localidadMadreSelect.dispatchEvent(new Event('change'));
        }
      }

      // ========================================
      // 3️⃣ CARGAR ARCHIVOS EXISTENTES EN MODO EDICIÓN
      // ========================================
      {% if modo_edicion and madre_profile_form.instance %}
        console.log('Modo edición activado - Cargando archivos existentes...');
        const fileFields = [
          { name: 'foto_madre', url: '{% if madre_profile_form.instance.foto_madre %}{{ madre_profile_form.instance.foto_madre.url }}{% endif %}' },
          { name: 'firma_digital', url: '{% if madre_profile_form.instance.firma_digital %}{{ madre_profile_form.instance.firma_digital.url }}{% endif %}' },
          { name: 'documento_identidad_pdf', url: '{% if madre_profile_form.instance.documento_identidad_pdf %}{{ madre_profile_form.instance.documento_identidad_pdf.url }}{% endif %}' },
          { name: 'certificado_escolaridad_pdf', url: '{% if madre_profile_form.instance.certificado_escolaridad_pdf %}{{ madre_profile_form.instance.certificado_escolaridad_pdf.url }}{% endif %}' },
          { name: 'certificado_antecedentes_pdf', url: '{% if madre_profile_form.instance.certificado_antecedentes_pdf %}{{ madre_profile_form.instance.certificado_antecedentes_pdf.url }}{% endif %}' },
          { name: 'certificado_medico_pdf', url: '{% if madre_profile_form.instance.certificado_medico_pdf %}{{ madre_profile_form.instance.certificado_medico_pdf.url }}{% endif %}' },
          { name: 'certificado_residencia_pdf', url: '{% if madre_profile_form.instance.certificado_residencia_pdf %}{{ madre_profile_form.instance.certificado_residencia_pdf.url }}{% endif %}' },
          { name: 'cartas_recomendacion_pdf', url: '{% if madre_profile_form.instance.cartas_recomendacion_pdf %}{{ madre_profile_form.instance.cartas_recomendacion_pdf.url }}{% endif %}' },
          { name: 'certificado_laboral', url: '{% if madre_profile_form.instance.certificado_laboral %}{{ madre_profile_form.instance.certificado_laboral.url }}{% endif %}' },
          { name: 'carta_disponibilidad', url: '{% if madre_profile_form.instance.carta_disponibilidad %}{{ madre_profile_form.instance.carta_disponibilidad.url }}{% endif %}' },
          { name: 'documento_tenencia_pdf', url: '{% if hogar_form.instance.documento_tenencia_pdf %}{{ hogar_form.instance.documento_tenencia_pdf.url }}{% endif %}' },
          { name: 'fotos_interior', url: '{% if hogar_form.instance.fotos_interior %}{{ hogar_form.instance.fotos_interior.url }}{% endif %}' },
          { name: 'fotos_exterior', url: '{% if hogar_form.instance.fotos_exterior %}{{ hogar_form.instance.fotos_exterior.url }}{% endif %}' }
        ];

        fileFields.forEach(field => {
          if (field.url && field.url.trim() !== '') {
            const existingDiv = document.getElementById('existing-' + field.name);
            if (existingDiv) {
              existingDiv.style.display = 'block';
            } else {
              loadExistingFile(field.name, field.url);
            }
          }
        });
      {% endif %}

      // ========================================
      // 4️⃣ VALIDACIONES EN TIEMPO REAL
      // ========================================
      
      // DOCUMENTO DUPLICADO
      const documentoInput = document.getElementById('id_documento');
      const documentoValidation = document.getElementById('documento-validation');
      const modoEdicion = '{{ modo_edicion|default:"False" }}' === 'True';
      const usuarioId = '{{ usuario_form.instance.id|default:"" }}';
      
      if (documentoInput && documentoValidation) {
        console.log('✅ Inicializando validación de documento');
        let documentoTimeout;
        
        documentoInput.addEventListener('input', function() {
          const documento = this.value.trim();
          clearTimeout(documentoTimeout);
          
          if (documento.length < 6) {
            documentoValidation.style.display = 'none';
            this.style.borderColor = '';
            return;
          }
          
          documentoValidation.style.display = 'block';
          documentoValidation.style.backgroundColor = '#e7f3ff';
          documentoValidation.style.color = '#004085';
          documentoValidation.style.border = '1px solid #bee5eb';
          documentoValidation.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando documento...';
          
          documentoTimeout = setTimeout(() => {
            console.log('🔍 Validando documento:', documento);
            fetch(`/ajax/validar-documento-madre/?documento=${encodeURIComponent(documento)}&usuario_id=${usuarioId}`)
              .then(response => response.json())
              .then(data => {
                console.log('📊 Respuesta:', data);
                if (data.existe) {
                  documentoValidation.style.backgroundColor = '#f8d7da';
                  documentoValidation.style.color = '#721c24';
                  documentoValidation.style.border = '1px solid #f5c6cb';
                  documentoValidation.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <strong>Advertencia:</strong> ${data.mensaje}`;
                  documentoInput.style.borderColor = 'var(--danger)';
                  documentoInput.style.borderWidth = '2px';
                } else {
                  documentoValidation.style.backgroundColor = '#d4edda';
                  documentoValidation.style.color = '#155724';
                  documentoValidation.style.border = '1px solid #c3e6cb';
                  documentoValidation.innerHTML = '<i class="fas fa-check-circle"></i> Documento disponible';
                  documentoInput.style.borderColor = 'var(--success)';
                  documentoInput.style.borderWidth = '2px';
                  
                  setTimeout(() => {
                    documentoValidation.style.display = 'none';
                    documentoInput.style.borderColor = '';
                    documentoInput.style.borderWidth = '';
                  }, 2000);
                }
              })
              .catch(error => {
                console.error('❌ Error al validar documento:', error);
                documentoValidation.style.display = 'none';
              });
          }, 500);
        });
      }
      
      // VALIDACIÓN DE EDAD (20-45 años)
      const fechaNacimientoInput = document.getElementById('id_fecha_nacimiento');
      const edadValidation = document.getElementById('edad-validation');
      let edadValida = true;
      
      if (fechaNacimientoInput && edadValidation) {
        console.log('✅ Inicializando validación de edad');
        fechaNacimientoInput.addEventListener('change', function() {
          const fechaNacimiento = new Date(this.value);
          const hoy = new Date();
          
          if (!this.value) {
            edadValidation.style.display = 'none';
            this.style.borderColor = '';
            edadValida = false;
            return;
          }
          
          let edad = hoy.getFullYear() - fechaNacimiento.getFullYear();
          const mes = hoy.getMonth() - fechaNacimiento.getMonth();
          if (mes < 0 || (mes === 0 && hoy.getDate() < fechaNacimiento.getDate())) {
            edad--;
          }
          
          console.log('👤 Edad calculada:', edad);
          
          if (edad < 20) {
            edadValidation.style.display = 'block';
            edadValidation.style.backgroundColor = '#f8d7da';
            edadValidation.style.color = '#721c24';
            edadValidation.style.border = '2px solid var(--danger)';
            edadValidation.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <strong>Error:</strong> El agente debe tener al menos 20 años. Edad actual: ${edad} años.`;
            this.style.borderColor = 'var(--danger)';
            this.style.borderWidth = '2px';
            edadValida = false;
          } else if (edad > 45) {
            edadValidation.style.display = 'block';
            edadValidation.style.backgroundColor = '#f8d7da';
            edadValidation.style.color = '#721c24';
            edadValidation.style.border = '2px solid var(--danger)';
            edadValidation.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <strong>Error:</strong> El agente no puede tener más de 45 años. Edad actual: ${edad} años.`;
            this.style.borderColor = 'var(--danger)';
            this.style.borderWidth = '2px';
            edadValida = false;
          } else {
            edadValidation.style.display = 'block';
            edadValidation.style.backgroundColor = '#d4edda';
            edadValidation.style.color = '#155724';
            edadValidation.style.border = '2px solid var(--success)';
            edadValidation.innerHTML = `<i class="fas fa-check-circle"></i> Edad válida: ${edad} años (20-45 años)`;
            this.style.borderColor = 'var(--success)';
            this.style.borderWidth = '2px';
            edadValida = true;
            
            setTimeout(() => {
              edadValidation.style.display = 'none';
              fechaNacimientoInput.style.borderColor = '';
              fechaNacimientoInput.style.borderWidth = '';
            }, 3000);
          }
        });
        
        if (fechaNacimientoInput.value) {
          fechaNacimientoInput.dispatchEvent(new Event('change'));
        }
      }
      
      // VALIDACIÓN DE NOMBRE DE HOGAR
      const nombreHogarInput = document.getElementById('id_nombre_hogar');
      const nombreHogarValidation = document.getElementById('nombre-hogar-validation');
      const hogarId = '{{ hogar_form.instance.id|default:"" }}';
      
      if (nombreHogarInput && nombreHogarValidation) {
        console.log('✅ Inicializando validación de nombre hogar');
        let nombreTimeout;
        
        nombreHogarInput.addEventListener('input', function() {
          const nombre = this.value.trim();
          clearTimeout(nombreTimeout);
          
          if (nombre.length < 3) {
            nombreHogarValidation.style.display = 'none';
            this.style.borderColor = '';
            return;
          }
          
          nombreHogarValidation.style.display = 'block';
          nombreHogarValidation.style.backgroundColor = '#e7f3ff';
          nombreHogarValidation.style.color = '#004085';
          nombreHogarValidation.style.border = '1px solid #bee5eb';
          nombreHogarValidation.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando nombre...';
          
          nombreTimeout = setTimeout(() => {
            console.log('🔍 Validando nombre hogar:', nombre);
            fetch(`/ajax/validar-nombre-hogar/?nombre=${encodeURIComponent(nombre)}&hogar_id=${hogarId}`)
              .then(response => response.json())
              .then(data => {
                console.log('📊 Respuesta:', data);
                if (data.existe) {
                  nombreHogarValidation.style.backgroundColor = '#f8d7da';
                  nombreHogarValidation.style.color = '#721c24';
                  nombreHogarValidation.style.border = '1px solid #f5c6cb';
                  nombreHogarValidation.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <strong>Advertencia:</strong> ${data.mensaje}`;
                  nombreHogarInput.style.borderColor = 'var(--danger)';
                  nombreHogarInput.style.borderWidth = '2px';
                } else {
                  nombreHogarValidation.style.backgroundColor = '#d4edda';
                  nombreHogarValidation.style.color = '#155724';
                  nombreHogarValidation.style.border = '1px solid #c3e6cb';
                  nombreHogarValidation.innerHTML = '<i class="fas fa-check-circle"></i> Nombre disponible';
                  nombreHogarInput.style.borderColor = 'var(--success)';
                  nombreHogarInput.style.borderWidth = '2px';
                  
                  setTimeout(() => {
                    nombreHogarValidation.style.display = 'none';
                    nombreHogarInput.style.borderColor = '';
                    nombreHogarInput.style.borderWidth = '';
                  }, 2000);
                }
              })
              .catch(error => {
                console.error('❌ Error al validar nombre hogar:', error);
                nombreHogarValidation.style.display = 'none';
              });
          }, 500);
        });
      }
    });

    // ========================================
    // 📂 FUNCIONES DE ARCHIVO (fuera de DOMContentLoaded)
    // ========================================
    
    function loadExistingFile(fieldName, fileUrl) {
      const previewContainer = document.getElementById('preview-' + fieldName);
      if (!previewContainer) return;

      const previewImage = previewContainer.querySelector('.preview-image');
      const pdfPreview = previewContainer.querySelector('.pdf-preview');
      const pdfIcon = pdfPreview ? pdfPreview.querySelector('.pdf-icon') : null;
      const pdfFrame = pdfPreview ? pdfPreview.querySelector('.pdf-frame') : null;
      const fileName = pdfPreview ? pdfPreview.querySelector('.file-name') : null;

      previewContainer.style.display = 'block';

      const fileExt = fileUrl.split('.').pop().toLowerCase().split('?')[0];
      const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'].includes(fileExt);
      const isPDF = fileExt === 'pdf';

      if (previewImage) previewImage.style.display = 'none';
      if (pdfPreview) pdfPreview.style.display = 'none';
      if (pdfFrame) pdfFrame.style.display = 'none';
      if (pdfIcon) pdfIcon.style.display = 'none';

      if (isImage && previewImage) {
        previewImage.src = fileUrl;
        previewImage.style.display = 'block';
      } else if (isPDF && pdfPreview) {
        pdfPreview.style.display = 'block';
        if (fileName) fileName.textContent = fileUrl.split('/').pop().split('?')[0];
        
        try {
          if (pdfFrame) {
            pdfFrame.src = fileUrl + '#toolbar=0&navpanes=0&scrollbar=0';
            pdfFrame.style.display = 'block';
          }
          if (pdfIcon) pdfIcon.style.display = 'none';
        } catch (e) {
          if (pdfIcon) pdfIcon.style.display = 'block';
          if (pdfFrame) pdfFrame.style.display = 'none';
        }
      }
    }
    
    function previewFile(input, fieldName) {
      const previewContainer = document.getElementById('preview-' + fieldName);
      
      if (!previewContainer) {
        console.error('Preview container not found for field:', fieldName);
        return;
      }
      
      const imageContainer = previewContainer.querySelector('.image-container');
      const previewImage = previewContainer.querySelector('.preview-image');
      const pdfPreview = previewContainer.querySelector('.pdf-preview');
      
      if (!previewImage || !pdfPreview) {
        console.error('Preview elements not found for field:', fieldName);
        return;
      }
      
      const pdfIcon = pdfPreview.querySelector('.pdf-icon');
      const pdfFrame = pdfPreview.querySelector('.pdf-frame');
      const fileName = pdfPreview.querySelector('.file-name');
      
      if (input.files && input.files[0]) {
        const file = input.files[0];
        const fileType = file.type;
        const fileName_text = file.name;
        const fileURL = URL.createObjectURL(file);
        
        console.log('File selected:', fileName_text, 'Type:', fileType);
        
        previewContainer.style.display = 'block';
        
        if (imageContainer) imageContainer.style.display = 'none';
        pdfPreview.style.display = 'none';
        
        if (fileType.startsWith('image/')) {
          console.log('Mostrando imagen...');
          previewImage.src = fileURL;
          if (imageContainer) imageContainer.style.display = 'block';
        } else if (fileType === 'application/pdf') {
          console.log('Mostrando PDF...');
          pdfPreview.style.display = 'block';
          if (fileName) fileName.textContent = fileName_text;
          
          try {
            if (pdfFrame) {
              pdfFrame.src = fileURL;
              pdfFrame.style.display = 'block';
              if (pdfIcon) pdfIcon.style.display = 'none';
            }
          } catch (e) {
            console.log('Error loading PDF in iframe');
            if (pdfIcon) pdfIcon.style.display = 'block';
            if (pdfFrame) pdfFrame.style.display = 'none';
          }
        } else {
          console.log('Tipo de archivo no soportado:', fileType);
          pdfPreview.style.display = 'block';
          if (fileName) fileName.textContent = fileName_text;
          if (pdfIcon) pdfIcon.style.display = 'block';
          if (pdfFrame) pdfFrame.style.display = 'none';
        }
      } else {
        previewContainer.style.display = 'none';
      }
    }
    
    function removeFile(fieldName) {
      const input = document.getElementById('id_' + fieldName);
      const previewContainer = document.getElementById('preview-' + fieldName);
      
      if (input) input.value = '';
      if (previewContainer) {
        previewContainer.style.display = 'none';
        const previewImage = previewContainer.querySelector('.preview-image');
        const pdfFrame = previewContainer.querySelector('.pdf-frame');
        if (previewImage) previewImage.src = '';
        if (pdfFrame) pdfFrame.src = '';
      }
    }
  </script>

  <script>
    // ==================== GESTIÓN DE CONVIVIENTES ====================
    function generarCamposConvivientes(cantidad) {
      const container = document.getElementById('convivientes-container');
      const hiddenInput = document.getElementById('hidden_num_convivientes');
      
      container.innerHTML = ''; // Limpiar campos existentes
      
      // Actualizar campo oculto
      hiddenInput.value = cantidad;
      
      if (cantidad <= 0) {
        return;
      }
      
      for (let i = 0; i < cantidad; i++) {
        const convivienteDiv = document.createElement('div');
        convivienteDiv.className = 'conviviente-card';
        convivienteDiv.style.cssText = 'border:2px solid var(--primary-light);border-radius:8px;padding:20px;margin-bottom:20px;background:#f8f9fa;';
        
        convivienteDiv.innerHTML = `
          <h5 style="color:var(--primary);margin:0 0 15px;font-size:16px;border-bottom:2px solid var(--primary-light);padding-bottom:8px;">
            <i class="fas fa-user"></i> Conviviente ${i + 1}
          </h5>
          
          <!-- Fila 1: Tipo y Número de Documento -->
          <div class="row" style="display:flex;gap:15px;margin-bottom:15px;">
            <div class="form-group" style="flex:1;margin-bottom:0;">
              <label>Tipo de Documento <span class="required-star">*</span></label>
              <select name="conviviente_${i}_tipo_documento" class="form-control conviviente-tipo-doc" data-index="${i}" required>
                <option value="">-- Seleccione --</option>
                <option value="CC">Cédula de Ciudadanía</option>
                <option value="TI">Tarjeta de Identidad</option>
                <option value="CE">Cédula de Extranjería</option>
                <option value="PA">Pasaporte</option>
                <option value="RC">Registro Civil</option>
              </select>
            </div>
            
            <div class="form-group" style="flex:2;margin-bottom:0;">
              <label>Número de Documento <span class="required-star">*</span></label>
              <input type="text" name="conviviente_${i}_numero_documento" class="form-control" 
                     placeholder="Ej: 1234567890" required>
            </div>
          </div>
          
          <!-- Fila 2: Nombre y Parentesco -->
          <div class="row" style="display:flex;gap:15px;margin-bottom:15px;">
            <div class="form-group" style="flex:2;margin-bottom:0;">
              <label>Nombre Completo <span class="required-star">*</span></label>
              <input type="text" name="conviviente_${i}_nombre_completo" class="form-control" 
                     placeholder="Ej: Juan Pérez García" required>
            </div>
            
            <div class="form-group" style="flex:1;margin-bottom:0;">
              <label>Parentesco <span class="required-star">*</span></label>
              <select name="conviviente_${i}_parentesco" class="form-control" required>
                <option value="">-- Seleccione --</option>
                <option value="Cónyuge">Cónyuge</option>
                <option value="Hijo/a">Hijo/a</option>
                <option value="Padre/Madre">Padre/Madre</option>
                <option value="Hermano/a">Hermano/a</option>
                <option value="Abuelo/a">Abuelo/a</option>
                <option value="Tío/a">Tío/a</option>
                <option value="Sobrino/a">Sobrino/a</option>
                <option value="Otro">Otro</option>
              </select>
            </div>
          </div>
          
          <!-- Campo de Antecedentes (solo para mayores de edad) -->
          <div id="conviviente_${i}_antecedentes_container" style="display:none;">
            <div class="form-group">
              <label>
                <i class="fas fa-file-shield"></i> Certificado de Antecedentes <span class="required-star">*</span>
              </label>
              <input type="file" name="conviviente_${i}_antecedentes" 
                     id="conviviente_${i}_antecedentes"
                     accept="application/pdf,image/*"
                     onchange="previewFile(this, 'conviviente_${i}_antecedentes')"
                     class="conviviente-antecedentes">
              <div id="preview-conviviente_${i}_antecedentes" class="file-preview-container" style="display:none;margin-top:15px;padding:15px;background:#e0f5ff;border:2px solid #0369a1;border-radius:8px;">
                <div style="text-align:center;margin-bottom:15px;">
                  <span style="background:#0369a1;color:white;padding:6px 12px;border-radius:4px;font-size:12px;font-weight:600;">✓ Vista Previa</span>
                </div>
                <div class="image-container" style="text-align:center;display:none;margin-bottom:10px;">
                  <img class="preview-image" style="max-width:100%;max-height:300px;border-radius:6px;object-fit:contain;margin:0 auto;display:block;" />
                </div>
                <div class="pdf-preview" style="display:none;background:white;padding:20px;border-radius:6px;">
                  <div class="pdf-icon" style="text-align:center;">
                    <i class="fas fa-file-pdf" style="font-size:48px;color:#ef4444;margin-bottom:10px;"></i>
                    <div class="file-name" style="font-size:12px;color:#666;margin-top:8px;"></div>
                  </div>
                  <iframe class="pdf-frame" style="display:none;width:100%;height:400px;border:none;border-radius:6px;margin-top:10px;"></iframe>
                </div>
                <button type="button" class="remove-file-btn" onclick="removeFile('conviviente_${i}_antecedentes')" style="margin-top:10px;padding:8px 16px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;">✕ Eliminar archivo</button>
              </div>
              <small style="color:#666;display:block;margin-top:5px;">Los mayores de edad deben adjuntar certificado de antecedentes</small>
            </div>
          </div>
        `;
        
        container.appendChild(convivienteDiv);
      }
      
      // Agregar listeners para detectar mayores de edad
      agregarListenersConvivientes();
    }
    
    function agregarListenersConvivientes() {
      const tiposDocumentos = document.querySelectorAll('.conviviente-tipo-doc');
      
      tiposDocumentos.forEach(select => {
        select.addEventListener('change', function() {
          const index = this.getAttribute('data-index');
          const antecedentesContainer = document.getElementById(`conviviente_${index}_antecedentes_container`);
          const antecedentesInput = document.getElementById(`conviviente_${index}_antecedentes`);
          
          // Si es CC, CE o PA = Mayor de edad, requiere antecedentes
          const esMayorEdad = ['CC', 'CE', 'PA'].includes(this.value);
          
          if (esMayorEdad) {
            antecedentesContainer.style.display = 'block';
            if (antecedentesInput) {
              antecedentesInput.setAttribute('required', 'required');
            }
          } else {
            antecedentesContainer.style.display = 'none';
            if (antecedentesInput) {
              antecedentesInput.removeAttribute('required');
              antecedentesInput.value = '';
            }
          }
        });
      });
    }

    // ==================== 💾 PERSISTENCIA DE DATOS DEL FORMULARIO ====================
    // Guardar datos en sessionStorage cada vez que cambian
    // Recuperar datos cuando se carga la página
    
    const STORAGE_KEY = 'form_datos_agente_educativo';
    const STORAGE_FILES_KEY = 'form_archivos_agente_educativo';
    
    // Función para guardar todos los datos del formulario
    function guardarDatosFormulario() {
      const form = document.getElementById('madreCreationForm');
      if (!form) return;
      
      const datos = {
        timestamp: new Date().getTime(),
        campos: {}
      };
      
      // Guardar todos los inputs, selects y textareas
      const inputs = form.querySelectorAll('input[type="text"], input[type="email"], input[type="tel"], input[type="number"], input[type="date"], select, textarea');
      inputs.forEach(input => {
        // No guardar campos de archivo
        if (input.type !== 'file' && input.name && !input.name.includes('conviviente')) {
          datos.campos[input.name] = input.value;
        }
      });
      
      // Guardar en sessionStorage
      try {
        sessionStorage.setItem(STORAGE_KEY, JSON.stringify(datos));
        console.log('✅ Datos del formulario guardados en sessionStorage');
      } catch (e) {
        console.warn('⚠️ No se pudieron guardar los datos:', e);
      }
    }
    
    // Función para recuperar datos del formulario
    function recuperarDatosFormulario() {
      try {
        const datosGuardados = sessionStorage.getItem(STORAGE_KEY);
        if (!datosGuardados) {
          console.log('ℹ️ No hay datos guardados anteriormente');
          return;
        }
        
        const datos = JSON.parse(datosGuardados);
        const form = document.getElementById('madreCreationForm');
        if (!form) return;
        
        console.log('📝 Recuperando datos del formulario...');
        
        // Restaurar valores en los campos
        Object.keys(datos.campos).forEach(nombre => {
          const valor = datos.campos[nombre];
          const input = form.querySelector(`[name="${nombre}"]`);
          
          if (input) {
            input.value = valor;
            
            // Disparar evento change para actualizar dependencias (ej: selects de ciudad)
            const event = new Event('change', { bubbles: true });
            input.dispatchEvent(event);
            
            console.log(`✅ Campo restaurado: ${nombre} = ${valor}`);
          }
        });
        
        console.log('✅ Datos del formulario recuperados');
        
        // Esperar un poco para que se carguen las ciudades si hay una regional seleccionada
        setTimeout(() => {
          recuperarArchivos();
        }, 500);
        
      } catch (e) {
        console.error('❌ Error al recuperar datos:', e);
      }
    }
    
    // Función para guardar archivos en base64
    function guardarArchivos() {
      const form = document.getElementById('madreCreationForm');
      if (!form) return;
      
      const archivos = {};
      const inputsArchivos = form.querySelectorAll('input[type="file"]');
      
      inputsArchivos.forEach(input => {
        if (input.files && input.files[0]) {
          const file = input.files[0];
          const reader = new FileReader();
          
          reader.onload = function(e) {
            archivos[input.name] = {
              nombre: file.name,
              tipo: file.type,
              base64: e.target.result,
              timestamp: new Date().getTime()
            };
            
            // Guardar cada archivo cuando esté listo
            try {
              sessionStorage.setItem(STORAGE_FILES_KEY + '_' + input.name, JSON.stringify(archivos[input.name]));
              console.log(`💾 Archivo guardado: ${input.name}`);
            } catch (e) {
              console.warn(`⚠️ No se pudo guardar el archivo ${input.name}:`, e);
            }
          };
          
          reader.readAsDataURL(file);
        }
      });
    }
    
    // Función para recuperar archivos
    function recuperarArchivos() {
      const form = document.getElementById('madreCreationForm');
      if (!form) return;
      
      const inputsArchivos = form.querySelectorAll('input[type="file"]');
      console.log(`🔍 Buscando ${inputsArchivos.length} campos de archivo...`);
      
      inputsArchivos.forEach(input => {
        const archivoGuardado = sessionStorage.getItem(STORAGE_FILES_KEY + '_' + input.name);
        
        if (archivoGuardado) {
          try {
            const archivo = JSON.parse(archivoGuardado);
            
            // Convertir base64 nuevamente a File
            const byteString = atob(archivo.base64.split(',')[1]);
            const mimeString = archivo.base64.split(',')[0].match(/:(.*?);/)[1];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
              ia[i] = byteString.charCodeAt(i);
            }
            const blob = new Blob([ab], { type: mimeString });
            const nuevoFile = new File([blob], archivo.nombre, { type: archivo.tipo });
            
            // Crear objeto DataTransfer para asignar el archivo
            const dt = new DataTransfer();
            dt.items.add(nuevoFile);
            input.files = dt.files;
            
            // Disparar evento change para mostrar preview
            const event = new Event('change', { bubbles: true });
            input.dispatchEvent(event);
            
            console.log(`✅ Archivo recuperado: ${input.name}`);
          } catch (e) {
            console.warn(`⚠️ Error al recuperar archivo ${input.name}:`, e);
          }
        }
      });
    }
    
    // Inicializar: Recuperar datos al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
      // Recuperar datos guardados
      recuperarDatosFormulario();
      
      // Guardar datos cada vez que cambian (throttled a cada 1 segundo)
      const form = document.getElementById('madreCreationForm');
      if (form) {
        let saveTimeout;
        
        // Guardar cuando cambian inputs
        form.addEventListener('change', function() {
          clearTimeout(saveTimeout);
          saveTimeout = setTimeout(() => {
            guardarDatosFormulario();
            guardarArchivos();
          }, 500);
        });
        
        // Guardar cuando se escribe en textareas e inputs de texto
        form.addEventListener('input', function(e) {
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
              guardarDatosFormulario();
            }, 1000);
          }
        });
        
        // Guardar archivos cuando se seleccionan
        const inputsArchivos = form.querySelectorAll('input[type="file"]');
        inputsArchivos.forEach(input => {
          input.addEventListener('change', function() {
            guardarArchivos();
          });
        });
        
        // Limpiar datos al enviar el formulario
        form.addEventListener('submit', function() {
          console.log('📤 Formulario siendo enviado, limpiando datos guardados...');
          sessionStorage.removeItem(STORAGE_KEY);
          // No limpiar archivos aún, podrían ser necesarios
          console.log('✅ Datos de sesión limpiados');
        });
      }
      
      // Mostrar notificación si hay datos guardados
      const datosGuardados = sessionStorage.getItem(STORAGE_KEY);
      if (datosGuardados) {
        try {
          const datos = JSON.parse(datosGuardados);
          const ahora = new Date().getTime();
          const hace = ahora - datos.timestamp;
          const minutos = Math.floor(hace / 60000);
          
          if (minutos < 60) {
            // Mostrar notificación
            const notificacion = document.createElement('div');
            notificacion.style.cssText = 'background:#4CAF50;color:white;padding:15px 20px;border-radius:8px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 8px rgba(0,0,0,0.2);';
            notificacion.innerHTML = `
              <div style="display:flex;align-items:center;gap:12px;">
                <i class="fas fa-history" style="font-size:20px;"></i>
                <div>
                  <strong>Datos guardados</strong>
                  <br><small>Se encontraron datos de una sesión anterior (hace ${minutos} minuto${minutos !== 1 ? 's' : ''})</small>
                </div>
              </div>
              <button type="button" onclick="this.parentElement.remove()" style="background:none;border:none;color:white;font-size:20px;cursor:pointer;padding:0;">&times;</button>
            `;
            
            const form = document.getElementById('madreCreationForm');
            if (form) {
              form.insertBefore(notificacion, form.firstChild);
            }
          }
        } catch (e) {
          console.warn('⚠️ Error al mostrar notificación:', e);
        }
      }
    });
    
    // Limpiar datos si el usuario sale de la página sin enviar el formulario
    window.addEventListener('beforeunload', function(e) {
      // No limpiar automáticamente, mantener los datos para cuando vuelva
      // console.log('Usuario saliendo de la página');
    });
  </script>
</body>
</html>
